<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Informar Territorio</title>
</head>
<body>

<!-- BOTÓN INFORMAR -->
<button id="btnInformarTerritorio">Informar territorio</button>

<!-- PANTALLA TERRITORIOS -->
<div id="pantallaTerritorios" style="display:none;">
  <h2>Territorios</h2>
  <div id="tarjetas"></div>
</div>

<!-- PANTALLA MANZANAS -->
<div id="pantallaManzanas" style="display:none;">
  <button id="backTerrBtn">⬅ Volver</button>
  <div id="manzanasArea"></div>
  <button id="irFormulario">Continuar</button>
</div>

<!-- PANTALLA FORMULARIO -->
<div id="pantallaFormulario" style="display:none;">
  <button id="backFormBtn">⬅ Volver</button>
  <input id="conductor" placeholder="Conductor">
  <textarea id="observaciones" placeholder="Observaciones"></textarea>
  <button id="sendBtn">Enviar informe</button>
</div>

<hr>

<h3>Reportes enviados</h3>
<div id="reportesList"></div>

<!-- ========================= -->
<!-- SCRIPT FUNCIONAL COMPLETO -->
<!-- ========================= -->
<script type="module">
import { db, ref, push, set, onValue } from "./firebase.js";

const territorios = [
  {numero:1,manzanas:4},{numero:2,manzanas:4},{numero:3,manzanas:4},{numero:4,manzanas:5},
  {numero:5,manzanas:8},{numero:6,manzanas:6},{numero:7,manzanas:6},{numero:8,manzanas:7},
  {numero:9,manzanas:9},{numero:10,manzanas:9},{numero:11,manzanas:5},{numero:12,manzanas:6},
  {numero:13,manzanas:9},{numero:14,manzanas:6},{numero:15,manzanas:5},{numero:16,manzanas:7},
  {numero:17,manzanas:7},{numero:18,manzanas:6},{numero:19,manzanas:6},{numero:20,manzanas:7},
  {numero:21,manzanas:8},{numero:22,manzanas:6},{numero:23,manzanas:6},{numero:24,manzanas:5},
  {numero:25,manzanas:6},{numero:26,manzanas:7},{numero:27,manzanas:7},{numero:28,manzanas:6},
  {numero:29,manzanas:5},{numero:30,manzanas:8},{numero:31,manzanas:8},{numero:32,manzanas:6}
];

const pantallaTerritorios = document.getElementById("pantallaTerritorios");
const pantallaManzanas = document.getElementById("pantallaManzanas");
const pantallaFormulario = document.getElementById("pantallaFormulario");

const tarjetas = document.getElementById("tarjetas");
const manzanasArea = document.getElementById("manzanasArea");
const conductorEl = document.getElementById("conductor");
const obsEl = document.getElementById("observaciones");
const reportesList = document.getElementById("reportesList");

const btnInformar = document.getElementById("btnInformarTerritorio");
const backTerrBtn = document.getElementById("backTerrBtn");
const backFormBtn = document.getElementById("backFormBtn");
const irFormulario = document.getElementById("irFormulario");
const sendBtn = document.getElementById("sendBtn");

let territorioSeleccionado = null;

function ocultarTodo(){
  pantallaTerritorios.style.display = "none";
  pantallaManzanas.style.display = "none";
  pantallaFormulario.style.display = "none";
}

btnInformar.onclick = ()=>{
  ocultarTodo();
  pantallaTerritorios.style.display = "block";
  renderTarjetas();
};

function renderTarjetas(){
  tarjetas.innerHTML = "";
  territorios.forEach(t=>{
    const d = document.createElement("div");
    d.className = "card";
    d.textContent = `Territorio ${t.numero}`;
    d.onclick = ()=>abrirManzanas(t);
    tarjetas.appendChild(d);
  });
}

function abrirManzanas(t){
  territorioSeleccionado = t;
  ocultarTodo();
  pantallaManzanas.style.display = "block";
  manzanasArea.innerHTML = `<h3>Territorio ${t.numero}</h3>`;

  for(let i=0;i<t.manzanas;i++){
    const letra = String.fromCharCode(65+i);
    const m = document.createElement("div");
    m.className = "manzana";
    m.innerHTML = `
      <span>Manzana ${letra}</span>
      <span class="tick" data-letra="${letra}">☐</span>
    `;
    m.onclick = ()=>{
      m.classList.toggle("checked");
      m.querySelector(".tick").textContent = m.classList.contains("checked") ? "✓" : "☐";
    };
    manzanasArea.appendChild(m);
  }
}

backTerrBtn.onclick = ()=>{
  ocultarTodo();
  pantallaTerritorios.style.display = "block";
};

backFormBtn.onclick = ()=>{
  ocultarTodo();
  pantallaManzanas.style.display = "block";
};

irFormulario.onclick = ()=>{
  ocultarTodo();
  pantallaFormulario.style.display = "block";
};

sendBtn.onclick = async ()=>{
  const conductor = conductorEl.value.trim();
  if(!conductor) return alert("Ingrese conductor");

  const hechas = [];
  const pendientes = [];

  document.querySelectorAll(".manzana").forEach(m=>{
    const letra = m.querySelector(".tick").dataset.letra;
    if(m.classList.contains("checked")) hechas.push(letra);
    else pendientes.push(letra);
  });

  const ahora = new Date();

  const reporte = {
    territorio: territorioSeleccionado.numero,
    conductor,
    observaciones: obsEl.value.trim()||"",
    hechas,
    pendientes,
    fecha: ahora.toLocaleDateString(),
    hora: ahora.toLocaleTimeString(),
    ts: ahora.getTime()
  };

  try{
    const rRef = push(ref(db,"reportes"));
    await set(rRef,reporte);

    await set(ref(db,`pendientes/territorio_${territorioSeleccionado.numero}`),{
      territorio: territorioSeleccionado.numero,
      pendientes,
      conductor,
      ts: ahora.getTime()
    });

    alert("✅ Informe guardado");
    location.reload();
  }catch(e){
    console.error(e);
    alert("Error al guardar");
  }
};

onValue(ref(db,"reportes"), snap=>{
  reportesList.innerHTML = "";
  const data = snap.val();
  if(!data){
    reportesList.innerHTML = "<p>No hay reportes</p>";
    return;
  }
  Object.values(data).sort((a,b)=>b.ts-a.ts).forEach(r=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <strong>Territorio ${r.territorio}</strong><br>
      ${r.fecha} ${r.hora}<br>
      <b>${r.conductor}</b><br>
      Hechas: <span style="color:green">${r.hechas.join(", ") || "-"}</span><br>
      Pendientes: <span style="color:red">${r.pendientes.join(", ") || "-"}</span><br>
      Obs: ${r.observaciones || "-"}
    `;
    reportesList.appendChild(card);
  });
});
</script>

</body>
</html>