<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Informar Territorio</title>
<style>
  :root{--verde:#1a4b27;--bg:#f4f4f4}
  body{margin:0;font-family:Arial;background:var(--bg);color:#222}
  header{background:var(--verde);color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700}
  .container{padding:18px;max-width:980px;margin:0 auto}
  .search{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:12px;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .card{background:#fff;padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);text-align:center;font-weight:700;cursor:pointer}
  .manzanas{margin-top:16px}
  .manzana{background:#fff;padding:10px;border-radius:10px;margin-bottom:8px;border:1px solid #ddd;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .manzana.checked{background:#d8f3dc;border-color:#2d6a4f;color:#2d6a4f;font-weight:700}
  .form-area{display:none;margin-top:12px}
  .input-text{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px}
  .footer{display:flex;justify-content:space-between;gap:8px}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .back{background:#fff;color:var(--verde);border:1px solid #ccc}
  .send{background:var(--verde);color:#fff}
  .small-back{position:fixed;left:16px;bottom:18px;background:var(--verde);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
</style>
</head>
<body>

<header>Informar Territorio</header>

<div class="container">
  <input id="search" class="search" placeholder="Buscar territorio por número…" />
  <div id="tarjetas" class="grid"></div>

  <div id="manzanasArea" class="manzanas" style="display:none"></div>

  <div id="formArea" class="form-area">
    <input id="conductor" class="input-text" placeholder="Nombre del hermano (conductor)" />
    <textarea id="observaciones" class="input-text" placeholder="Observaciones..." style="min-height:80px"></textarea>
    <div class="footer">
      <button id="backBtn" class="btn back">⬅ Volver</button>
      <button id="sendBtn" class="btn send">✅ Enviar Informe</button>
    </div>
  </div>

  <hr style="margin:18px 0"/>
  <h3>Reportes recientes</h3>
  <div id="reportesList"></div>
</div>

<button class="small-back" onclick="location.href='index.html'">⬅ Volver</button>

<script type="module">
import { db, ref, push, set, onValue } from "./firebase.js";

/* lista manzanas por territorio según tu detalle */
const territorios = [
  {numero:1,manzanas:4},{numero:2,manzanas:4},{numero:3,manzanas:4},{numero:4,manzanas:5},
  {numero:5,manzanas:8},{numero:6,manzanas:6},{numero:7,manzanas:6},{numero:8,manzanas:7},
  {numero:9,manzanas:9},{numero:10,manzanas:9},{numero:11,manzanas:5},{numero:12,manzanas:6},
  {numero:13,manzanas:9},{numero:14,manzanas:6},{numero:15,manzanas:5},{numero:16,manzanas:7},
  {numero:17,manzanas:7},{numero:18,manzanas:6},{numero:19,manzanas:6},{numero:20,manzanas:7},
  {numero:21,manzanas:8},{numero:22,manzanas:6},{numero:23,manzanas:6},{numero:24,manzanas:5},
  {numero:25,manzanas:6},{numero:26,manzanas:7},{numero:27,manzanas:7},{numero:28,manzanas:6},
  {numero:29,manzanas:5},{numero:30,manzanas:8},{numero:31,manzanas:8},{numero:32,manzanas:6}
];

const tarjetas = document.getElementById('tarjetas');
const search = document.getElementById('search');
const manzanasArea = document.getElementById('manzanasArea');
const formArea = document.getElementById('formArea');
const conductorEl = document.getElementById('conductor');
const obsEl = document.getElementById('observaciones');
const backBtn = document.getElementById('backBtn');
const sendBtn = document.getElementById('sendBtn');
const reportesList = document.getElementById('reportesList');

let territorioSeleccionado = null;

function renderTarjetas(filter=''){
  tarjetas.innerHTML = '';
  territorios.filter(t => t.numero.toString().includes(filter)).forEach(t => {
    const d = document.createElement('div'); d.className='card'; d.textContent=`Territorio ${t.numero}`;
    d.addEventListener('click', ()=>abrirTerritorio(t));
    tarjetas.appendChild(d);
  });
}
renderTarjetas();

search.addEventListener('input', e => renderTarjetas(e.target.value.trim()));

function abrirTerritorio(t){
  territorioSeleccionado = t;
  manzanasArea.innerHTML = `<h3>Territorio ${t.numero}</h3>`;
  for(let i=0;i<t.manzanas;i++){
    const letra = String.fromCharCode(65+i);
    const m = document.createElement('div'); m.className='manzana';
    m.innerHTML = `<span>Manzana ${letra}</span><span class="tick" data-letra="${letra}">☐</span>`;
    m.addEventListener('click', ()=>{ m.classList.toggle('checked'); m.querySelector('.tick').textContent = m.classList.contains('checked') ? '✓' : '☐'; });
    manzanasArea.appendChild(m);
  }
  manzanasArea.style.display = 'block';
  formArea.style.display = 'block';
  window.scrollTo({top:0,behavior:'smooth'});
}

backBtn.addEventListener('click', ()=>{
  manzanasArea.style.display='none'; formArea.style.display='none';
  territorioSeleccionado = null; conductorEl.value=''; obsEl.value='';
});

/* enviar reporte */
sendBtn.addEventListener('click', async ()=>{
  const conductor = conductorEl.value.trim();
  if(!conductor){ alert('Ingrese nombre del conductor.'); return; }
  if(!territorioSeleccionado){ alert('Seleccione un territorio.'); return; }

  const manzanasEls = manzanasArea.querySelectorAll('.manzana');
  const hechas = [], pendientes = [];
  manzanasEls.forEach(m=>{
    const letra = m.querySelector('.tick').dataset.letra;
    if(m.classList.contains('checked')) hechas.push(letra); else pendientes.push(letra);
  });

  const now = new Date();
  const reporte = {
    territorio: territorioSeleccionado.numero,
    conductor,
    observaciones: obsEl.value.trim() || '',
    hechas,
    pendientes,
    fecha: now.toLocaleDateString(),
    hora: now.toLocaleTimeString(),
    ts: now.getTime()
  };

  try{
    const rRef = push(ref(db, 'reportes'));
    await set(rRef, reporte);
    // actualizar pendientes por territorio (para próximas)
    const pendRef = ref(db, `pendientes/territorio_${territorioSeleccionado.numero}`);
    await set(pendRef, { territorio: territorioSeleccionado.numero, pendientes, conductor, ts: now.getTime() });

    alert('✅ Informe guardado en la nube.');
    backBtn.click();
  }catch(err){
    console.error(err); alert('Error guardando informe. Ver consola.');
  }
});

/* escuchar reportes en tiempo real */
onValue(ref(db, 'reportes'), snap=>{
  reportesList.innerHTML = '';
  const val = snap.val();
  if(!val){ reportesList.innerHTML = '<p style="color:#666">No hay reportes aún.</p>'; return; }
  const arr = Object.values(val).sort((a,b)=>b.ts - a.ts);
  arr.forEach(r=>{
    const rc = document.createElement('div'); rc.className='card';
    rc.innerHTML = `<div><strong>Territorio ${r.territorio}</strong> — ${r.fecha} ${r.hora}</div>
                    <div>Conductor: ${r.conductor}</div>
                    <div>Hechas: <span style="color:green;font-weight:700">${(r.hechas||[]).join(", ") || '-'}</span></div>
                    <div>Pendientes: <span style="color:#c1121f;font-weight:700">${(r.pendientes||[]).join(", ") || '-'}</span></div>
                    <div>Obs: ${r.observaciones || '-'}</div>`;
    reportesList.appendChild(rc);
  });
});
</script>
</body>
</html>