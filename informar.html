<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Informar Territorio</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; color:#333; }
  header { background:#1a4b27; color:white; padding:20px; text-align:center; font-size:22px; font-weight:bold; }
  .container { padding:20px; }
  .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:15px; }
  .card { background:white; border-radius:15px; padding:22px 10px; text-align:center; font-size:18px; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.1); cursor:pointer; transition:0.2s; }
  .card:hover { transform:scale(1.05); }
  .manzana { background:white; padding:12px; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; font-weight:bold; cursor:pointer; }
  .manzana.checked { background:#c8f0d4; color:#145825; }
  button { background:#1a4b27; color:white; border:none; padding:12px; width:100%; border-radius:10px; font-size:16px; margin-top:15px; cursor:pointer; }
  button:hover { background:#145825; }
  input, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-top:10px; }
  .small-btn { width:auto; padding:8px 12px; display:inline-block; margin-bottom:12px; }
</style>
</head>
<body>
<header>Informar Territorio</header>

<div class="container">

  <div id="pantallaTerritorios">
    <h3>Seleccione un territorio</h3>
    <div class="grid" id="tarjetas"></div>
  </div>

  <div id="pantallaManzanas" style="display:none;">
    <button id="volverTerr" class="small-btn">⬅ Volver</button>
    <div id="manzanasArea"></div>
    <button id="irFormulario">Continuar</button>
  </div>

  <div id="pantallaFormulario" style="display:none;">
    <button id="volverManz" class="small-btn">⬅ Volver</button>

    <input id="conductor" placeholder="Nombre del conductor" autocomplete="off">

    <!-- Fecha predicación -->
    <input id="fechaPredico" type="date">

    <textarea id="observaciones" placeholder="Observaciones (opcional)"></textarea>
    <button id="enviar">Enviar informe</button>
  </div>

</div>

<script type="module">
import { db, ref, push, set } from "./firebase.js";

// ============================
// TERRITORIOS
// ============================
const territorios = [
  {numero:1,manzanas:4},{numero:2,manzanas:4},{numero:3,manzanas:4},{numero:4,manzanas:5},
  {numero:5,manzanas:8},{numero:6,manzanas:6},{numero:7,manzanas:6},{numero:8,manzanas:7},
  {numero:9,manzanas:9},{numero:10,manzanas:9},{numero:11,manzanas:5},{numero:12,manzanas:6},
  {numero:13,manzanas:9},{numero:14,manzanas:6},{numero:15,manzanas:5},{numero:16,manzanas:7},
  {numero:17,manzanas:7},{numero:18,manzanas:6},{numero:19,manzanas:6},{numero:20,manzanas:7},
  {numero:21,manzanas:8},{numero:22,manzanas:6},{numero:23,manzanas:6},{numero:24,manzanas:5},
  {numero:25,manzanas:6},{numero:26,manzanas:7},{numero:27,manzanas:7},{numero:28,manzanas:6},
  {numero:29,manzanas:5},{numero:30,manzanas:8},{numero:31,manzanas:8},{numero:32,manzanas:6}
];

// ============================
// ELEMENTOS
// ============================
const pt = document.getElementById("pantallaTerritorios");
const pm = document.getElementById("pantallaManzanas");
const pf = document.getElementById("pantallaFormulario");
const tarjetasEl = document.getElementById("tarjetas");
const manzanasArea = document.getElementById("manzanasArea");
const volverTerr = document.getElementById("volverTerr");
const volverManz = document.getElementById("volverManz");
const irFormulario = document.getElementById("irFormulario");
const enviarBtn = document.getElementById("enviar");
const conductorEl = document.getElementById("conductor");
const fechaPredicoEl = document.getElementById("fechaPredico");
const obsEl = document.getElementById("observaciones");

let territorioActual = null;

// ============================
// FECHA POR DEFECTO = HOY
// ============================
const hoy = new Date().toISOString().split("T")[0];
fechaPredicoEl.value = hoy;

// ============================
// FUNCIONES DE NAVEGACIÓN
// ============================
function ocultarTodo(){
  pt.style.display="none";
  pm.style.display="none";
  pf.style.display="none";
}

function renderTarjetas(){
  tarjetasEl.innerHTML="";
  territorios.forEach(t=>{
    const d=document.createElement("div");
    d.className="card";
    d.textContent="Territorio "+t.numero;
    d.onclick=()=>mostrarManzanas(t);
    tarjetasEl.appendChild(d);
  });
}

function mostrarManzanas(t){
  territorioActual = t;
  ocultarTodo();
  pm.style.display="block";
  manzanasArea.innerHTML=`<h3>Territorio ${t.numero}</h3>`;
  for(let i=0;i<t.manzanas;i++){
    const letra=String.fromCharCode(65+i);
    const d=document.createElement("div");
    d.className="manzana";
    d.innerHTML=`Manzana ${letra} <span>☐</span>`;
    d.onclick=()=>{
      d.classList.toggle("checked");
      d.querySelector("span").textContent=d.classList.contains("checked")?"✓":"☐";
    };
    manzanasArea.appendChild(d);
  }
}

volverTerr.onclick=()=>{ ocultarTodo(); pt.style.display="block"; };
volverManz.onclick=()=>{ ocultarTodo(); pm.style.display="block"; };
irFormulario.onclick=()=>{
  if(!territorioActual){ alert("Debe elegir un territorio."); return; }
  ocultarTodo();
  pf.style.display="block";
};

// ============================
// ENVÍO DEL REPORTE
// ============================
enviarBtn.onclick=async ()=>{
  if(!territorioActual){
    alert("Error interno: no hay territorio seleccionado.");
    ocultarTodo(); pt.style.display="block";
    return;
  }

  const conductor = conductorEl.value.trim();
  if(!conductor){ alert("Ingrese el conductor."); return; }

  const fechaPredico = fechaPredicoEl.value;
  if(!fechaPredico){ alert("Ingrese la fecha en que predicó."); return; }

  const hechas=[], pendientes=[];
  document.querySelectorAll(".manzana").forEach(m=>{
    const letra = m.innerText.replace("Manzana","").trim().charAt(0);
    if(m.classList.contains("checked")) hechas.push(letra);
    else pendientes.push(letra);
  });

  const ahora = new Date();
  const reporte = {
    territorio: territorioActual.numero,
    conductor,
    fecha_predicacion: fechaPredico,
    observaciones: obsEl.value.trim(),
    hechas,
    pendientes,
    fecha: ahora.toLocaleDateString(),
    hora: ahora.toLocaleTimeString(),
    ts: ahora.getTime()
  };

  try {
    // Guarda el reporte
    await set(push(ref(db, "reportes")), reporte);

    // Actualiza pendientes
    await set(ref(db, `pendientes/territorio_${reporte.territorio}`), {
      territorio: reporte.territorio,
      pendientes,
      conductor,
      ts: reporte.ts
    });

    // Redirige a reportes
    window.location.href = "reportes.html";
  } catch (err) {
    console.error(err);
    alert("Error al guardar en Firebase. Verifique las reglas de la base.");
  }
};

// Render inicial
renderTarjetas();
</script>
</body>
</html>