<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Informar Territorio</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f4f4;
  color: #333;
}

/* HEADER */
header {
  background: #1a4b27;
  color: white;
  padding: 20px;
  text-align: center;
  font-size: 22px;
  font-weight: bold;
}

/* CONTENEDOR */
.container {
  padding: 20px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

/* TARJETAS TERRITORIO */
.card {
  background: white;
  border-radius: 15px;
  padding: 22px 10px;
  text-align: center;
  font-size: 18px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: 0.2s;
}

.card:hover {
  transform: scale(1.05);
}

/* MANZANAS */
.manzana {
  background: white;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  display: flex;
  justify-content: space-between;
  font-weight: bold;
  cursor: pointer;
}

.manzana.checked {
  background: #c8f0d4;
  color: #145825;
}

/* BOTONES */
button {
  background: #1a4b27;
  color: white;
  border: none;
  padding: 12px;
  width: 100%;
  border-radius: 10px;
  font-size: 16px;
  margin-top: 15px;
  cursor: pointer;
}

button:hover {
  background: #145825;
}

input, textarea {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 10px;
}
</style>
</head>

<body>

<header>Informar Territorio</header>

<div class="container">

<!-- TERRITORIOS -->
<div id="pantallaTerritorios">
  <h3>Seleccione un territorio</h3>
  <div class="grid" id="tarjetas"></div>
</div>

<!-- MANZANAS -->
<div id="pantallaManzanas" style="display:none;">
  <button id="volverTerr">⬅ Volver</button>
  <div id="manzanasArea"></div>
  <button id="irFormulario">Continuar</button>
</div>

<!-- FORMULARIO -->
<div id="pantallaFormulario" style="display:none;">
  <button id="volverManz">⬅ Volver</button>
  <input id="conductor" placeholder="Conductor">
  <textarea id="observaciones" placeholder="Observaciones"></textarea>
  <button id="enviar">Enviar informe</button>
</div>

</div>

<!-- ✅ USAR TU FIREBASE -->
<script type="module" src="firebase.js"></script>

<!-- ===================== -->
<!-- SCRIPT FUNCIONAL -->
<!-- ===================== -->
<script type="module">
import { db, ref, push, set } from "./firebase.js";

/* ========= TERRITORIOS ========= */
const territorios = [
  {numero:1,manzanas:4},{numero:2,manzanas:4},{numero:3,manzanas:4},{numero:4,manzanas:5},
  {numero:5,manzanas:8},{numero:6,manzanas:6},{numero:7,manzanas:6},{numero:8,manzanas:7},
  {numero:9,manzanas:9},{numero:10,manzanas:9},{numero:11,manzanas:5},{numero:12,manzanas:6},
  {numero:13,manzanas:9},{numero:14,manzanas:6},{numero:15,manzanas:5},{numero:16,manzanas:7},
  {numero:17,manzanas:7},{numero:18,manzanas:6},{numero:19,manzanas:6},{numero:20,manzanas:7},
  {numero:21,manzanas:8},{numero:22,manzanas:6},{numero:23,manzanas:6},{numero:24,manzanas:5},
  {numero:25,manzanas:6},{numero:26,manzanas:7},{numero:27,manzanas:7},{numero:28,manzanas:6},
  {numero:29,manzanas:5},{numero:30,manzanas:8},{numero:31,manzanas:8},{numero:32,manzanas:6}
];

/* ========= ELEMENTOS ========= */
const pantallaTerritorios = document.getElementById("pantallaTerritorios");
const pantallaManzanas = document.getElementById("pantallaManzanas");
const pantallaFormulario = document.getElementById("pantallaFormulario");

const tarjetas = document.getElementById("tarjetas");
const manzanasArea = document.getElementById("manzanasArea");

const volverTerr = document.getElementById("volverTerr");
const volverManz = document.getElementById("volverManz");
const irFormulario = document.getElementById("irFormulario");
const enviarBtn = document.getElementById("enviar");

const conductorEl = document.getElementById("conductor");
const obsEl = document.getElementById("observaciones");

let territorioActual = null;

/* ========= FUNCIONES ========= */
function ocultarTodo() {
  pantallaTerritorios.style.display = "none";
  pantallaManzanas.style.display = "none";
  pantallaFormulario.style.display = "none";
}

function pintarTerritorios(){
  tarjetas.innerHTML = "";
  territorios.forEach(t=>{
    const card = document.createElement("div");
    card.className = "card";
    card.textContent = `Territorio ${t.numero}`;
    card.onclick = ()=>mostrarManzanas(t);
    tarjetas.appendChild(card);
  });
}

function mostrarManzanas(t){
  territorioActual = t;
  ocultarTodo();
  pantallaManzanas.style.display = "block";

  manzanasArea.innerHTML = `<h3>Territorio ${t.numero}</h3>`;

  for(let i=0;i<t.manzanas;i++){
    const letra = String.fromCharCode(65+i);
    const div = document.createElement("div");
    div.className = "manzana";
    div.innerHTML = `Manzana ${letra} <span>☐</span>`;
    div.onclick = ()=>{
      div.classList.toggle("checked");
      div.querySelector("span").textContent = div.classList.contains("checked")?"✓":"☐";
    };
    manzanasArea.appendChild(div);
  }
}

/* ========= EVENTOS ========= */
volverTerr.onclick = ()=>{
  ocultarTodo();
  pantallaTerritorios.style.display = "block";
};

volverManz.onclick = ()=>{
  ocultarTodo();
  pantallaManzanas.style.display = "block";
};

irFormulario.onclick = ()=>{
  ocultarTodo();
  pantallaFormulario.style.display = "block";
};

/* ========= GUARDAR ========= */
enviarBtn.onclick = async ()=>{
  const conductor = conductorEl.value.trim();
  if(!conductor){
    alert("Ingrese conductor");
    return;
  }

  const hechas = [];
  const pendientes = [];

  document.querySelectorAll(".manzana").forEach(el=>{
    const letra = el.textContent.replace("Manzana","").trim().charAt(0);
    if(el.classList.contains("checked")) hechas.push(letra);
    else pendientes.push(letra);
  });

  const ahora = new Date();

  const reporte = {
    territorio: territorioActual.numero,
    conductor,
    observaciones: obsEl.value.trim()||"",
    hechas,
    pendientes,
    fecha: ahora.toLocaleDateString(),
    hora: ahora.toLocaleTimeString(),
    ts: ahora.getTime()
  };

  try{
    const rRef = push(ref(db,"reportes"));
    await set(rRef,reporte);

    await set(ref(db,`pendientes/territorio_${territorioActual.numero}`),{
      territorio: territorioActual.numero,
      pendientes,
      conductor,
      ts: ahora.getTime()
    });

    alert("✅ Informe enviado correctamente");
    location.href = "index.html";

  }catch(err){
    console.error(err);
    alert("❌ Error al enviar informe");
  }
};

/* INICIO */
pintarTerritorios();

</script>

</body>
</html>