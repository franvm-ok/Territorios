<script type="module">
import { db, ref, push, set, onValue } from "./firebase.js";

/* lista manzanas por territorio */
const territorios = [
  {numero:1,manzanas:4},{numero:2,manzanas:4},{numero:3,manzanas:4},{numero:4,manzanas:5},
  {numero:5,manzanas:8},{numero:6,manzanas:6},{numero:7,manzanas:6},{numero:8,manzanas:7},
  {numero:9,manzanas:9},{numero:10,manzanas:9},{numero:11,manzanas:5},{numero:12,manzanas:6},
  {numero:13,manzanas:9},{numero:14,manzanas:6},{numero:15,manzanas:5},{numero:16,manzanas:7},
  {numero:17,manzanas:7},{numero:18,manzanas:6},{numero:19,manzanas:6},{numero:20,manzanas:7},
  {numero:21,manzanas:8},{numero:22,manzanas:6},{numero:23,manzanas:6},{numero:24,manzanas:5},
  {numero:25,manzanas:6},{numero:26,manzanas:7},{numero:27,manzanas:7},{numero:28,manzanas:6},
  {numero:29,manzanas:5},{numero:30,manzanas:8},{numero:31,manzanas:8},{numero:32,manzanas:6}
];

/* capturar elementos */
const tarjetas = document.getElementById('tarjetas');
const search = document.getElementById('search');
const pantallaTerritorios = document.getElementById('pantallaTerritorios');
const pantallaManzanas = document.getElementById('pantallaManzanas');
const pantallaFormulario = document.getElementById('pantallaFormulario');

const manzanasArea = document.getElementById('manzanasArea');
const formArea = document.getElementById('formArea');
const conductorEl = document.getElementById('conductor');
const obsEl = document.getElementById('observaciones');
const backTerrBtn = document.getElementById('backTerrBtn');
const backFormBtn = document.getElementById('backFormBtn');
const sendBtn = document.getElementById('sendBtn');
const reportesList = document.getElementById('reportesList');

let territorioSeleccionado = null;

/* Render tarjetas */
function renderTarjetas(filter=''){
  tarjetas.innerHTML = '';
  territorios
    .filter(t => t.numero.toString().includes(filter))
    .forEach(t => {
      const d = document.createElement('div');
      d.className = 'card';
      d.textContent = `Territorio ${t.numero}`;
      d.addEventListener('click', () => abrirManzanas(t));
      tarjetas.appendChild(d);
    });
}
renderTarjetas();

search.addEventListener('input', e => renderTarjetas(e.target.value.trim()));

/* Abrir pantalla de manzanas */
function abrirManzanas(t){
  territorioSeleccionado = t;
  pantallaTerritorios.style.display = 'none';
  pantallaManzanas.style.display = 'block';

  manzanasArea.innerHTML = `<h3>Territorio ${t.numero}</h3>`;

  for(let i=0; i<t.manzanas; i++){
    const letra = String.fromCharCode(65 + i);
    const m = document.createElement('div'); 
    m.className = 'manzana';
    m.innerHTML = `<span>Manzana ${letra}</span><span class="tick" data-letra="${letra}">☐</span>`;
    m.addEventListener('click', ()=>{
      m.classList.toggle('checked');
      m.querySelector('.tick').textContent = m.classList.contains('checked') ? '✓' : '☐';
    });
    manzanasArea.appendChild(m);
  }
}

/* Volver a territorios */
backTerrBtn.addEventListener('click', ()=>{
  pantallaManzanas.style.display = 'none';
  pantallaTerritorios.style.display = 'block';
  territorioSeleccionado = null;
});

/* Pasar al formulario */
document.getElementById('irFormulario').addEventListener('click', ()=>{
  if(!territorioSeleccionado) return alert("Seleccione un territorio.");

  pantallaManzanas.style.display = 'none';
  pantallaFormulario.style.display = 'block';
});

/* Volver desde formulario a manzanas */
backFormBtn.addEventListener('click', ()=>{
  pantallaFormulario.style.display = 'none';
  pantallaManzanas.style.display = 'block';
});

/* Enviar reporte */
sendBtn.addEventListener('click', async ()=>{
  const conductor = conductorEl.value.trim();
  if(!conductor){
    alert('Ingrese el nombre del conductor.');
    return;
  }

  const manzanasEls = manzanasArea.querySelectorAll('.manzana');
  const hechas = [], pendientes = [];

  manzanasEls.forEach(m=>{
    const letra = m.querySelector('.tick').dataset.letra;
    if(m.classList.contains('checked')) hechas.push(letra);
    else pendientes.push(letra);
  });

  const now = new Date();
  const reporte = {
    territorio: territorioSeleccionado.numero,
    conductor,
    observaciones: obsEl.value.trim() || '',
    hechas,
    pendientes,
    fecha: now.toLocaleDateString(),
    hora: now.toLocaleTimeString(),
    ts: now.getTime()
  };

  try{
    const rRef = push(ref(db, 'reportes'));
    await set(rRef, reporte);

    await set(ref(db, `pendientes/territorio_${territorioSeleccionado.numero}`), {
      territorio: territorioSeleccionado.numero,
      pendientes,
      conductor,
      ts: now.getTime()
    });

    alert('✅ Informe guardado correctamente');
    location.reload();

  }catch(err){
    console.error(err);
    alert("Error guardando el informe.");
  }
});

/* Cargar reportes en tiempo real */
onValue(ref(db, 'reportes'), snap=>{
  reportesList.innerHTML = '';
  const val = snap.val();
  if(!val){
    reportesList.innerHTML = '<p style="color:#666">No hay reportes todavía.</p>';
    return;
  }

  const arr = Object.values(val).sort((a,b)=>b.ts - a.ts);

  arr.forEach(r=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <strong>Territorio ${r.territorio}</strong> — ${r.fecha} ${r.hora}<br>
      Conductor: <b>${r.conductor}</b><br>
      Hechas: <span style="color:green;font-weight:700">${r.hechas.join(", ")||'-'}</span><br>
      Pendientes: <span style="color:red;font-weight:700">${r.pendientes.join(", ")||'-'}</span><br>
      Obs: ${r.observaciones || '-'}
    `;
    reportesList.appendChild(card);
  });
});
</script>