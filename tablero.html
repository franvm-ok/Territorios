<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tablero</title>

<style>
:root{--verde:#1a4b27;--bg:#f4f4f4}
body{margin:0;font-family:Arial;background:var(--bg)}
header{background:var(--verde);color:#fff;padding:18px;text-align:center;font-size:22px;font-weight:bold}

.top{display:flex;gap:8px;padding:12px}
select,input[type=file]{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%}
button{background:var(--verde);color:white;border:none;padding:8px 12px;border-radius:8px;font-weight:bold;cursor:pointer}
.container{padding:15px;max-width:980px;margin:auto}

.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.tipo{background:#e8f5e9;color:#1a4b27;padding:4px 8px;border-radius:6px;font-weight:bold;font-size:13px;display:inline-block;margin-bottom:6px}
.nombre{font-weight:bold}
.btns{margin-top:8px}
.btns button{margin-right:6px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center}
.modal-box{background:#fff;width:92%;height:90%;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
.modal-body{flex:1}
iframe,img{width:100%;height:100%;object-fit:contain}
.close{background:#c1121f;margin:8px}

.back{position:fixed;left:15px;bottom:15px}
</style>
</head>

<body>
<header>üìå Tablero General</header>

<div class="top">
  <select id="tipo">
    <option value="">-- Seleccionar tipo --</option>
    <option>Asignaciones Vida Cristiana</option>
    <option>Limpieza del sal√≥n</option>
    <option>Cartas</option>
  </select>
  <input type="file" id="archivo" accept=".pdf,.jpg,.jpeg,.png,.webp">
  <button onclick="subir()">üì§ Subir</button>
</div>

<div class="container" id="lista"></div>
<button class="back" onclick="location.href='index.html'">‚¨Ö Volver</button>

<!-- MODAL -->
<div class="modal" id="visor">
  <div class="modal-box">
    <button onclick="cerrar()" class="close">Cerrar</button>
    <div class="modal-body" id="contenido"></div>
  </div>
</div>

<script type="module">
import { db, ref, push, set, onValue } from "./firebase.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const tipo = document.getElementById("tipo");
const archivo = document.getElementById("archivo");
const lista = document.getElementById("lista");
const visor = document.getElementById("visor");
const cont = document.getElementById("contenido");

const storage = getStorage();

/* SUBIR */
window.subir = async ()=>{

  if(!tipo.value){
    alert("Seleccione tipo");
    return;
  }

  const file = archivo.files[0];
  if(!file){
    alert("Seleccione archivo");
    return;
  }

  try{
    const ruta = `tablero/${Date.now()}_${file.name}`;
    const refS = sRef(storage, ruta);

    await uploadBytes(refS, file);
    const url = await getDownloadURL(refS);

    const refDB = push(ref(db,"tablero"));
    await set(refDB,{
      tipo: tipo.value,
      nombre: file.name,
      url,
      tipoArchivo: file.type,
      ts: Date.now()
    });

    tipo.value="";
    archivo.value="";
    alert("‚úÖ Archivo publicado");

  }catch(e){
    alert("Error al subir archivo");
    console.error(e);
  }
};

/* LISTAR */
onValue(ref(db,"tablero"), snap=>{
  lista.innerHTML="";
  const datos=[];
  snap.forEach(x=>{
    const o = x.val();
    o.id = x.key;
    datos.push(o);
  });

  datos.sort((a,b)=>b.ts-a.ts);

  datos.forEach(d=>{
    const c = document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <div class="tipo">${d.tipo}</div>
      <div class="nombre">${d.nombre}</div>
      <div class="btns">
        <button onclick="ver('${d.url}','${d.tipoArchivo}')">üëÅ Ver</button>
        <button onclick="descargar('${d.url}','${d.nombre}')">‚¨á Descargar</button>
      </div>
    `;
    lista.appendChild(c);
  });
});

/* VER */
window.ver = (url,tipo)=>{
  cont.innerHTML="";
  if(tipo==="application/pdf"){
    cont.innerHTML=`<iframe src="${url}"></iframe>`;
  }else{
    cont.innerHTML=`<img src="${url}">`;
  }
  visor.style.display="flex";
}

window.cerrar = ()=>{
  cont.innerHTML="";
  visor.style.display="none";
}

/* DESCARGA */
window.descargar = (url,nombre)=>{
  const a=document.createElement("a");
  a.href=url;
  a.download=nombre;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
</script>

</body>
</html>