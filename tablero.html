<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tablero de Anuncios</title>

<style>
:root { --verde:#1a4b27; --bg:#f4f4f4 }
body { margin:0;font-family:Arial;background:var(--bg);color:#333 }

header {
  background:var(--verde);
  color:#fff;
  padding:18px;
  text-align:center;
  font-size:22px;
  font-weight:700;
}

.top { display:flex;gap:8px;padding:12px 20px; }
.top select, .top label {
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  cursor:pointer;
}
.add-btn { background:#fff;color:var(--verde);font-weight:bold }

.container { padding:0 20px 90px;max-width:980px;margin:auto }

.seccion { margin-top:20px }
.seccion h2 { margin-bottom:8px;border-bottom:2px solid #1a4b27;padding-bottom:4px }

.card {
  background:#fff;
  border-radius:12px;
  padding:12px;
  margin-bottom:14px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1)
}

.btn-row { display:flex;gap:8px;margin-top:8px }

.btn {
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold
}

.ver {background:#1a4b27;color:white}
.descargar {background:#ddd}

.back-btn {
  position:fixed;
  left:16px;bottom:18px;
  background:var(--verde);
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

/* MODAL */
#visorModal {
  position:fixed;
  top:0;left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

#visorBox {
  background:#fff;
  width:92%;
  height:92%;
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

#visorHeader { padding:8px;background:#eee;text-align:right }

#visorContent { flex:1 }

iframe, img {
  width:100%;
  height:100%;
  object-fit:contain;
}
</style>
</head>
<body>

<header>Tablero de Anuncios</header>

<div class="top" id="panelSubida">

  <select id="categoria">
    <option value="">Seleccionar categorÃ­aâ€¦</option>
    <option>Asignaciones Vida Cristiana</option>
    <option>Limpieza del salÃ³n</option>
    <option>Cartas</option>
  </select>

  <label for="fileInput" class="add-btn">ðŸ“Ž Subir archivo</label>
  <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.webp" hidden>

</div>

<div class="container" id="contenedor"></div>

<button class="back-btn" onclick="location.href='index.html'">â¬… Volver</button>

<!-- MODAL -->
<div id="visorModal" onclick="cerrarVisor()">
  <div id="visorBox" onclick="event.stopPropagation()">
    <div id="visorHeader">
      <button onclick="cerrarVisor()">Cerrar</button>
    </div>
    <div id="visorContent"></div>
  </div>
</div>

<script type="module">
import { db, ref, push, set, onValue, storage, sRef, uploadBytes, getDownloadURL } from "./firebase.js";

const sesion = JSON.parse(localStorage.getItem("sesion") || "null");
const rol = sesion?.rol || "invitado";

const panel = document.getElementById("panelSubida");
const fileInput = document.getElementById("fileInput");
const categoria = document.getElementById("categoria");
const contenedor = document.getElementById("contenedor");

// PERMISOS
if(rol === "invitado") panel.style.display = "none";

// SUBIR
fileInput.addEventListener("change", async () => {

  const cat = categoria.value.trim();
  const file = fileInput.files[0];

  if(!cat) return alert("SeleccionÃ¡ una categorÃ­a");
  if(!file) return;

  try {
    const ruta = `anuncios/${Date.now()}_${file.name}`;
    const archivoRef = sRef(storage, ruta);
    await uploadBytes(archivoRef, file);
    const url = await getDownloadURL(archivoRef);

    const nuevo = push(ref(db,"anuncios"));
    await set(nuevo, {
      categoria: cat,
      nombre: file.name,
      url,
      tipo: file.type,
      fecha: Date.now(),
      autor: sesion?.nombre || rol
    });

    categoria.value = "";
    fileInput.value = "";
    alert("Archivo subido correctamente âœ…");
  } catch(err){
    console.error(err);
    alert("Error al subir el archivo");
  }
});

// MOSTRAR
onValue(ref(db,"anuncios"), snap => {

  const datos = snap.val();
  contenedor.innerHTML = "";

  if(!datos) return;

  const agrupado = {};
  Object.values(datos).forEach(item=>{
    if(!agrupado[item.categoria]) agrupado[item.categoria]=[];
    agrupado[item.categoria].push(item);
  });

  Object.keys(agrupado).forEach(cat=>{

    const sec = document.createElement("div");
    sec.className="seccion";
    sec.innerHTML = `<h2>${cat}</h2>`;

    agrupado[cat].sort((a,b)=>b.fecha - a.fecha).forEach(item=>{
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <b>${item.nombre}</b><br>
        <small>Subido por ${item.autor || ""}</small>
      `;

      const row = document.createElement("div");
      row.className="btn-row";

      const ver = document.createElement("button");
      ver.textContent="Vista previa";
      ver.className="btn ver";
      ver.onclick = ()=>verArchivo(item);

      const down = document.createElement("button");
      down.textContent="Descargar";
      down.className="btn descargar";
      down.onclick = ()=>descargar(item.url,item.nombre);

      row.appendChild(ver);
      row.appendChild(down);
      card.appendChild(row);

      sec.appendChild(card);
    });

    contenedor.appendChild(sec);
  });
});

window.verArchivo = function(item){
  const visor = document.getElementById("visorModal");
  const content = document.getElementById("visorContent");
  content.innerHTML="";

  if(item.tipo==="application/pdf"){
    content.innerHTML=`<iframe src="${item.url}"></iframe>`;
  } else {
    content.innerHTML=`<img src="${item.url}">`;
  }

  visor.style.display="flex";
}

window.cerrarVisor = function(){
  document.getElementById("visorModal").style.display="none";
  document.getElementById("visorContent").innerHTML="";
}

window.descargar = function(url,nombre){
  const a=document.createElement("a");
  a.href=url; a.download=nombre;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
</script>

</body>
</html>