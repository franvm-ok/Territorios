<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tablero de Anuncios</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f4f4f4;
        color: #333;
    }

    header {
        background: #1a4b27;
        padding: 20px;
        text-align: center;
        color: white;
        font-size: 22px;
        font-weight: bold;
        position: relative;
    }

    .add-btn {
        background: #2a7e3d;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        font-weight: bold;
        position: absolute;
        right: 15px;
        bottom: -20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .add-btn:hover {
        background: #256f36;
    }

    .container {
        padding: 80px 20px 20px;
    }

    .file-box {
        background: white;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .file-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .preview-img {
        width: 100%;
        max-height: 260px;
        object-fit: contain;
        border-radius: 10px;
        margin-top: 10px;
    }

    .btn-small {
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        margin-left: 4px;
    }

    .btn-preview {
        background: #1a4b27;
        color: white;
    }

    .btn-download {
        background: #ddd;
    }

    .back-btn {
        position: fixed;
        bottom: 15px;
        left: 15px;
        background: #1a4b27;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        font-weight: bold;
    }

    .verse {
        text-align: center;
        margin-top: 20px;
        font-style: italic;
        color: #555;
    }
</style>
</head>
<body>

<header>
    Tablero de Anuncios
    <button class="add-btn" onclick="document.getElementById('fileInput').click()">Agregar archivo</button>
</header>

<div class="container">

    <input type="file" id="fileInput" style="display:none" accept=".pdf,.jpg,.png,.jpeg,.gif">

    <div id="fileList"></div>

</div>

<button class="back-btn" onclick="location.href='index.html'">‚Üê Volver</button>

<div class="verse">‚ÄúPor eso, sigan consol√°ndose y edific√°ndose unos a otros‚Äù ‚Äî 1 Tes. 5:11</div>

<script type="module">
    import { db, storage } from "./firebase.js";
    import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");

    // Cargar archivos existentes
    async function loadFiles() {
        fileList.innerHTML = "";
        const querySnapshot = await getDocs(collection(db, "anuncios"));

        querySnapshot.forEach(doc => {
            const data = doc.data();
            renderFile(data.url, data.type, data.desc);
        });
    }

    loadFiles();

    // Preguntar si quiere descripci√≥n
    async function askDescription() {
        return new Promise(resolve => {
            const want = confirm("¬øDesea agregar una descripci√≥n?");
            if (!want) return resolve("");
            const desc = prompt("Ingrese la descripci√≥n:");
            resolve(desc || "");
        });
    }

    // Subir archivo
    fileInput.onchange = async () => {
        const file = fileInput.files[0];
        if (!file) return;

        const desc = await askDescription();

        const storageRef = ref(storage, "anuncios/" + Date.now() + "_" + file.name);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        await addDoc(collection(db, "anuncios"), {
            url: url,
            type: file.type,
            desc: desc
        });

        renderFile(url, file.type, desc);

        alert("Archivo subido correctamente.");
    };

    // Mostrar archivo en pantalla
    function renderFile(url, type, desc) {
        const box = document.createElement("div");
        box.className = "file-box";

        let preview = "";
        if (type.includes("image")) {
            preview = `<img src="${url}" class="preview-img">`;
        } else if (type.includes("pdf")) {
            preview = `<div style="font-size:50px;text-align:center;">üìÑ PDF</div>`;
        } else {
            preview = `<div style="font-size:40px;text-align:center;">üìÅ Archivo</div>`;
        }

        box.innerHTML = `
            <div class="file-header">
                <strong>${desc || "Archivo subido"}</strong>
                <div>
                    <button class="btn-small btn-preview" onclick="window.open('${url}', '_blank')">Vista previa</button>
                    <button class="btn-small btn-download" onclick="downloadFile('${url}')">‚¨á</button>
                </div>
            </div>
            ${preview}
        `;

        fileList.prepend(box);
    }

    // Descargar archivo correctamente
    function downloadFile(url) {
        const a = document.createElement("a");
        a.href = url;
        a.download = "archivo";
        a.click();
    }
</script>

</body>
</html>