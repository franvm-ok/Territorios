<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tablero de Anuncios</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f4f4f4;
        color: #333;
    }

    header {
        background: #1a4b27;
        padding: 20px;
        text-align: center;
        color: white;
        font-size: 22px;
        font-weight: bold;
        position: relative;
    }

    .add-btn {
        position: absolute;
        right: 20px;
        bottom: -15px;
        background: #2e7d32;
        color: white;
        padding: 10px 16px;
        border-radius: 10px;
        font-size: 15px;
        border: none;
        cursor: pointer;
        box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .add-btn:hover {
        background: #256628;
    }

    .container {
        margin-top: 40px;
        padding: 15px;
    }

    .card {
        background: white;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    .preview-img {
        width: 100%;
        border-radius: 8px;
        margin-top: 10px;
    }

    .file-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-small {
        background: #1a4b27;
        color: white;
        padding: 6px 10px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        margin-left: 5px;
    }

    .btn-small:hover {
        background: #14541f;
    }

    .back-btn {
        background: #ccc;
        color: #333;
        padding: 10px 15px;
        border-radius: 10px;
        border: none;
        position: fixed;
        bottom: 20px;
        left: 20px;
        font-size: 15px;
        cursor: pointer;
    }

    .back-btn:hover {
        background: #b8b8b8;
    }
</style>
</head>

<body>

<header>
    Tablero de Anuncios
    <button class="add-btn" onclick="document.getElementById('fileInput').click()">Agregar archivo</button>
</header>

<div class="container">

    <input type="file" id="fileInput" style="display:none" onchange="handleFileSelect(event)">

    <div id="anuncios"></div>
</div>

<button class="back-btn" onclick="location.href='index.html'">Volver</button>

<script type="module">
import { db, ref, set, push, onValue } from "./firebase.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

const storage = getStorage();

// üü© Cuando suben un archivo
function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;

    const wantsDescription = confirm("¬øDesea agregar una descripci√≥n?");

    let description = "";

    if (wantsDescription) {
        description = prompt("Ingrese la descripci√≥n:");
        if (!description) description = "";
    }

    uploadFile(file, description);
}

// üü© Subir archivo a Firebase
async function uploadFile(file, description) {

    const fileId = Date.now();
    const storageRef = sRef(storage, "anuncios/" + fileId + "_" + file.name);

    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);

    const anuncioRef = push(ref(db, "anuncios"));
    await set(anuncioRef, {
        url: url,
        name: file.name,
        type: file.type,
        description: description,
        timestamp: fileId
    });

    alert("Archivo subido correctamente");
}

// üü© Mostrar anuncios en pantalla
onValue(ref(db, "anuncios"), (snapshot) => {
    const cont = document.getElementById("anuncios");
    cont.innerHTML = "";

    snapshot.forEach(item => {
        const data = item.val();

        let preview = "";

        // Si es imagen ‚Üí mostrar miniatura
        if (data.type.startsWith("image/")) {
            preview = `<img src="${data.url}" class="preview-img">`;
        }

        // Si es PDF ‚Üí marco de vista previa
        if (data.type === "application/pdf") {
            preview = `
                <iframe src="${data.url}" style="width:100%;height:300px;border-radius:10px;"></iframe>
            `;
        }

        cont.innerHTML += `
            <div class="card">
                <div class="file-row">
                    <strong>${data.name}</strong>
                    <div>
                        <button class="btn-small" onclick="window.open('${data.url}','_blank')">Vista previa</button>
                        <a href="${data.url}" download class="btn-small">‚¨áÔ∏è Descargar</a>
                    </div>
                </div>

                ${data.description ? `<p>${data.description}</p>` : ""}

                ${preview}
            </div>
        `;
    });
});
</script>

</body>
</html>