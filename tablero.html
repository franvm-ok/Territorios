<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tablero de Anuncios</title>
<style>
 :root{--verde:#1a4b27;--bg:#f4f4f4}
 body{margin:0;font-family:Arial;background:var(--bg);color:#333}
 header{background:var(--verde);color:#fff;padding:18px;text-align:center;font-size:22px;font-weight:700}
 .top{display:flex;justify-content:flex-end;padding:12px 20px}
 .add-btn{background:#fff;color:var(--verde);border:1px solid #ddd;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
 .container{padding:0 20px 90px 20px;max-width:980px;margin:0 auto}
 .descripcion{width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;margin:12px 0;font-size:15px}
 .card{background:#fff;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
 .card strong{display:block;margin-bottom:6px}
 .preview-img{width:100%;border-radius:8px;margin-top:8px;object-fit:cover}
 .pdf-frame{width:100%;height:360px;border-radius:8px;border:1px solid #ddd;margin-top:8px}
 .btn-row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
 .btn-mini{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
 .ver-btn{background:#1a4b27;color:#fff}
 .down-btn{background:#ddd;color:#000}
 .back-btn{position:fixed;left:16px;bottom:18px;background:var(--verde);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
 /* modal */
 #visorModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.72);display:none;justify-content:center;align-items:center;padding:20px;z-index:9999}
 #visorBox{background:#fff;width:92%;height:92%;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
 #visorHeader{display:flex;justify-content:flex-end;padding:8px;background:#f6f6f6}
 #visorClose{background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
 #visorContent{flex:1;display:flex;align-items:center;justify-content:center;padding:8px}
 iframe.viewer{width:100%;height:100%;border:0}
 img.viewer{max-width:100%;max-height:100%;object-fit:contain}
</style>
</head>
<body>
<header>Tablero de Anuncios</header>

<div class="top">
  <label class="add-btn" for="fileInput">ðŸ“Ž Agregar archivo</label>
</div>

<div class="container">
  <input id="fileInput" type="file" accept=".pdf,.png,.jpg,.jpeg,.webp" style="display:none">
  <input id="descripcion" class="descripcion" placeholder="DescripciÃ³n (opcional)">
  <div id="lista"></div>
</div>

<button class="back-btn" onclick="location.href='index.html'">â¬… Volver</button>

<!-- modal -->
<div id="visorModal">
  <div id="visorBox">
    <div id="visorHeader"><button id="visorClose">Cerrar</button></div>
    <div id="visorContent"></div>
  </div>
</div>

<script type="module">
import { db, ref, push, set, onValue, storage, sRef, uploadBytes, getDownloadURL, listAll } from "./firebase.js";

const fileInput = document.getElementById('fileInput');
const descripcionInput = document.getElementById('descripcion');
const lista = document.getElementById('lista');
const visorModal = document.getElementById('visorModal');
const visorContent = document.getElementById('visorContent');
const visorClose = document.getElementById('visorClose');

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if(!file) return;

  let descripcion = descripcionInput.value.trim();
  if(!descripcion){
    const quiere = confirm("Â¿Desea agregar una descripciÃ³n?");
    if(quiere){
      const texto = prompt("Ingrese la descripciÃ³n:");
      descripcion = (texto||"").trim();
    }
  }

  try{
    const ruta = `anuncios/${Date.now()}_${file.name}`;
    const sref = sRef(storage, ruta);
    await uploadBytes(sref, file);
    const url = await getDownloadURL(sref);

    const newRef = push(ref(db, 'anuncios'));
    await set(newRef, {
      name: file.name,
      type: file.type,
      description: descripcion || '',
      url,
      ts: Date.now()
    });

    descripcionInput.value = '';
    fileInput.value = '';
  } catch(err){
    console.error(err);
    alert('Error subiendo archivo. MirÃ¡ consola.');
  }
});

/* render en tiempo real */
onValue(ref(db, 'anuncios'), snapshot => {
  const val = snapshot.val();
  lista.innerHTML = '';
  if(!val) return;
  const items = Object.entries(val).map(([k,v])=>({id:k,...v}));
  items.sort((a,b)=>b.ts - a.ts);
  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<strong>${item.name}</strong>
                      <div style="margin-top:6px">${item.description||''}</div>`;
    const btnRow = document.createElement('div'); btnRow.className = 'btn-row';

    const ver = document.createElement('button'); ver.className='btn-mini ver-btn'; ver.textContent='ðŸ‘ï¸ Vista previa';
    ver.onclick = () => openPreview(item);
    const down = document.createElement('button'); down.className='btn-mini down-btn'; down.textContent='â¬‡ Descargar';
    down.onclick = () => downloadFile(item.url, item.name);

    btnRow.appendChild(ver); btnRow.appendChild(down);
    card.appendChild(btnRow);

    if(item.type && item.type.startsWith('image/')){
      const img = document.createElement('img'); img.className='preview-img'; img.src=item.url; img.alt=item.name;
      img.style.cursor='pointer'; img.onclick = () => openPreview(item);
      card.appendChild(img);
    } else if(item.type === 'application/pdf'){
      const note = document.createElement('div'); note.style.marginTop='8px'; note.textContent='PDF â€” usar Vista previa';
      card.appendChild(note);
    } else {
      const note = document.createElement('div'); note.style.marginTop='8px'; note.textContent='Archivo â€” usar Vista previa o Descargar';
      card.appendChild(note);
    }

    lista.appendChild(card);
  });
});

function openPreview(item){
  visorContent.innerHTML = '';
  if(item.type === 'application/pdf'){
    const frame = document.createElement('iframe'); frame.className='viewer'; frame.src = item.url;
    visorContent.appendChild(frame);
  } else if(item.type && item.type.startsWith('image/')){
    const img = document.createElement('img'); img.className='viewer'; img.src = item.url;
    visorContent.appendChild(img);
  } else {
    window.open(item.url, '_blank');
    return;
  }
  visorModal.style.display = 'flex';
}
visorClose.onclick = ()=>{ visorModal.style.display='none'; visorContent.innerHTML=''; }

function downloadFile(url, name){
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
</script>
</body>
</html>