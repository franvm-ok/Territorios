<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pendientes - Admin</title>
<style>
:root{--verde:#1a4b27;--bg:#f4f4f4}
body{margin:0;font-family:Arial;background:var(--bg)}
header{background:var(--verde);color:#fff;text-align:center;font-weight:bold;padding:18px}
.container{max-width:900px;margin:auto;padding:15px}

/* TARJETAS */
.card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);margin-bottom:10px}
.pendiente{border-left:6px solid orange}
.pend{color:#c1121f;font-weight:bold}
.etiqueta{background:#ffe095;padding:3px 6px;border-radius:6px;font-size:12px;margin-right:6px}

/* ADMIN */
.admin input,.admin textarea{width:100%;margin-bottom:6px;padding:6px;border-radius:6px;border:1px solid #ccc}
button{background:var(--verde);color:white;border:none;padding:6px 10px;border-radius:8px;font-weight:bold;cursor:pointer}
button:disabled{background:gray;cursor:not-allowed}

.back{position:fixed;left:15px;bottom:15px}
</style>
</head>

<body>
<header>üìù Pendientes - Asignar</header>
<div class="container" id="lista"></div>
<button class="back" onclick="location.href='index.html'">‚¨Ö Volver</button>

<script type="module">
import { db, ref, onValue, push, remove } from "./firebase.js";

const lista = document.getElementById("lista");
const pendientesRef = ref(db,"pendientes");
const salidasRef    = ref(db,"salidas_asignadas");

const rol = (localStorage.getItem("rol") || "").toLowerCase().trim();
if(rol !== "admin"){
  location.href = "index.html";
}

let pendientes = [];

/* RENDER */
function render(){
  lista.innerHTML = "";

  if(pendientes.length === 0){
    lista.innerHTML = "<p style='text-align:center;color:#777'>No hay pendientes</p>";
    return;
  }

  pendientes.forEach(p=>{
    const card = document.createElement("div");
    card.className="card pendiente";
    card.innerHTML = `
      <span class="etiqueta">PENDIENTE</span>
      <b>Territorio ${p.territorio||"-"}</b>
      <div>üß± Faltan: <span class="pend">${(p.pendientes||[]).join(", ")}</span></div>
      <div>üë§ √öltimo: ${p.conductor||"-"}</div>
    `;

    const box=document.createElement("div");
    box.className="admin";
    box.innerHTML=`
      <input id="c${p.id}" placeholder="Conductor">
      <input type="date" id="f${p.id}">
      <input id="calles${p.id}" placeholder="Calle">
      <input id="inter${p.id}" placeholder="Intersecci√≥n">
      <textarea id="o${p.id}" placeholder="Observaci√≥n"></textarea>
      <button id="btn${p.id}">‚úÖ Asignar</button>
    `;

    card.appendChild(box);
    lista.appendChild(card);

    // EVENTO ASIGNAR
    document.getElementById("btn"+p.id).onclick = async ()=>{

      const btn = document.getElementById("btn"+p.id);
      btn.disabled = true;
      btn.textContent = "Enviando...";

      const c = document.getElementById("c"+p.id).value.trim();
      const f = document.getElementById("f"+p.id).value;
      const calle = document.getElementById("calles"+p.id).value.trim();
      const inter = document.getElementById("inter"+p.id).value.trim();
      const o = document.getElementById("o"+p.id).value;

      if(!c || !f || !calle || !inter){
        alert("Faltan datos");
        btn.disabled = false;
        btn.textContent = "‚úÖ Asignar";
        return;
      }

      try{
        // GUARDAR EN PR√ìXIMAS
        await push(salidasRef,{
          territorio: p.territorio,
          pendientes: p.pendientes,
          conductor: c,
          fecha: f,
          calle: calle,
          interseccion: inter,
          observaciones: o,
          creado: Date.now()
        });

        // BORRAR DE PENDIENTES
        await remove(ref(db,"pendientes/"+p.id));

        // REDIRECCI√ìN FORZADA
        window.location.href = "proximas.html";

      }catch(e){
        alert("Error al asignar");
        console.error(e);
        btn.disabled = false;
        btn.textContent = "‚úÖ Asignar";
      }
    };
  });
}

/* FIREBASE */
onValue(pendientesRef, snap=>{
  pendientes = [];
  snap.forEach(x=>{
    const o = x.val();
    o.id = x.key;
    pendientes.push(o);
  });
  render();
});
</script>

</body>
</html>