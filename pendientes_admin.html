<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pendientes - Admin</title>

<style>
  :root{
    --verde:#1a4b27;
    --bg:#f4f4f4;
    --card:#ffffff;
    --muted:#666;
    --danger:#b91c1c;
    --ok:#2d8a3e;
    --focus: #ffdb4d;
    --font-size:18px;
  }

  html,body{height:100%}
  body{
    margin:0;
    font-family: Arial, Helvetica, sans-serif;
    background:var(--bg);
    font-size:var(--font-size);
    color:#222;
  }

  header{
    background:var(--verde);
    color:white;
    padding:16px 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  header h1{margin:0;font-size:20px;font-weight:700}
  /* Bot√≥n nueva salida */
  #btnNueva{
    background:white;
    color:var(--verde);
    border:none;
    padding:10px 14px;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
    font-size:16px;
  }

  .wrap{
    max-width:980px;
    margin:18px auto;
    padding:10px;
  }

  #lista{display:grid;grid-template-columns:1fr;gap:12px;padding:6px}

  .card{
    background:var(--card);
    padding:14px;
    border-radius:12px;
    box-shadow:0 3px 8px rgba(0,0,0,0.08);
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .card.row{flex-direction:row;align-items:center;justify-content:space-between;gap:6px}
  .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center}

  .etiqueta{
    display:inline-block;
    padding:6px 10px;
    font-size:14px;
    border-radius:8px;
    background:#eee;
    color:#333;
    font-weight:700;
  }

  .pendiente{border-left:6px solid #d9534f}
  .completado{border-left:6px solid var(--ok)}

  .info b{font-size:16px}
  .info div{color:var(--muted);font-size:15px}

  .admin{
    margin-top:6px;
    border-top:1px dashed #ddd;
    padding-top:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  label{font-weight:700;font-size:15px;color:#333}
  input[type="text"], input[type="date"], input[type="time"], textarea{
    padding:10px 12px;
    border-radius:8px;
    border:1px solid #bbb;
    font-size:16px;
    width:100%;
    box-sizing:border-box;
  }
  textarea{min-height:70px;resize:vertical}

  .row-flex{display:flex;gap:8px}
  .row-flex > *{flex:1}

  .btn{
    padding:10px 14px;
    border-radius:8px;
    border:none;
    background:var(--verde);
    color:white;
    font-weight:700;
    font-size:16px;
    cursor:pointer;
  }
  .btn.small{padding:8px 10px;font-size:15px}
  .btn.warn{background:var(--danger)}
  .btn.ghost{background:transparent;color:var(--verde);border:1px solid #eee;box-shadow:none}
  .btn.delete{background:#7a1f1f}
  .btn.secondary{background:#3b7a55}

  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:14px}

  /* EDIT FORM dentro de cada card (oculto por defecto) */
  .edit-area{display:none;gap:8px;flex-direction:column;margin-top:6px}

  /* MODAL */
  #modal{
    position:fixed;inset:0;
    display:none;
    align-items:center;justify-content:center;
    background:rgba(0,0,0,0.45);
    padding:20px;
    z-index:9999;
  }
  #modalContent{
    background:white;
    width:100%;
    max-width:520px;
    border-radius:12px;
    padding:18px;
    box-shadow:0 8px 30px rgba(0,0,0,0.25);
  }
  #modalContent h3{margin:0 0 10px 0;text-align:center;font-size:20px}
  #modalContent .field{margin-bottom:8px}
  #modalContent .actions{display:flex;gap:8px;justify-content:center;margin-top:10px}

  /* RESPONSIVE */
  @media (max-width:600px){
    .row-flex{flex-direction:column}
    header h1{font-size:18px}
    #btnNueva{padding:8px 10px;font-size:15px}
  }

  /* FOCUS accessibility */
  input:focus, textarea:focus, button:focus{
    outline:3px solid var(--focus);
    outline-offset:3px;
  }

</style>
</head>
<body>

<header>
  <h1>Pendientes - Admin</h1>
  <button id="btnNueva" aria-label="Nueva salida">+ Nueva salida</button>
</header>

<div class="wrap">
  <div id="lista">Cargando...</div>
</div>

<!-- MODAL NUEVA SALIDA -->
<div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div id="modalContent">
    <h3 id="modalTitle">Crear nueva salida</h3>

    <div class="field">
      <label for="n_territorio">Territorio</label>
      <input id="n_territorio" type="text" placeholder="Ej: 12A (ej. '12A')">
    </div>

    <div class="field">
      <label for="n_manzanas">Manzanas (separadas por comas)</label>
      <input id="n_manzanas" type="text" placeholder="Ej: 1, 2, 3">
      <div class="muted">Escribe las manzanas que faltan o que ser√°n recorridas.</div>
    </div>

    <div class="field">
      <label for="n_conductor">Conductor</label>
      <input id="n_conductor" type="text" placeholder="Nombre del conductor">
    </div>

    <div class="row-flex">
      <div>
        <label for="n_fecha">Fecha</label>
        <input id="n_fecha" type="date">
      </div>
      <div>
        <label for="n_hora">Hora</label>
        <input id="n_hora" type="time">
      </div>
    </div>

    <div class="field">
      <label for="n_calle">Calle</label>
      <input id="n_calle" type="text" placeholder="Calle principal">
    </div>

    <div class="field">
      <label for="n_inter">Intersecci√≥n</label>
      <input id="n_inter" type="text" placeholder="Calle de intersecci√≥n">
    </div>

    <div class="field">
      <label for="n_obs">Observaciones</label>
      <textarea id="n_obs" placeholder="Notas, indicaciones, etc."></textarea>
    </div>

    <div class="actions">
      <button id="guardarNueva" class="btn">Crear salida</button>
      <button id="cerrarModal" class="btn small btn.ghost" style="background:#eee;color:#333">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
import { db, ref as dbRef, onValue, push, remove, update } from "./firebase.js";

/* ============================
   ELEMENTOS
============================ */
const lista = document.getElementById("lista");
const pendientesRef = dbRef(db,"pendientes");
const salidasRef = dbRef(db,"salidas_asignadas");

const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
const rol = (sesion.rol || "invitado").toLowerCase();
if (rol !== "admin") location.href="index.html";

/* MODAL */
const modal = document.getElementById("modal");
const btnNueva = document.getElementById("btnNueva");
const cerrarModal = document.getElementById("cerrarModal");
const guardarNueva = document.getElementById("guardarNueva");

/* INPUTS MODAL */
const n_territorio = document.getElementById("n_territorio");
const n_manzanas = document.getElementById("n_manzanas");
const n_conductor = document.getElementById("n_conductor");
const n_fecha = document.getElementById("n_fecha");
const n_hora = document.getElementById("n_hora");
const n_calle = document.getElementById("n_calle");
const n_inter = document.getElementById("n_inter");
const n_obs = document.getElementById("n_obs");

/* ============================
   UTILIDADES
============================ */
function hoy(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}
function horaAhora(){
  const d=new Date();
  d.setSeconds(0);
  d.setMilliseconds(0);
  return d.toTimeString().slice(0,5);
}
function limpiaModal(){
  n_territorio.value = "";
  n_manzanas.value = "";
  n_conductor.value = "";
  n_fecha.value = hoy();
  n_hora.value = horaAhora();
  n_calle.value = "";
  n_inter.value = "";
  n_obs.value = "";
}

/* abrir modal */
btnNueva.onclick = () => {
  limpiaModal();
  modal.style.display = "flex";
  // foco en primer campo para accesibilidad
  setTimeout(()=>n_territorio.focus(),100);
};
cerrarModal.onclick = ()=> modal.style.display = "none";

/* ESC para cerrar modal */
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") modal.style.display = "none";
});

/* ============================
   CREAR NUEVA SALIDA
============================ */
guardarNueva.onclick = async ()=>{
  const territorio = n_territorio.value.trim();
  const manzanas = n_manzanas.value.trim();
  const conductor = n_conductor.value.trim();
  const fecha = n_fecha.value;
  const hora = n_hora.value;
  const calle = n_calle.value.trim();
  const inter = n_inter.value.trim();
  const obs = n_obs.value.trim();

  if(!territorio || !manzanas || !conductor || !fecha || !hora || !calle || !inter){
    alert("Completa todos los campos obligatorios.");
    return;
  }

  // push a salidas_asignadas
  await push(salidasRef,{
    territorio,
    pendientes: manzanas.split(",").map(x=>x.trim()).filter(Boolean),
    conductor,
    fecha,
    hora,
    calle,
    interseccion: inter,
    observaciones: obs,
    creado: Date.now()
  });

  alert("Salida creada correctamente.");
  modal.style.display = "none";
  location.replace("proximas.html");
};

/* ============================
   RENDER PENDIENTES (con editar/eliminar)
============================ */
let pendientes = [];

function render(){
  lista.innerHTML = "";

  if(!pendientes || pendientes.length === 0){
    lista.innerHTML = `<div class="card"><div class="info"><b>No hay pendientes</b><div class="muted">Cuando aparezcan pendientes se ver√°n ac√°.</div></div></div>`;
    return;
  }

  pendientes.forEach(p=>{
    const tiene = Array.isArray(p.pendientes) && p.pendientes.length>0;
    const card = document.createElement("div");
    card.className = "card " + (tiene ? "pendiente" : "completado");

    card.innerHTML = `
      <div class="row-flex" style="align-items:center;justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center;flex:1;min-width:0">
          <span class="etiqueta">${tiene ? "PENDIENTE" : "COMPLETADO"}</span>
          <div class="info" style="min-width:0">
            <div><b>Territorio ${p.territorio}</b></div>
            <div class="muted">üß± Faltan: <b>${(p.pendientes||[]).join(", ") || "Ninguna"}</b></div>
            <div class="muted">üë§ √öltimo conductor: ${p.conductor || "‚Äî"}</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn small assign" data-id="${p.id}">‚úÖ Asignar</button>
          <button class="btn small secondary edit" data-id="${p.id}">‚úé Editar</button>
          <button class="btn small delete" data-id="${p.id}">üóëÔ∏è Eliminar</button>
        </div>
      </div>

      <div class="edit-area" id="edit-${p.id}">
        <div class="field">
          <label for="e_territorio_${p.id}">Territorio</label>
          <input id="e_territorio_${p.id}" type="text" value="${escapeHtml(p.territorio || "")}">
        </div>

        <div class="field">
          <label for="e_manzanas_${p.id}">Manzanas</label>
          <input id="e_manzanas_${p.id}" type="text" value="${escapeHtml((p.pendientes||[]).join(", "))}">
        </div>

        <div class="field">
          <label for="e_conductor_${p.id}">√öltimo conductor</label>
          <input id="e_conductor_${p.id}" type="text" value="${escapeHtml(p.conductor || "")}">
        </div>

        <div class="field">
          <label for="e_obs_${p.id}">Observaciones</label>
          <textarea id="e_obs_${p.id}">${escapeHtml(p.observaciones || "")}</textarea>
        </div>

        <div class="controls">
          <button class="btn small save-edit" data-id="${p.id}">üíæ Guardar cambios</button>
          <button class="btn small ghost cancel-edit" data-id="${p.id}" style="background:#eee;color:#333">Cancelar</button>
          <button class="btn small warn push-to-salida" data-id="${p.id}">‚û° Asignar como salida</button>
        </div>
      </div>
    `;

    lista.appendChild(card);
  });

  // EVENTOS: Asignar (bot√≥n arriba)
  document.querySelectorAll(".assign").forEach(btn=>{
    btn.onclick = (e)=>{
      const id = btn.dataset.id;
      toggleEdit(id, true); // abrir edit mode para asignar
      // focus conductor input
      const fld = document.getElementById(`e_conductor_${id}`);
      if(fld) fld.focus();
    };
  });

  // EVENTOS: Editar (abre/oculta el panel de edici√≥n)
  document.querySelectorAll(".edit").forEach(btn=>{
    btn.onclick = (e)=>{
      const id = btn.dataset.id;
      toggleEdit(id);
    };
  });

  // EVENTOS: Cancelar edici√≥n
  document.querySelectorAll(".cancel-edit").forEach(btn=>{
    btn.onclick = (e)=>{
      const id = btn.dataset.id;
      toggleEdit(id,false);
    };
  });

  // GUARDAR EDICI√ìN del pendiente (actualiza pendiente en Firebase)
  document.querySelectorAll(".save-edit").forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = btn.dataset.id;
      const territorio = document.getElementById(`e_territorio_${id}`).value.trim();
      const manzanas = document.getElementById(`e_manzanas_${id}`).value.trim();
      const conductor = document.getElementById(`e_conductor_${id}`).value.trim();
      const obs = document.getElementById(`e_obs_${id}`).value.trim();

      if(!territorio){
        alert("Territorio no puede quedar vac√≠o.");
        return;
      }

      // Actualizo pendiente
      await update(dbRef(db, `pendientes/${id}`), {
        territorio,
        pendientes: manzanas.split(",").map(x=>x.trim()).filter(Boolean),
        conductor,
        observaciones: obs || ""
      });

      alert("Pendiente actualizado.");
      toggleEdit(id,false);
    };
  });

  // Eliminar pendiente
  document.querySelectorAll(".delete").forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = btn.dataset.id;
      if(!confirm("¬øEliminar este pendiente? Esta acci√≥n no se puede deshacer.")) return;
      await remove(dbRef(db, `pendientes/${id}`));
      alert("Pendiente eliminado.");
    };
  });

  // Asignar como salida (desde el panel de edici√≥n)
  document.querySelectorAll(".push-to-salida").forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = btn.dataset.id;
      const territorio = document.getElementById(`e_territorio_${id}`).value.trim();
      const manzanas = document.getElementById(`e_manzanas_${id}`).value.trim();
      const conductor = document.getElementById(`e_conductor_${id}`).value.trim();
      const obs = document.getElementById(`e_obs_${id}`).value.trim();

      // Pedimos fecha y hora con prompt simple y grande (para evitar romper dise√±o).
      let fecha = prompt("Fecha de la salida (AAAA-MM-DD)", hoy());
      if(!fecha) return;
      let hora = prompt("Hora (HH:MM)", horaAhora());
      if(!hora) return;
      // Validaci√≥n m√≠nima
      if(!territorio || !manzanas || !conductor || !fecha || !hora){
        alert("Completa territorio, manzanas, conductor, fecha y hora.");
        return;
      }

      await push(salidasRef, {
        territorio,
        pendientes: manzanas.split(",").map(x=>x.trim()).filter(Boolean),
        conductor,
        fecha,
        hora,
        calle: "", // opcional, admin puede editar luego en pr√≥ximas
        interseccion: "",
        observaciones: obs || "",
        creado: Date.now()
      });

      // elimino pendiente
      await remove(dbRef(db, `pendientes/${id}`));
      alert("Pendiente convertido a salida y eliminado de la lista.");
      // redirigir a pr√≥ximas
      location.replace("proximas.html");
    };
  });

}

/* toggleEdit muestra/oculta el √°rea de edici√≥n por id */
function toggleEdit(id, forceOpen = null){
  const area = document.getElementById(`edit-${id}`);
  if(!area) return;
  if(forceOpen === true) area.style.display = "flex";
  else if(forceOpen === false) area.style.display = "none";
  else area.style.display = (area.style.display === "flex") ? "none" : "flex";
}

/* escape para valor dentro de value/textarea */
function escapeHtml(str){
  if(!str) return "";
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

/* ESCUCHAR FIREBASE */
onValue(pendientesRef, s=>{
  pendientes = [];
  s.forEach(x=>{
    let o = x.val();
    o.id = x.key;
    if(!Array.isArray(o.pendientes)) o.pendientes = [];
    pendientes.push(o);
  });

  // opcional: ordenar por territorio
  pendientes.sort((a,b)=> (a.territorio||"").toString().localeCompare((b.territorio||"").toString(), undefined, {numeric:true}));

  render();
});

</script>

</body>
</html>