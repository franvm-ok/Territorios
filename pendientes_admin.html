<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pendientes - Admin</title>
<style>
:root{--verde:#1a4b27;--bg:#f4f4f4}
body{margin:0;font-family:Arial;background:var(--bg)}
header{background:var(--verde);color:#fff;text-align:center;font-weight:bold;padding:18px}
.container{max-width:900px;margin:auto;padding:15px}
.card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);margin-bottom:10px}
.pendiente{border-left:6px solid orange}
.completado{border-left:6px solid #ccc;opacity:0.7}
.pend{color:#c1121f;font-weight:bold}
.etiqueta{background:#ffe095;padding:3px 6px;border-radius:6px;font-size:12px;margin-right:6px}
.admin input,.admin textarea{width:100%;margin-bottom:6px;padding:8px;border-radius:6px;border:1px solid #ccc}
button{background:var(--verde);color:white;border:none;padding:8px 10px;border-radius:8px;font-weight:bold;cursor:pointer}
button.disabled{background:#999;cursor:not-allowed}
.back{position:fixed;left:15px;bottom:15px}
</style>
</head>

<body>
<header>üìù Pendientes - Asignar</header>
<div class="container" id="lista"></div>
<button class="back" onclick="location.href='index.html'">‚¨Ö Volver</button>

<script type="module">
import { db, ref, onValue, push, remove } from "./firebase.js";

const lista = document.getElementById("lista");
const pendientesRef = ref(db,"pendientes");
const salidasRef = ref(db,"salidas_asignadas");

const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
const rol = (sesion.rol || "invitado").toLowerCase();
if (rol !== "admin") location.href="index.html";

let pendientes = [];

function render(){
  lista.innerHTML="";
  if(pendientes.length===0){
    lista.innerHTML="<p align='center'>No hay pendientes</p>";
    return;
  }

  pendientes.forEach(p=>{
    const tienePendientes = p.pendientes && p.pendientes.length > 0;

    const card=document.createElement("div");
    card.className = "card " + (tienePendientes ? "pendiente" : "completado");
    card.innerHTML=`
      <span class="etiqueta">${tienePendientes ? "PENDIENTE" : "COMPLETADO"}</span>
      <b>Territorio ${p.territorio}</b>
      <div>üß± Faltan: <b>${(p.pendientes||[]).join(", ") || "-"}</b></div>
      <div>üë§ √öltimo: ${p.conductor||"-"}</div>
    `;

    if(tienePendientes){
      const box=document.createElement("div");
      box.className="admin";
      box.innerHTML=`
        <input id="c${p.id}" placeholder="Conductor">
        <input type="date" id="f${p.id}">
        <input type="time" id="h${p.id}">
        <input id="calles${p.id}" placeholder="Calle">
        <input id="inter${p.id}" placeholder="Intersecci√≥n">
        <textarea id="o${p.id}" placeholder="Observaci√≥n"></textarea>
        <button data-id="${p.id}">‚úÖ Asignar</button>
      `;
      card.appendChild(box);
    }

    lista.appendChild(card);
  });

  document.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id=btn.dataset.id;
      const p=pendientes.find(x=>x.id===id);
      const c=document.getElementById("c"+id).value.trim();
      const f=document.getElementById("f"+id).value;
      const h=document.getElementById("h"+id).value;
      const calle=document.getElementById("calles"+id).value.trim();
      const inter=document.getElementById("inter"+id).value.trim();
      const o=document.getElementById("o"+id).value.trim();
      if(!c||!f||!h||!calle||!inter){ alert("Faltan datos"); return; }

      await push(salidasRef,{
        territorio:p.territorio,
        pendientes:p.pendientes||[],
        conductor:c,
        fecha:f,
        hora:h,
        calle,
        interseccion:inter,
        observaciones:o,
        creado:Date.now()
      });

      await remove(ref(db,"pendientes/"+id));
      location.replace("proximas.html");
    };
  });
}

onValue(pendientesRef,s=>{
  pendientes=[];
  s.forEach(x=>{
    let o = x.val();
    o.id = x.key;
    pendientes.push(o);
  });
  render();
});
</script>
</body>
</html>