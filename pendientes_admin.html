<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pendientes - Admin</title>

<style>
:root{
  --verde:#1a4b27;
  --bg:#f4f4f4;
  --card:#ffffff;
  --muted:#666;
  --radius:12px;
  --font-size:17px;
}

/* ---------- GLOBAL ---------- */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:#222;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  font-size:var(--font-size);
  line-height:1.3;
  overflow-x:hidden;
}

header{
  background:var(--verde);
  color:#fff;
  text-align:center;
  font-weight:700;
  padding:16px 14px;
  font-size:20px;
  position:relative;
}

/* ---------- CONTAINER ---------- */
.container{
  max-width:980px;
  margin:14px auto;
  padding:12px;
}

/* ---------- CARD ---------- */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
  margin-bottom:14px;
  word-wrap:break-word;
}

.pendiente{ border-left:6px solid #c1121f; }
.completado{ border-left:6px solid #7a7a7a; opacity:0.9; }

.etiqueta{
  display:inline-block;
  background:#fff4d9;
  color:#333;
  padding:6px 10px;
  border-radius:10px;
  font-weight:700;
  font-size:14px;
  margin-bottom:8px;
}

/* meta / texto */
.card h4{ margin:8px 0 6px 0; font-size:18px; }
.card .muted{ color:var(--muted); font-size:15px; margin-bottom:6px; }

/* ---------- ADMIN FORM INSIDE CARD ---------- */
.admin{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  padding-top:10px;
  border-top:1px dashed #e6e6e6;
}

.admin input, .admin textarea{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #d1d1d1;
  font-size:16px;
}

.admin .row{
  display:flex;
  gap:10px;
}
.admin .row > *{ flex:1; }

/* assign button */
.admin button[data-id]{
  background:var(--verde);
  color:#fff;
  border-radius:10px;
  padding:10px 12px;
  font-weight:700;
  cursor:pointer;
  border:none;
  font-size:16px;
}

/* ---------- FLOATING ACTION BUTTON ---------- */
.fab{
  position:fixed;
  right:18px;
  bottom:18px;
  width:56px;height:56px;
  display:flex;align-items:center;justify-content:center;
  border-radius:50%;
  background:var(--verde);
  color:#fff;
  box-shadow:0 8px 22px rgba(0,0,0,0.18);
  font-size:30px;
  border:none;
  cursor:pointer;
  z-index:40;
}

/* ---------- BACK BUTTON ---------- */
.back{
  position:fixed;
  left:14px;
  bottom:18px;
  background:#ffffff;
  color:var(--verde);
  border:1px solid #e6e6e6;
  padding:10px 12px;
  border-radius:10px;
  box-shadow:0 6px 16px rgba(0,0,0,0.06);
  cursor:pointer;
  z-index:40;
  font-weight:700;
}

/* ---------- MODAL ---------- */
.modal-bg{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,0.55);
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:60;
}
.modal{
  width:100%;
  max-width:520px;
  background:#fff;
  border-radius:14px;
  padding:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  max-height:90vh;
  overflow:auto;
}
.modal h3{ margin:0 0 12px 0; text-align:center; font-size:20px; }
.modal .grid{ display:grid; grid-template-columns:1fr; gap:10px; }

/* inputs larger for accessibility */
.modal input, .modal textarea{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:16px;
}
.modal textarea{ min-height:90px; resize:vertical; }

/* action buttons */
.modal .actions{
  display:flex; gap:10px; margin-top:8px;
}
.modal .actions button{
  flex:1; padding:12px; font-size:16px; border-radius:10px; border:none; cursor:pointer;
}
.modal .actions .primary{ background:var(--verde); color:#fff; font-weight:700; }
.modal .actions .cancel{ background:#e6e6e6; color:#333; }

/* ---------- HELPER ---------- */
.small-muted{ color:var(--muted); font-size:13px; margin-top:-6px; margin-bottom:6px; }

/* ---------- RESPONSIVE ---------- */
@media (max-width:900px){
  .container{ padding:12px; }
  .card{ padding:12px; }
}
@media (max-width:600px){
  header{ font-size:18px; padding:14px;}
  .fab{ width:52px;height:52px; font-size:28px; right:14px; bottom:14px; }
  .back{ left:12px; bottom:14px; padding:10px; font-size:15px; }
  .modal{ padding:14px; }
  .modal h3{ font-size:18px; }
}
</style>
</head>

<body>

<header>ðŸ§± Pendientes - Asignar Salidas</header>

<!-- Lista -->
<div class="container" id="lista">Cargando...</div>

<!-- FAB (nuevo abajo-derecha) -->
<button class="fab" id="addNew" aria-label="Nueva salida">+</button>

<!-- Volver -->
<button class="back" onclick="location.href='index.html'">â¬… Volver</button>

<!-- MODAL NUEVA SALIDA -->
<div class="modal-bg" id="modalBg" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal" role="document">
    <h3 id="modalTitle">Crear nueva salida</h3>

    <div class="grid">
      <label for="nTerritorio"><strong>Territorio</strong></label>
      <input id="nTerritorio" placeholder="Ej: 12A" aria-label="Territorio">

      <label for="nManzanas"><strong>Manzanas (separadas por coma)</strong></label>
      <input id="nManzanas" placeholder="Ej: 1, 2, 3" aria-label="Manzanas">

      <label for="nConductor"><strong>Conductor</strong></label>
      <input id="nConductor" placeholder="Nombre del conductor" aria-label="Conductor">

      <div style="display:flex;gap:10px;">
        <div style="flex:1">
          <label for="nFecha"><strong>Fecha</strong></label>
          <input type="date" id="nFecha" aria-label="Fecha">
        </div>
        <div style="flex:1">
          <label for="nHora"><strong>Hora</strong></label>
          <input type="time" id="nHora" aria-label="Hora">
        </div>
      </div>

      <label for="nCalleInter"><strong>Calle / IntersecciÃ³n</strong></label>
      <input id="nCalleInter" placeholder="Calle principal y/o intersecciÃ³n" aria-label="Calle e intersecciÃ³n">

      <label for="nObs"><strong>Observaciones</strong></label>
      <textarea id="nObs" placeholder="Notas, indicaciones, etc." aria-label="Observaciones"></textarea>
    </div>

    <div class="actions" style="margin-top:8px;">
      <button class="primary" id="crearNueva">Crear salida</button>
      <button class="cancel" id="cerrarModal">Cancelar</button>
    </div>
    <div style="height:10px"></div>
  </div>
</div>

<script type="module">
import { db, ref as dbRef, onValue, push, remove } from "./firebase.js";

/* -------------------------
   ELEMENTOS & REFS
--------------------------*/
const lista = document.getElementById("lista");
const pendientesRef = dbRef(db, "pendientes");
const salidasRef = dbRef(db, "salidas_asignadas");

const addNew = document.getElementById("addNew");
const modalBg = document.getElementById("modalBg");
const crearNueva = document.getElementById("crearNueva");
const cerrarModal = document.getElementById("cerrarModal");

const nTerritorio = document.getElementById("nTerritorio");
const nManzanas = document.getElementById("nManzanas");
const nConductor = document.getElementById("nConductor");
const nFecha = document.getElementById("nFecha");
const nHora = document.getElementById("nHora");
const nCalleInter = document.getElementById("nCalleInter");
const nObs = document.getElementById("nObs");

/* ============================
   VALIDAR ADMIN (sin tocar lÃ³gica)
============================ */
const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
if ((sesion.rol || "invitado").toLowerCase() !== "admin") location.href = "index.html";

/* ============================
   FECHA / HORA DEFAULT
============================ */
function hoy(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}
function horaAhora(){
  const d=new Date();
  d.setSeconds(0); d.setMilliseconds(0);
  return d.toTimeString().slice(0,5);
}

/* ============================
   RENDER PENDIENTES
   (NO TOCO LÃ“GICA, sÃ³lo HTML/CSS)
============================ */
let pendientes = [];
function render(){
  lista.innerHTML = "";

  if(!pendientes || pendientes.length === 0){
    lista.innerHTML = `<div class="card"><div style="text-align:center"><strong>No hay pendientes</strong><div class="small-muted">Cuando aparezcan pendientes se verÃ¡n acÃ¡.</div></div></div>`;
    return;
  }

  pendientes.forEach(p=>{
    const tiene = Array.isArray(p.pendientes) && p.pendientes.length > 0;

    const card = document.createElement("div");
    card.className = "card " + (tiene ? "pendiente" : "completado");

    const pendientesText = (p.pendientes||[]).join(", ");

    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="min-width:0">
          <span class="etiqueta">${tiene ? "PENDIENTE" : "COMPLETADO"}</span>
          <h4>Territorio ${p.territorio || ""}</h4>
          <div class="muted">ðŸ§± Faltan: <strong>${pendientesText || "Ninguna"}</strong></div>
          <div class="muted">ðŸ‘¤ Ãšltimo conductor: ${p.conductor || "â€”"}</div>
        </div>
      </div>
    `;

    if(tiene){
      const admin = document.createElement("div");
      admin.className = "admin";

      admin.innerHTML = `
        <input id="c${p.id}" placeholder="Conductor" value="${p.conductor||""}">
        <div class="row">
          <input type="date" id="f${p.id}" value="${hoy()}">
          <input type="time" id="h${p.id}" value="${horaAhora()}">
        </div>
        <input id="calles${p.id}" placeholder="Calle / IntersecciÃ³n">
        <textarea id="o${p.id}" placeholder="ObservaciÃ³n"></textarea>
        <button data-id="${p.id}">Asignar salida</button>
      `;
      card.appendChild(admin);
    }

    lista.appendChild(card);
  });

  /* Evento asignar (igual que antes) */
  document.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.dataset.id;
      const p = pendientes.find(x=>x.id===id);

      const c = document.getElementById("c"+id).value.trim();
      const f = document.getElementById("f"+id).value;
      const h = document.getElementById("h"+id).value;
      const calleInter = document.getElementById("calles"+id).value.trim();
      const o = document.getElementById("o"+id).value.trim();

      if(!c || !f || !h || !calleInter){
        alert("Completa todos los campos.");
        return;
      }

      await push(salidasRef, {
        territorio: p.territorio,
        pendientes: Array.isArray(p.pendientes) ? p.pendientes : [],
        conductor: c,
        fecha: f,
        hora: h,
        calle_inter: calleInter,
        observaciones: o,
        creado: Date.now()
      });

      await remove(dbRef(db, "pendientes/"+id));
      location.replace("proximas.html");
    };
  });

}

/* ESCUCHAR FIREBASE */
onValue(pendientesRef, s=>{
  pendientes = [];
  s.forEach(x=>{
    let o = x.val();
    o.id = x.key;
    if(!Array.isArray(o.pendientes)) o.pendientes = [];
    pendientes.push(o);
  });
  // opcional ordenar
  pendientes.sort((a,b)=> (a.territorio||"").toString().localeCompare((b.territorio||"").toString(), undefined, {numeric:true}));
  render();
});

/* ============================
   BOTÃ“N NUEVA SALIDA (abrir modal)
============================ */
addNew.onclick = ()=>{
  // limpiar modal
  nTerritorio.value = "";
  nManzanas.value = "";
  nConductor.value = "";
  nFecha.value = hoy();
  nHora.value = horaAhora();
  nCalleInter.value = "";
  nObs.value = "";
  modalBg.style.display = "flex";
  // foco para accesibilidad
  setTimeout(()=>nTerritorio.focus(),150);
};

/* cerrar modal */
cerrarModal.onclick = ()=> modalBg.style.display = "none";
modalBg.addEventListener("click", (e)=>{ if(e.target===modalBg) modalBg.style.display="none"; });

/* ============================
   CREAR NUEVA SALIDA (ahora con manzanas)
============================ */
crearNueva.onclick = async ()=>{

  const territorio = nTerritorio.value.trim();
  const manzanasRaw = nManzanas.value.trim();
  const conductor = nConductor.value.trim();
  const fecha = nFecha.value;
  const hora = nHora.value;
  const calleInter = nCalleInter.value.trim();
  const obs = nObs.value.trim();

  if(!territorio || !manzanasRaw || !conductor || !fecha || !hora || !calleInter){
    alert("Completa todos los campos obligatorios (Territorio, Manzanas, Conductor, Fecha, Hora, Calle/IntersecciÃ³n).");
    return;
  }

  const manzanasArr = manzanasRaw.split(",").map(x=>x.trim()).filter(Boolean);

  await push(salidasRef, {
    territorio,
    pendientes: manzanasArr,
    conductor,
    fecha,
    hora,
    calle_inter: calleInter,
    observaciones: obs,
    creado: Date.now()
  });

  modalBg.style.display = "none";
  // redirigir a proximas para ver la salida creada (igual que antes)
  location.replace("proximas.html");
};
</script>

</body>
</html>