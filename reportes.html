<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reportes Generados</title>
<style>
  :root{--verde:#1a4b27;--bg:#f4f4f4}
  body{margin:0;font-family:Arial;background:var(--bg);color:#222}
  header{
    background:var(--verde);
    color:#fff;
    padding:16px;
    text-align:center;
    font-size:20px;
    font-weight:700;
  }

  .filtros-bar{
    display:flex;
    justify-content:space-around;
    background:#fff;
    padding:10px;
    border-bottom:1px solid #ddd;
  }

  .filtros-bar button{
    padding:6px 12px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
    background:#eee;
  }

  .filtros-bar button.activo{
    background:var(--verde);
    color:#fff;
  }

  .panel-filtros{
    background:#ffffff;
    padding:12px;
    border-bottom:2px solid #ddd;
  }

  .panel-filtros input, .panel-filtros select{
    width:100%;
    padding:8px;
    margin-bottom:8px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:14px;
  }

  .container{padding:18px;max-width:980px;margin:0 auto}
  .card{
    background:#fff;
    padding:14px;
    border-radius:12px;
    margin-bottom:12px;
    box-shadow:0 2px 6px rgba(0,0,0,0.06)
  }
  .hechas{color:#2d6a4f;font-weight:700}
  .pendientes{color:#c1121f;font-weight:700}
  .obs{
    margin-top:6px;
    padding:6px 8px;
    background:#f7f7f7;
    border-left:4px solid var(--verde);
    font-style:italic;
    font-size:14px;
  }

  .back-btn{
    position:fixed;
    left:16px;
    bottom:18px;
    background:var(--verde);
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer
  }
  h3{margin-top:10px}
</style>
</head>
<body>

<header>Reportes Generados</header>

<!-- FILTRO POR FECHA R√ÅPIDA -->
<div class="filtros-bar">
  <button onclick="setRango('hoy')" id="btnHoy">HOY</button>
  <button onclick="setRango('7')" id="btn7">7 D√çAS</button>
  <button onclick="setRango('30')" id="btn30">MES</button>
  <button onclick="setRango('todos')" id="btnTodos" class="activo">TODOS</button>
</div>

<!-- FILTROS AVANZADOS -->
<div class="panel-filtros">
  <input type="number" id="fTerritorio" placeholder="Territorio">
  <input type="text" id="fConductor" placeholder="Conductor">

  <select id="fEstado">
    <option value="">Todos</option>
    <option value="pendientes">Con pendientes</option>
    <option value="completo">Completos</option>
  </select>
</div>

<div class="container">
  <h3>Resultados</h3>
  <div id="contenedorReportes"></div>
</div>

<button class="back-btn" onclick="location.href='index.html'">‚¨Ö Volver</button>

<script type="module">
import { db, ref, onValue } from "./firebase.js";

const cont = document.getElementById("contenedorReportes");

let reportes = [];
let rangoFecha = "todos";

function convertirFecha(fecha){
  if(!fecha) return null;
  const [d,m,y] = fecha.split("/");
  return `${y}-${m}-${d}`;
}

window.setRango = (r)=>{
  rangoFecha = r;

  document.querySelectorAll(".filtros-bar button").forEach(b=>b.classList.remove("activo"));
  if(r==="hoy") btnHoy.classList.add("activo");
  if(r==="7") btn7.classList.add("activo");
  if(r==="30") btn30.classList.add("activo");
  if(r==="todos") btnTodos.classList.add("activo");

  aplicarFiltros();
}

["fTerritorio","fConductor","fEstado"].forEach(id=>{
  document.getElementById(id).addEventListener("input", aplicarFiltros);
});

function aplicarFiltros(){
  let t = fTerritorio.value.trim();
  let c = fConductor.value.toLowerCase().trim();
  let estado = fEstado.value;
  const hoy = new Date();

  let lista = reportes.filter(r=>{

    if(rangoFecha !== "todos" && r.fecha){
      const rf = new Date(convertirFecha(r.fecha));
      const dif = Math.floor((hoy - rf) / (1000*60*60*24));
      if(rangoFecha === "hoy" && dif !== 0) return false;
      if(rangoFecha === "7" && dif > 7) return false;
      if(rangoFecha === "30" && dif > 30) return false;
    }

    if(t && String(r.territorio) !== t) return false;
    if(c && !String(r.conductor||"").toLowerCase().includes(c)) return false;

    if(estado === "pendientes" && (!r.pendientes || r.pendientes.length === 0)) return false;
    if(estado === "completo" && (r.pendientes && r.pendientes.length > 0)) return false;

    return true;
  });

  cont.innerHTML = lista.length ? "" : "<p style='color:#666'>Sin resultados.</p>";

  lista.forEach(r=>{
    const hechas = Array.isArray(r.hechas) ? r.hechas.join(", ") : "-";
    const pendientes = Array.isArray(r.pendientes) ? r.pendientes.join(", ") : "-";

    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <h4>Territorio ${r.territorio} ‚Äî ${r.fecha || ""} ${r.hora || ""}</h4>
      <div><b>Conductor:</b> ${r.conductor || "-"}</div>
      <div>‚úÖ Hechas: <span class="hechas">${hechas}</span></div>
      <div>‚è≥ Pendientes: <span class="pendientes">${pendientes}</span></div>
      ${r.observaciones ? `<div class="obs">üìù ${r.observaciones}</div>` : ""}
    `;
    cont.appendChild(d);
  });
}

/* ==== CARGA DE REPORTES ==== */
onValue(ref(db,"reportes"), snap=>{
  reportes = [];
  snap.forEach(x=>{
    const r = x.val() || {};
    if(!r.territorio) return;
    reportes.push(r);
  });

  reportes.sort((a,b)=>(b.ts||0)-(a.ts||0));
  aplicarFiltros();
});
</script>

</body>
</html>