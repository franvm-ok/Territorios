<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Departamento de Territorio ‚Äî Dashboard</title>

<!-- Estilos: Verde suave, tarjetas medianas, accesible y responsivo -->
<style>
  :root{
    --bg: #f3f7f3;
    --panel: #ffffff;
    --green: #4e8f6b;      /* verde principal */
    --green-dark: #35503b; /* verde oscuro */
    --muted: #6b7a6a;
    --card-shadow: 0 6px 18px rgba(49,73,56,0.08);
    --radius: 14px;
    --gap: 18px;
    --ui-size: 18px; /* base para inputs/buttons */
  }

  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;color:#243022;}
  header{
    background:linear-gradient(180deg, #57a07b 0%, var(--green) 100%);
    color:white;padding:18px 16px;text-align:center;font-size:22px;font-weight:700;
    box-shadow: 0 3px 8px rgba(50,80,60,0.08);
  }
  .wrap{max-width:1100px;margin:18px auto;padding:0 16px;}

  /* Dashboard cards grid (medianas) */
  .cards{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--gap);
    align-items:stretch;
  }
  @media(min-width:720px){
    .cards{grid-template-columns: repeat(3, 1fr);}
  }
  @media(min-width:1100px){
    .cards{grid-template-columns: repeat(4, 1fr);}
  }

  .card {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 22px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    gap:12px;
    box-shadow: var(--card-shadow);
    cursor:pointer;
    transition: transform .14s ease, box-shadow .14s ease;
    min-height:120px;
    border: 1px solid rgba(34,50,40,0.04);
  }
  .card:active{transform: translateY(2px);}
  .card:focus{outline:3px solid rgba(69,142,100,0.18);outline-offset:3px;}
  .card .icon{
    width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg, rgba(78,143,107,0.12), rgba(78,143,107,0.06)); font-size:28px;color:var(--green-dark);
  }
  .card .label{font-size:18px;font-weight:700;color:var(--green-dark);text-align:center;}
  .card .hint{font-size:13px;color:var(--muted);}

  /* Section headers & small layout */
  h2{margin:18px 0 8px 0;color:var(--green-dark);font-size:20px}
  .controls{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0 18px 0}
  .btn{
    background:var(--green);
    color:white;border:none;padding:12px 16px;border-radius:10px;font-size:var(--ui-size);cursor:pointer;font-weight:700;
    box-shadow: 0 6px 14px rgba(78,143,107,0.12);
  }
  .btn.ghost{background:transparent;color:var(--green-dark);border:1px solid rgba(53,80,59,0.12);box-shadow:none}
  .btn.small{padding:8px 12px;font-size:16px}
  .btn:active{transform:translateY(1px)}
  .btn:focus{outline:3px solid rgba(77,125,92,0.18);outline-offset:2px}

  /* Screens */
  .screen{display:none}
  .screen.active{display:block}

  /* Territorios grid */
  .territory-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(min-width:720px){ .territory-grid{grid-template-columns:repeat(3,1fr)} }
  @media(min-width:1100px){ .territory-grid{grid-template-columns:repeat(4,1fr)} }

  .territory-card{
    background:linear-gradient(180deg, rgba(78,143,107,0.06), rgba(78,143,107,0.02));
    border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:8px;align-items:flex-start;
    cursor:pointer;border:1px solid rgba(34,50,40,0.04);
  }
  .territory-card .title{font-weight:800;color:var(--green-dark);font-size:17px}
  .territory-card .meta{font-size:14px;color:var(--muted)}
  .territory-card .manzanas{margin-top:auto;font-size:14px;font-weight:700;color:var(--green-dark)}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(10,14,10,0.45);display:flex;align-items:center;justify-content:center;padding:20px;z-index:60}
  .modal{background:var(--panel);border-radius:14px;padding:18px;max-width:760px;width:100%;box-shadow:0 30px 70px rgba(10,20,10,0.2)}
  .modal .row{display:flex;gap:12px;flex-wrap:wrap}
  .modal label{display:block;font-weight:700;margin-top:8px;color:var(--green-dark)}
  .modal select,input,textarea{
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(34,50,40,0.08);font-size:16px;
  }
  .modal .manzana-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .pill{padding:10px 12px;border-radius:10px;border:1px solid rgba(34,50,40,0.06);background:#fff;font-weight:700;cursor:pointer}
  .pill.selected{background:var(--green);color:white;border-color:transparent;box-shadow:0 8px 20px rgba(78,143,107,0.12)}
  .close-x{background:transparent;border:none;font-size:22px;color:var(--muted);cursor:pointer;position:absolute;right:14px;top:10px}

  /* Table reports */
  .table-wrap{overflow:auto;background:var(--panel);padding:10px;border-radius:12px;box-shadow:var(--card-shadow)}
  table{width:100%;border-collapse:collapse;font-size:15px}
  th,td{padding:12px;border-bottom:1px solid rgba(34,50,40,0.06);text-align:left}
  th{background:linear-gradient(180deg,var(--green) 0%, var(--green-dark) 100%);color:white;font-weight:700}
  .muted{color:var(--muted);font-size:14px}

  footer{margin:30px 0 60px 0;text-align:center;color:var(--muted);font-size:14px}
</style>
</head>
<body>

<header aria-hidden="false">üè† Departamento de Territorio</header>

<main class="wrap" id="app" role="main">
  <!-- DASHBOARD -->
  <section id="screen-dashboard" class="screen active" aria-labelledby="dashboard-title">
    <h2 id="dashboard-title">Bienvenido ‚Äî Elija una acci√≥n</h2>
    <p class="muted">Interfaz limpia y botones medianos, pensada para adultos mayores. Tocar una tarjeta para continuar.</p>

    <div class="cards" role="list">
      <div class="card" role="button" tabindex="0" onclick="openReportModal()" onkeydown="if(event.key==='Enter') openReportModal()" aria-label="Reportar predicaci√≥n">
        <div class="icon" aria-hidden="true">üìã</div>
        <div class="label">Reportar Predicaci√≥n</div>
        <div class="hint">R√°pido y sencillo</div>
      </div>

      <div class="card" role="button" tabindex="0" onclick="showScreen('territorios')" onkeydown="if(event.key==='Enter') showScreen('territorios')" aria-label="Ver territorios">
        <div class="icon" aria-hidden="true">üóÇÔ∏è</div>
        <div class="label">Territorios</div>
        <div class="hint">32 territorios y sus manzanas</div>
      </div>

      <div class="card" role="button" tabindex="0" onclick="alert('Mapa pr√≥ximamente ‚ñ∂')" onkeydown="if(event.key==='Enter') alert('Mapa pr√≥ximamente ‚ñ∂')" aria-label="Mapa">
        <div class="icon" aria-hidden="true">üó∫Ô∏è</div>
        <div class="label">Mapa</div>
        <div class="hint">Pendiente (pr√≥xima versi√≥n)</div>
      </div>

      <div class="card" role="button" tabindex="0" onclick="showScreen('reportes')" onkeydown="if(event.key==='Enter') showScreen('reportes')" aria-label="Ver reportes">
        <div class="icon" aria-hidden="true">üìë</div>
        <div class="label">Reportes</div>
        <div class="hint">Historial y exportaci√≥n</div>
      </div>
    </div>
  </section>

  <!-- TERRITORIOS -->
  <section id="screen-territorios" class="screen" aria-labelledby="territorios-title">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h2 id="territorios-title">Territorios</h2>
        <p class="muted">Toque un territorio para reportar la manzana correspondiente.</p>
      </div>
      <div>
        <button class="btn ghost small" onclick="showScreen('screen-dashboard')">‚Üê Men√∫</button>
      </div>
    </div>

    <div id="territoryGrid" class="territory-grid" style="margin-top:14px"></div>
  </section>

  <!-- REPORTES -->
  <section id="screen-reportes" class="screen" aria-labelledby="reportes-title">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h2 id="reportes-title">Reportes</h2>
        <p class="muted">Historial de reportes guardados en este dispositivo.</p>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn small" onclick="exportCSV()">Exportar CSV</button>
        <button class="btn ghost small" onclick="clearReports()" title="Borrar todos los reportes">Borrar</button>
        <button class="btn ghost small" onclick="showScreen('screen-dashboard')">‚Üê Men√∫</button>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:12px">
      <table aria-describedby="reportes-title">
        <thead><tr><th>Fecha</th><th>Territorio</th><th>Manzana</th><th>Conductor</th><th>Notas</th></tr></thead>
        <tbody id="reportsTable"><tr><td colspan="5" class="muted">Cargando...</td></tr></tbody>
      </table>
    </div>
  </section>

  <footer>App de Territorios ‚Ä¢ Compatible Android / iOS / Tablet / PC</footer>
</main>

<!-- Modal: Reportar (abre desde dashboard o desde territorio) -->
<div id="modalBackdrop" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal" role="document">
    <button class="close-x" aria-label="Cerrar" onclick="closeModal()">‚úï</button>
    <h3 id="modalTitle" style="margin:0 0 8px 0;color:var(--green-dark)">üìã Reportar Predicaci√≥n</h3>
    <p class="muted" style="margin:0 0 12px 0">Selecci√≥n r√°pida ‚Äî campos grandes y claros.</p>

    <div class="row">
      <div style="flex:1 1 220px;min-width:160px">
        <label for="modalTerritorio">Territorio</label>
        <select id="modalTerritorio" aria-label="Territorio" onchange="renderManzanaPills()"></select>
      </div>

      <div style="flex:1 1 220px;min-width:160px">
        <label for="modalConductor">Conductor</label>
        <input id="modalConductor" type="text" placeholder="Nombre del conductor" aria-label="Conductor" />
      </div>

      <div style="flex:1 1 220px;min-width:160px">
        <label for="modalFecha">Fecha</label>
        <input id="modalFecha" type="date" aria-label="Fecha" />
      </div>
    </div>

    <label>Manzana</label>
    <div id="manzanaPills" class="manzana-buttons" aria-label="Seleccionar manzana"></div>

    <label for="modalNotas">Notas (opcional)</label>
    <textarea id="modalNotas" rows="3" placeholder="Observaciones, caras sin predicar, etc." style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(34,50,40,0.06);font-size:15px"></textarea>

    <div style="display:flex;gap:12px;margin-top:14px">
      <button class="btn" onclick="saveModalReport()">Guardar Reporte</button>
      <button class="btn ghost" onclick="closeModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- Script: l√≥gica, render y almacenamiento -->
<script>
  // ======== Datos: manzanas por territorio (32 territorios) ========
  const TERRITORIES = {
    1:4,2:4,3:4,4:5,5:8,6:6,7:6,8:6,9:8,10:6,11:8,12:7,13:4,14:8,15:6,16:6,
    17:4,18:6,19:4,20:4,21:5,22:4,23:4,24:4,25:4,26:4,27:4,28:6,29:4,30:4,31:5,32:6
  };

  // Estado simple
  let selectedTerritory = null;
  const REPORTS_KEY = 'territorios_reportes_v1';

  // Inicial: renderizar grid de territorios y llenar select modalTerritorio
  document.addEventListener('DOMContentLoaded', () => {
    renderTerritoriesGrid();
    fillModalTerritorioSelect();
    loadReportsTable();
  });

  // Navegaci√≥n entre pantallas
  function showScreen(name){
    // screens: 'screen-dashboard','screen-territorios','screen-reportes'
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    if (name === 'screen-dashboard') document.getElementById('screen-dashboard').classList.add('active');
    if (name === 'territorios' || name === 'screen-territorios') document.getElementById('screen-territorios').classList.add('active');
    if (name === 'reportes' || name === 'screen-reportes') document.getElementById('screen-reportes').classList.add('active');
    // refresh table if reportes
    if (name === 'reportes') loadReportsTable();
  }

  // Renderiza las 32 tarjetas de territorios
  function renderTerritoriesGrid(){
    const grid = document.getElementById('territoryGrid');
    grid.innerHTML = '';
    for (let i=1;i<=32;i++){
      const card = document.createElement('div');
      card.className = 'territory-card';
      card.tabIndex = 0;
      card.setAttribute('role','button');
      card.setAttribute('aria-label', `Territorio ${i}, ${TERRITORIES[i]} manzanas`);
      card.innerHTML = `<div class="title">Territorio ${i}</div>
                        <div class="meta">Toque para reportar</div>
                        <div class="manzanas">${TERRITORIES[i]} manzanas</div>`;
      card.onclick = ()=> openReportModal(i);
      card.onkeydown = (e)=> { if(e.key==='Enter') openReportModal(i); };
      grid.appendChild(card);
    }
  }

  // Modal: abrir (opcional preseleccionar territorio)
  function openReportModal(preterritorio){
    selectedTerritory = preterritorio || null;
    document.getElementById('modalBackdrop').style.display = 'flex';
    // prefill fecha a hoy
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('modalFecha').value = today;
    // set conductor empty
    document.getElementById('modalConductor').value = '';
    document.getElementById('modalNotas').value = '';
    // set select and render pills
    const sel = document.getElementById('modalTerritorio');
    if (preterritorio) sel.value = String(preterritorio);
    renderManzanaPills();
    // focus conductor (so devices open keyboard)
    setTimeout(()=>document.getElementById('modalConductor').focus(),200);
  }

  function closeModal(){
    document.getElementById('modalBackdrop').style.display = 'none';
    selectedTerritory = null;
  }

  // Llenar select con territorios
  function fillModalTerritorioSelect(){
    const s = document.getElementById('modalTerritorio');
    s.innerHTML = '<option value="">Seleccionar territorio...</option>';
    for(let i=1;i<=32;i++){
      const o = document.createElement('option');
      o.value = i; o.textContent = 'Territorio ' + i;
      s.appendChild(o);
    }
    s.onchange = ()=> { renderManzanaPills(); };
  }

  // Render botones/pills de manzanas seg√∫n territorio seleccionado en modal
  function renderManzanaPills(){
    const sel = document.getElementById('modalTerritorio').value;
    const target = document.getElementById('manzanaPills');
    target.innerHTML = '';
    const territory = sel ? Number(sel) : (selectedTerritory || null);
    if (!territory){
      // mostrar mensaje instructivo
      target.innerHTML = '<div class="muted" style="padding:8px">Seleccione un territorio arriba para ver sus manzanas.</div>';
      return;
    }
    const count = TERRITORIES[territory] || 0;
    for(let i=1;i<=count;i++){
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'pill';
      b.textContent = 'Manzana ' + i;
      b.dataset.value = i;
      b.onclick = ()=> {
        // deseleccionar anteriores
        document.querySelectorAll('#manzanaPills .pill').forEach(p=>p.classList.remove('selected'));
        b.classList.add('selected');
      };
      target.appendChild(b);
    }
  }

  // Guardar reporte desde modal
  function saveModalReport(){
    const territorio = document.getElementById('modalTerritorio').value || (selectedTerritory ? String(selectedTerritory) : '');
    const conductor = document.getElementById('modalConductor').value.trim();
    const fecha = document.getElementById('modalFecha').value;
    const notas = document.getElementById('modalNotas').value.trim();
    const pill = document.querySelector('#manzanaPills .pill.selected');
    const manzana = pill ? pill.dataset.value : null;

    if (!territorio || !manzana || !conductor || !fecha){
      alert('Complete Territorio, Manzana, Conductor y Fecha antes de guardar.');
      return;
    }

    const report = {
      id: 'r_' + Date.now(),
      territorio: Number(territorio),
      manzana: Number(manzana),
      conductor,
      fecha,
      notas
    };

    const all = JSON.parse(localStorage.getItem(REPORTS_KEY) || '[]');
    all.unshift(report); // push front (m√°s reciente arriba)
    localStorage.setItem(REPORTS_KEY, JSON.stringify(all));

    // feedback y cerrar modal
    alert('Reporte guardado ‚úÖ');
    closeModal();
    loadReportsTable();
  }

  // Cargar tabla de reportes
  function loadReportsTable(){
    const tbody = document.getElementById('reportsTable');
    const all = JSON.parse(localStorage.getItem(REPORTS_KEY) || '[]');
    tbody.innerHTML = '';
    if (!all.length){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">No hay reportes a√∫n.</td></tr>`;
      return;
    }
    all.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.fecha}</td>
                      <td>Territorio ${r.territorio}</td>
                      <td>Manzana ${r.manzana}</td>
                      <td>${escapeHtml(r.conductor)}</td>
                      <td>${escapeHtml(r.notas || '')}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Export CSV
  function exportCSV(){
    const all = JSON.parse(localStorage.getItem(REPORTS_KEY) || '[]');
    if (!all.length){ alert('No hay reportes para exportar.'); return; }
    const header = ['fecha','territorio','manzana','conductor','notas'];
    const rows = all.map(r => [r.fecha, r.territorio, r.manzana, r.conductor.replaceAll('"','""'), r.notas.replaceAll('"','""')]);
    const csv = [header, ...rows].map(r=> r.map(c=> `"${String(c).replaceAll('"','""')}"`).join(',')).join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'reportes_territorios.csv'; a.style.display = 'none';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // Borrar todos los reportes
  function clearReports(){
    if (!confirm('Borrar TODOS los reportes guardados en este dispositivo? Esta acci√≥n no puede deshacerse.')) return;
    localStorage.removeItem(REPORTS_KEY);
    loadReportsTable();
    alert('Reportes borrados.');
  }

  // Helper: escape simple
  function escapeHtml(s){ return String(s || '').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // Si el usuario abre la app con un par√°metro ?territorio=5 podemos abrir modal pre-seleccionado
  (function handleUrlPrefill(){
    try{
      const params = new URLSearchParams(location.search);
      const t = params.get('territorio');
      if (t && Number(t) >=1 && Number(t)<=32) openReportModal(Number(t));
    }catch(e){}
  })();

  // Exponer showScreen a botones inline
  window.showScreen = showScreen;
  window.openReportModal = openReportModal;
  window.closeModal = closeModal;
  window.exportCSV = exportCSV;
  window.clearReports = clearReports;
</script>

</body>
</html>
