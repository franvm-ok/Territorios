<script type="module">
import { db, ref as dbRef, onValue, remove } from "./firebase.js";

const lista = document.getElementById("lista");
const salidasRef = dbRef(db,"salidas_asignadas");

const btnHoy = document.getElementById("hoy");
const btn7 = document.getElementById("siete");
const btnTodos = document.getElementById("todos");

let filtro = "hoy";
let cache = [];

/* ===== FECHA ===== */
function fechaTexto(fecha){
  try{
    return new Date(fecha + "T00:00:00").toLocaleDateString("es-AR",{
      weekday:'long',
      day:'numeric',
      month:'long'
    }).toUpperCase();
  }catch{
    return fecha;
  }
}

/* ===== FORMATO 24 HS ===== */
function horaTexto(h){
  try{
    const [hor,min] = h.split(":");
    const d = new Date();
    d.setHours(hor, min, 0, 0);
    return d.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
  }catch{
    return h || "â€”";
  }
}

/* ===== TIMESTAMP ===== */
function tiempo(fecha,hora){
  try{
    const [h,m] = (hora||"00:00").split(":");
    const d = new Date(fecha + "T00:00:00");
    d.setHours(h,m,0,0);
    return d.getTime();
  }catch{
    return 0;
  }
}

/* ===== BOTONES ===== */
function activar(btn){
  document.querySelectorAll(".filtros button").forEach(b=>b.classList.remove("activo"));
  btn.classList.add("activo");
}

btnHoy.onclick = ()=>{ filtro="hoy"; activar(btnHoy); mostrar(); };
btn7.onclick  = ()=>{ filtro="7"; activar(btn7); mostrar(); };
btnTodos.onclick = ()=>{ filtro="todos"; activar(btnTodos); mostrar(); };

/* ===== MOSTRAR ===== */
function mostrar(){

  lista.innerHTML="";

  if(cache.length===0){
    lista.innerHTML="<p align='center'>No hay salidas asignadas</p>";
    return;
  }

  let hoyInicio = new Date();
  hoyInicio.setHours(0,0,0,0);

  let limite7 = new Date();
  limite7.setDate(limite7.getDate()+7);
  limite7.setHours(23,59,59,999);

  let mostrados = [];

  cache.forEach(o=>{

    const ts = tiempo(o.fecha,o.hora);

    if(filtro==="hoy"){
      if(new Date(ts).toDateString() === new Date().toDateString()) mostrados.push(o);
    }

    if(filtro==="7"){
      if(ts >= hoyInicio.getTime() && ts <= limite7.getTime()) mostrados.push(o);
    }

    if(filtro==="todos"){
      mostrados.push(o);
    }

  });

  if(mostrados.length===0){
    lista.innerHTML="<p align='center'>No hay salidas para mostrar</p>";
    return;
  }

  mostrados.sort((a,b)=>tiempo(a.fecha,a.hora)-tiempo(b.fecha,b.hora));

  mostrados.forEach(o=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="fecha">ğŸ•’ ${fechaTexto(o.fecha)} - ${horaTexto(o.hora || "00:00")}</div>
      <div class="linea">ğŸ“ Territorio: <b>${o.territorio}</b></div>
      <div class="linea">ğŸ‘¤ Conductor: ${o.conductor||"â€”"}</div>
      <div class="linea">ğŸ“Œ DirecciÃ³n: ${o.calle||"-"} y ${o.interseccion||"-"}</div>
      <div class="linea">ğŸ§± Faltan: ${(o.pendientes||[]).join(", ")||"Nadie"}</div>
      ${o.observaciones?`<div class="linea">âœ ${o.observaciones}</div>`:""}
    `;
    lista.appendChild(card);
  });

}

/* ===== ELIMINACIÃ“N AUTOMÃTICA DE SALIDAS PASADAS ===== */
function limpiarSalidasViejas(){

  const ahora = Date.now();
  const vencimiento = 24 * 60 * 60 * 1000; // 24 hs luego de realizada

  cache.forEach(o=>{
    const ts = tiempo(o.fecha, o.hora);

    if(ts + vencimiento < ahora){
      // borrar en Firebase
      remove(dbRef(db, "salidas_asignadas/" + o.id));
    }
  });
}

/* ===== LEER FIREBASE ===== */
onValue(salidasRef, snap=>{

  cache = [];

  snap.forEach(x=>{
    cache.push({
      id:x.key,
      ...x.val()
    });
  });

  limpiarSalidasViejas();
  mostrar();

});
</script>