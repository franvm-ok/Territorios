<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PrÃ³ximas Salidas</title>

<style>
:root{--verde:#1a4b27;--bg:#f4f4f4}
*{box-sizing:border-box}
body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:#222}
header{background:var(--verde);color:#fff;padding:18px;text-align:center;font-weight:bold;font-size:20px}

.container{padding:15px;max-width:900px;margin:auto}

/* FILTROS */
.filtros{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.filtros button{
  border:2px solid var(--verde);
  background:white;
  color:var(--verde);
  border-radius:20px;
  padding:6px 14px;
  font-weight:bold;
  cursor:pointer
}
.filtros button.activo{background:var(--verde);color:white}

/* TARJETAS */
.card{
  background:white;
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.07)
}
.pend{color:#c1121f;font-weight:bold}
.obs{margin-top:6px;padding:8px;background:#f6f6f6;border-left:4px solid var(--verde);font-style:italic}

.back-btn{
  position:fixed;
  left:15px;
  bottom:15px;
  background:var(--verde);
  color:white;
  border:none;
  padding:10px 14px;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer
}

/* ADMIN */
.admin-box{margin-top:10px;border-top:1px dashed #ccc;padding-top:10px}
.admin-box input,
.admin-box textarea{
  width:100%;
  margin-bottom:6px;
  padding:6px;
  border-radius:6px;
  border:1px solid #ccc
}
.admin-box button{
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-weight:bold;
  cursor:pointer;
  background:var(--verde);
  color:white;
}
.eliminar{background:#c1121f;margin-left:6px}
</style>
</head>

<body>
<header>ğŸ“… PrÃ³ximas Salidas</header>

<div class="container">

<div class="filtros">
  <button data-f="todos" class="activo">Todos</button>
  <button data-f="hoy">Hoy</button>
  <button data-f="7">7 dÃ­as</button>
  <button data-f="mes">Este mes</button>
</div>

<div id="lista"></div>

</div>

<button class="back-btn" onclick="location.href='index.html'">â¬… Volver</button>

<script type="module">
import { db, ref, onValue, update, remove } from "./firebase.js";

const lista = document.getElementById("lista");
const botones = document.querySelectorAll("[data-f]");
const refSalidas = ref(db,"salidas_asignadas");

const rol = localStorage.getItem("rol") || "invitado";
const esAdmin = rol === "admin";

let datos = [];
let filtro = "todos";

/* obtener fecha base */
function getFecha(o){
  return o.creado || Date.parse(o.fecha) || 0;
}

/* aplicar filtro */
function pasarFiltro(o){
  const f = new Date(getFecha(o));
  const hoy = new Date();

  if(filtro==="hoy") return f.toDateString() === hoy.toDateString();
  if(filtro==="7") return (hoy - f) <= 7*24*60*60*1000;
  if(filtro==="mes") return f.getMonth()===hoy.getMonth() && f.getFullYear()===hoy.getFullYear();
  return true;
}

/* render */
function render(){
  lista.innerHTML = "";
  const ver = datos.filter(pasarFiltro);

  if(!ver.length){
    lista.innerHTML = "<p style='color:#666'>No hay salidas registradas.</p>";
    return;
  }

  ver.forEach(s=>{
    const faltan = Array.isArray(s.pendientes) ? s.pendientes.join(", ") : "-";

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <b>ğŸ˜ Territorio ${s.territorio || "-"}</b>
      <div>ğŸ“… Fecha: ${s.fecha || "-"}</div>
      <div>ğŸ‘¤ Conductor: ${s.conductor || "-"}</div>
      <div>ğŸ§± Pendientes: <span class="pend">${faltan}</span></div>
      ${s.observaciones ? `<div class="obs">ğŸ“ ${s.observaciones}</div>` : ""}
    `;

    if(esAdmin){
      const box = document.createElement("div");
      box.className="admin-box";
      box.innerHTML = `
        <input id="c${s.id}" value="${s.conductor||""}" placeholder="Conductor">
        <input id="f${s.id}" type="date" value="${s.fecha||""}">
        <textarea id="o${s.id}" rows="2" placeholder="Observaciones">${s.observaciones||""}</textarea>
        <button onclick="guardar('${s.id}')">ğŸ’¾ Guardar</button>
        <button class="eliminar" onclick="borrar('${s.id}')">ğŸ—‘ Eliminar</button>
      `;
      card.appendChild(box);
    }

    lista.appendChild(card);
  });
}

/* guardar */
window.guardar = async (id)=>{
  await update(ref(db,"salidas_asignadas/"+id),{
    conductor: document.getElementById("c"+id).value,
    fecha: document.getElementById("f"+id).value,
    observaciones: document.getElementById("o"+id).value
  });
  alert("âœ… Cambios guardados");
}

/* eliminar */
window.borrar = async (id)=>{
  if(!confirm("Â¿Seguro que querÃ©s eliminar esta salida?")) return;
  await remove(ref(db,"salidas_asignadas/"+id));
  alert("ğŸ—‘ Eliminada");
}

/* botones filtros */
botones.forEach(b=>{
  b.onclick = ()=>{
    botones.forEach(x=>x.classList.remove("activo"));
    b.classList.add("activo");
    filtro = b.dataset.f;
    render();
  }
});

/* firebase */
onValue(refSalidas, snap=>{
  datos=[];
  snap.forEach(x=>{
    const o = x.val();
    o.id = x.key;
    datos.push(o);
  });

  datos.sort((a,b)=>getFecha(b)-getFecha(a));
  render();
});
</script>

</body>
</html>