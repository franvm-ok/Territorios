<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pr√≥ximas Salidas</title>

<style>
    body{
        margin:0;background:#eef2f1;font-family:Arial, sans-serif;
    }
    header{
        background:#1a4b27;color:white;padding:18px;font-size:22px;
        text-align:center;font-weight:bold;
    }

    #lista{
        padding:18px;
        display:flex;
        flex-direction:column;
        gap:22px;
    }

    /* TARJETA ESTILO GOOGLE CALENDAR MEJORADA PARA PERSONAS MAYORES */
    .card{
        background:white;
        padding:20px;
        border-radius:20px;
        box-shadow:0 4px 12px rgba(0,0,0,0.18);
        font-size:18px;
        line-height:1.45;
    }

    .encabezado{
        font-size:20px;
        font-weight:bold;
        color:#1a4b27;
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:10px;
        white-space:nowrap;
    }

    .separador{
        width:100%;
        height:2px;
        background:#d0d0d0;
        margin:12px 0;
    }

    .label{
        font-weight:bold;
        margin-bottom:2px;
        font-size:17px;
    }
    .value{
        padding-left:8px;
        font-size:19px;
    }

    .more-btn{
        border:none;background:none;font-size:26px;
        cursor:pointer;padding:4px;
        color:#555;
    }

    .menu{
        display:none;
        flex-direction:column;
        margin-top:14px;
        border-top:1px solid #ddd;
        padding-top:12px;
        gap:8px;
    }
    .menu button{
        background:#f3f3f3;border:none;padding:12px;
        border-radius:10px;font-size:16px;text-align:left;
        cursor:pointer;
    }

    .empty{
        padding:30px;text-align:center;color:#555;font-size:20px;
    }

    /* MODAL */
    #modal{
        display:none;position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.55);justify-content:center;align-items:center;
        padding:20px;z-index:20;
    }
    .modal-box{
        background:white;padding:20px;border-radius:12px;width:100%;
        max-width:420px;display:flex;flex-direction:column;gap:12px;
    }
    .modal-box input, .modal-box textarea{
        width:100%;padding:10px;border:1px solid #ccc;
        border-radius:8px;font-size:16px;
    }
    .modal-btns{
        display:flex;gap:10px;margin-top:8px;
    }
    .modal-btns button{
        flex:1;padding:12px;font-size:16px;border:none;border-radius:8px;
        cursor:pointer;font-weight:bold;
    }
    .save{ background:#1a4b27;color:white; }
    .cancel{ background:#ccc; }
</style>
</head>

<body>

<header>Pr√≥ximas Salidas</header>

<div id="lista"></div>

<!-- MODAL -->
<div id="modal">
    <div class="modal-box">
        <h3>Editar salida</h3>

        <input id="e_fecha" type="date">
        <input id="e_hora" type="time">
        <input id="e_calle" placeholder="Calle">
        <input id="e_inter" placeholder="Intersecci√≥n">
        <input id="e_territorio" placeholder="Territorio">
        <input id="e_manzanas" placeholder="Manzanas separadas por coma">
        <input id="e_conductor" placeholder="Conductor">
        <textarea id="e_obs" rows="2" placeholder="Observaciones"></textarea>

        <div class="modal-btns">
            <button id="cancelEdit" class="cancel">Cancelar</button>
            <button id="saveEdit" class="save">Guardar</button>
        </div>
    </div>
</div>

<script type="module">
import { db, ref as dbRef, onValue, update, remove, push } from "./firebase.js";

/* ELEMENTOS */
const lista = document.getElementById("lista");
const salidasRef = dbRef(db, "salidas_asignadas");
const pendientesRef = dbRef(db, "pendientes");

const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
let rol = (sesion.rol || "invitado").toLowerCase();
if (rol === "invitado") rol = "conductor";

/* MODAL */
const modal = document.getElementById("modal");
const e_territorio = document.getElementById("e_territorio");
const e_manzanas = document.getElementById("e_manzanas");
const e_conductor = document.getElementById("e_conductor");
const e_fecha = document.getElementById("e_fecha");
const e_hora = document.getElementById("e_hora");
const e_calle = document.getElementById("e_calle");
const e_inter = document.getElementById("e_inter");
const e_obs = document.getElementById("e_obs");

const saveEdit = document.getElementById("saveEdit");
const cancelEdit = document.getElementById("cancelEdit");

let salidas = [];
let activeMenuId = null;
let editingId = null;

/* UTIL: DIA DE LA SEMANA */
const dias = ["DOMINGO","LUNES","MARTES","MI√âRCOLES","JUEVES","VIERNES","S√ÅBADO"];
function formatearEncabezado(f,h){
    if(!f) return "";
    const d = new Date(f+"T"+(h||"00:00"));
    let dia = dias[d.getDay()];
    let dd = String(d.getDate()).padStart(2,"0");
    let mes = d.toLocaleString("es-ES",{month:"short"}).toUpperCase();
    mes = mes.replace(".","");
    let hora = h ? h.substring(0,5) : "";
    return `üóìÔ∏è ${dia} ‚Ä¢ ${dd} ${mes} ‚Ä¢ ${hora} h`;
}

/* UTIL: FILTRO 24 HORAS */
function esValida(fecha, hora){
    if(!fecha) return false;
    const now = Date.now();
    const date = new Date(fecha+"T"+(hora||"00:00")).getTime();
    return now <= date + 24*60*60*1000;
}

/* RENDER */
function render(){
    lista.innerHTML = "";

    const visibles = salidas.filter(s => esValida(s.fecha, s.hora));

    if(visibles.length === 0){
        lista.innerHTML = `<div class="empty">No hay salidas pr√≥ximas</div>`;
        return;
    }

    visibles.forEach(s=>{
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
            <div class="encabezado">
                <span>${formatearEncabezado(s.fecha, s.hora)}</span>
                ${rol==="admin" ? `<button class="more-btn" data-id="${s.id}">‚ãØ</button>` : ""}
            </div>

            <div class="separador"></div>

            <div class="item">
                <div class="label">üìç Direcci√≥n</div>
                <div class="value">${s.calle||""} ${s.interseccion ? "‚Äî Esquina "+s.interseccion : ""}</div>
            </div><br>

            <div class="item">
                <div class="label">üöó Conductor</div>
                <div class="value">${s.conductor||"‚Äî"}</div>
            </div><br>

            <div class="item">
                <div class="label">üó∫Ô∏è Territorio</div>
                <div class="value">${s.territorio||"‚Äî"}</div>
            </div><br>

            <div class="item">
                <div class="label">üî≤ Manzanas</div>
                <div class="value">${(s.pendientes||[]).join(", ")}</div>
            </div><br>

            <div class="item">
                <div class="label">üìù Observaciones</div>
                <div class="value">${s.observaciones||"‚Äî"}</div>
            </div>

            ${rol==="admin" ? `
                <div class="menu" id="menu-${s.id}">
                    <button data-action="edit" data-id="${s.id}">‚úé Editar</button>
                    <button data-action="undo" data-id="${s.id}">‚Æå Deshacer</button>
                    <button data-action="delete" data-id="${s.id}" style="color:#b91c1c">üóëÔ∏è Eliminar</button>
                </div>
            ` : ""}
        `;

        lista.appendChild(card);
    });

    if(rol==="admin"){
        document.querySelectorAll(".more-btn").forEach(btn=>{
            btn.onclick = e=>{
                e.stopPropagation();
                toggleMenu(btn.dataset.id);
            };
        });

        document.querySelectorAll(".menu button").forEach(b=>{
            b.onclick = ()=>{
                const id = b.dataset.id;
                const action = b.dataset.action;
                closeMenu();

                if(action==="edit") openEditModal(id);
                if(action==="undo") undoToPendientes(id);
                if(action==="delete") deleteSalida(id);
            };
        });
    }
}

/* MENU */
function toggleMenu(id){
    closeMenu();
    const m = document.getElementById("menu-"+id);
    if(m){ m.style.display="flex"; activeMenuId=id; }
}
function closeMenu(){
    if(activeMenuId){
        const m = document.getElementById("menu-"+activeMenuId);
        if(m) m.style.display="none";
        activeMenuId=null;
    }
}

/* EDITAR */
function openEditModal(id){
    const s = salidas.find(x=>x.id===id);
    if(!s) return;

    editingId = id;

    e_fecha.value = s.fecha || "";
    e_hora.value = s.hora || "";
    e_calle.value = s.calle || "";
    e_inter.value = s.interseccion || "";
    e_territorio.value = s.territorio || "";
    e_manzanas.value = (s.pendientes||[]).join(", ");
    e_conductor.value = s.conductor || "";
    e_obs.value = s.observaciones || "";

    modal.style.display = "flex";
}

cancelEdit.onclick = ()=>{
    modal.style.display="none";
    editingId=null;
};

saveEdit.onclick = async ()=>{
    if(!editingId) return;

    const manArr = e_manzanas.value.trim()
                   ? e_manzanas.value.split(",").map(x=>x.trim()).filter(x=>x)
                   : [];

    await update(dbRef(db,"salidas_asignadas/"+editingId),{
        fecha: e_fecha.value,
        hora: e_hora.value,
        calle: e_calle.value.trim(),
        interseccion: e_inter.value.trim(),
        territorio: e_territorio.value.trim(),
        pendientes: manArr,
        conductor: e_conductor.value.trim(),
        observaciones: e_obs.value.trim()
    });

    modal.style.display="none";
    editingId=null;
};

/* DESHACER */
async function undoToPendientes(id){
    const s = salidas.find(x=>x.id===id);
    if(!s) return;

    await push(pendientesRef,{
        territorio:s.territorio,
        pendientes:s.pendientes||[],
        calle:s.calle||"",
        interseccion:s.interseccion||"",
        observaciones:s.observaciones||""
    });

    await remove(dbRef(db,"salidas_asignadas/"+id));
}

/* ELIMINAR */
async function deleteSalida(id){
    if(confirm("¬øEliminar esta salida?")){
        await remove(dbRef(db,"salidas_asignadas/"+id));
    }
}

/* LOAD REALTIME */
onValue(salidasRef, snap=>{
    const data = snap.val() || {};
    salidas = Object.keys(data).map(id=>({id,...data[id]}));

    salidas.sort((a,b)=>{
        const fa = (a.fecha||"") + " " + (a.hora||"");
        const fb = (b.fecha||"") + " " + (b.hora||"");
        return fa.localeCompare(fb);
    });

    render();
});
</script>

</body>
</html>