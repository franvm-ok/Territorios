<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Próximas salidas</title>

<style>
    body{
        margin:0;
        font-family:Arial, sans-serif;
        background:#f4f4f4;
        color:#333;
    }
    header{
        background:#1a4b27;
        color:white;
        padding:18px;
        font-size:22px;
        text-align:center;
        font-weight:bold;
    }
    .wrap{
        max-width:950px;
        margin:25px auto;
        padding:10px;
    }

    /* Tarjetas compactas tipo bloque */
    .grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
        gap:14px;
    }

    .card{
        background:white;
        border-radius:12px;
        padding:16px;
        box-shadow:0 3px 7px rgba(0,0,0,0.12);
        display:flex;
        flex-direction:column;
        justify-content:space-between;
        border-left:6px solid #1a4b27;
    }

    .card h3{
        margin:0 0 8px 0;
        font-size:18px;
        font-weight:bold;
        color:#1a4b27;
    }

    .info{
        font-size:14px;
        margin-bottom:10px;
        line-height:1.4;
    }

    .tag{
        display:inline-block;
        padding:4px 8px;
        font-size:12px;
        border-radius:8px;
        margin-top:6px;
        background:#e6f4ea;
        color:#1a4b27;
        font-weight:bold;
    }

    .admin-btns{
        margin-top:12px;
        display:flex;
        gap:6px;
    }
    .admin-btns button{
        flex:1;
        padding:6px 0;
        font-size:13px;
        border:none;
        border-radius:6px;
        cursor:pointer;
        color:white;
    }
    .edit{ background:#1565c0; }
    .undo{ background:#6a1b9a; }
    .del{ background:#c62828; }

    /* Ocultar admin por defecto, se muestra si es admin */
    .admin-btns{ display:none; }
</style>
</head>

<body>
<header>Próximas salidas</header>

<div class="wrap">
    <div id="lista" class="grid"></div>
</div>

<script type="module">
import { db, ref as dbRef, onValue, update, remove } from "./firebase.js";

/* ----------------------
   VALIDAR ADMIN
----------------------- */
const sesion = JSON.parse(localStorage.getItem("sesion")) || {};
const esAdmin = sesion.rol === "admin";

/* ----------------------
   ELEMENTOS
----------------------- */
const lista = document.getElementById("lista");
const salidasRef = dbRef(db, "salidas_asignadas");

/* ----------------------
   CARGAR SALIDAS
----------------------- */
onValue(salidasRef, snap => {
    lista.innerHTML = "";

    if (!snap.exists()) {
        lista.innerHTML = "<p>No hay salidas programadas.</p>";
        return;
    }

    const arr = [];

    snap.forEach(child => {
        arr.push({ id: child.key, ...child.val() });
    });

    // Orden: fechas más próximas primero (sin romper nada)
    arr.sort((a,b) => {
        const fa = new Date(`${a.fecha} ${a.hora}`);
        const fb = new Date(`${b.fecha} ${b.hora}`);
        return fa - fb;
    });

    arr.forEach(item => lista.appendChild(renderCard(item)));
});

/* ----------------------
   RENDER TARJETA
----------------------- */
function renderCard(data){
    const div = document.createElement("div");
    div.className = "card";

    const fecha = formatFecha(data.fecha);
    const hora = data.hora || "Sin horario";
    const tipo = data.tipo || "Salida";

    div.innerHTML = `
        <h3>${fecha} • ${hora}</h3>
        <div class="info">
            <strong>Lugar:</strong> ${data.lugar || "Sin lugar"} <br>
            <strong>Notas:</strong> ${data.notas || "Sin notas"}
        </div>

        <span class="tag">${tipo}</span>

        <div class="admin-btns">
            <button class="edit">Editar</button>
            <button class="undo">Deshacer</button>
            <button class="del">Eliminar</button>
        </div>
    `;

    /* Mostrar botones si es admin */
    if (esAdmin) {
        const adminBox = div.querySelector(".admin-btns");
        adminBox.style.display = "flex";

        adminBox.querySelector(".del").onclick = () => {
            if (confirm("¿Eliminar esta salida?")) {
                remove(dbRef(db, `salidas_asignadas/${data.id}`));
            }
        };

        adminBox.querySelector(".undo").onclick = () => {
            update(dbRef(db, `salidas_asignadas/${data.id}`), { estado: "pendiente" });
        };

        adminBox.querySelector(".edit").onclick = () => {
            const nuevoLugar = prompt("Nuevo lugar:", data.lugar || "");
            if (nuevoLugar !== null) {
                update(dbRef(db, `salidas_asignadas/${data.id}`), { lugar: nuevoLugar });
            }
        };
    }

    return div;
}

/* ----------------------
   FORMATEAR FECHA LINDO
----------------------- */
function formatFecha(f){
    const d = new Date(f);
    if (isNaN(d.getTime())) return f;

    const dias = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
    const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

    return `${dias[d.getDay()]} ${d.getDate()} ${meses[d.getMonth()]}`;
}
</script>

</body>
</html>