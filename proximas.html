<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PrÃ³ximas Salidas</title>

<style>
:root{--verde:#1a4b27;--bg:#f4f4f4}
body{margin:0;font-family:Arial;background:var(--bg)}
header{background:var(--verde);color:white;padding:18px;text-align:center;font-size:20px}
.container{max-width:900px;margin:auto;padding:15px}

.card{
  background:white;
  padding:16px;
  border-radius:14px;
  margin-bottom:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
  border-left:8px solid var(--verde);
}

.fecha{
  font-size:22px;
  font-weight:bold;
  margin-bottom:6px;
}

.linea{
  font-size:17px;
  margin:4px 0;
}

.back{
  position:fixed;
  bottom:15px;
  left:15px;
  background:var(--verde);
  color:white;
  border:none;
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>ğŸ“… PrÃ³ximas Salidas</header>

<div class="container" id="lista"></div>

<button class="back" onclick="location.href='index.html'">â¬… Inicio</button>

<script type="module">
import { db, ref as dbRef, onValue } from "./firebase.js";

const lista = document.getElementById("lista");
const salidasRef = dbRef(db,"salidas_asignadas");

/* =========================
   FORMATEAR FECHA
========================= */
const formatearFecha = fecha =>
  new Date(fecha).toLocaleDateString("es-AR", {
    weekday: "long",
    day: "numeric",
    month: "long"
  }).toUpperCase();

/* =========================
   TIMESTAMP
========================= */
function timestamp(fecha,hora){
  const [h,m] = hora.split(":");
  const d = new Date(fecha);
  d.setHours(h,m,0,0);
  return d.getTime();
}

/* =========================
   ESCUCHAR FIREBASE
========================= */
onValue(salidasRef, snap => {

  lista.innerHTML="";

  if(!snap.exists()){
    lista.innerHTML="<p align='center'>No hay salidas asignadas</p>";
    return;
  }

  let salidas = [];

  snap.forEach(x=>{
    const o = x.val();
    const ts = timestamp(o.fecha,o.hora);

    salidas.push({
      ...o,
      ts: ts
    });
  });

  /* =========================
     ORDENAR
  ========================= */
  salidas.sort((a,b)=>a.ts - b.ts);

  /* =========================
     FILTRAR FUTURAS
  ========================= */
  salidas = salidas.filter(o => o.ts >= Date.now() - 60000);

  if(salidas.length === 0){
    lista.innerHTML="<p align='center'>No hay salidas futuras</p>";
    return;
  }

  /* =========================
     RENDER TARJETAS
  ========================= */
  salidas.forEach(o=>{

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <div class="fecha">ğŸ•’ ${formatearFecha(o.fecha)} - ${o.hora}</div>
      <div class="linea">ğŸ“ Territorio: <b>${o.territorio}</b></div>
      <div class="linea">ğŸ‘¤ Conductor: ${o.conductor}</div>
      <div class="linea">ğŸ“Œ DirecciÃ³n: ${o.calle} y ${o.interseccion}</div>
      <div class="linea">ğŸ§± Faltan: ${(o.pendientes || []).join(", ") || "Nadie"}</div>
      ${o.observaciones ? `<div class="linea">âœ ${o.observaciones}</div>` : ""}
    `;

    lista.appendChild(card);

  });

});
</script>

</body>
</html>