<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PrÃ³ximas salidas</title>

<style>
:root{
  --verde:#1a4b27;
  --bg:#f4f4f4;
  --card:#ffffff;
  --muted:#666;
  --radius:14px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:#222;
}

header{
  background:var(--verde);
  color:#fff;
  text-align:center;
  padding:16px;
  font-size:20px;
  font-weight:700;
}

.container{
  max-width:1100px;
  margin:14px auto;
  padding:12px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:14px;
}

/* ---------- TARJETA ---------- */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* FECHA PRIORIDAD */
.fecha{
  background:#eef6f0;
  border-radius:12px;
  padding:10px;
  text-align:center;
  font-size:18px;
  font-weight:700;
  color:var(--verde);
}

/* DATOS */
.dato{
  font-size:15px;
}
.muted{color:var(--muted)}

/* BOTONES ADMIN */
.admin-actions{
  display:flex;
  gap:8px;
  margin-top:6px;
}
.admin-actions button{
  flex:1;
  border:none;
  border-radius:10px;
  padding:10px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
}
.edit{background:#1976d2;color:#fff}
.undo{background:#f9a825;color:#222}
.del{background:#c62828;color:#fff}

/* BACK */
.back{
  position:fixed;
  left:14px;
  bottom:18px;
  background:#fff;
  color:var(--verde);
  border:1px solid #e6e6e6;
  padding:10px 14px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,0.08);
}
</style>
</head>

<body>

<header>ğŸ“… PrÃ³ximas salidas</header>

<div class="container" id="lista">Cargandoâ€¦</div>

<button class="back" onclick="location.href='index.html'">â¬… Volver</button>

<script type="module">
import { db, ref as dbRef, onValue, remove, push } from "./firebase.js";

/* -------- SESIÃ“N -------- */
const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
const esAdmin = (sesion.rol || "").toLowerCase() === "admin";

/* -------- REFS -------- */
const lista = document.getElementById("lista");
const salidasRef = dbRef(db,"salidas_asignadas");
const pendientesRef = dbRef(db,"pendientes");

/* -------- FECHAS -------- */
const dias = ["Dom","Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b"];
const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

function formatFecha(fecha,hora){
  const d = new Date(fecha+"T"+hora);
  return `${dias[d.getDay()]} - ${d.getDate()} ${meses[d.getMonth()]} - ${hora} hs`;
}

/* -------- RENDER -------- */
onValue(salidasRef, snap=>{
  lista.innerHTML = "";
  const ahora = Date.now();

  let arr = [];
  snap.forEach(x=>{
    const o = x.val();
    o.id = x.key;
    arr.push(o);
  });

  arr.sort((a,b)=> new Date(a.fecha+"T"+a.hora) - new Date(b.fecha+"T"+b.hora));

  arr.forEach(salida=>{
    const fechaHora = new Date(salida.fecha+"T"+salida.hora).getTime();

    // eliminar automÃ¡ticamente si pasaron 24hs
    if(ahora - fechaHora > 24*60*60*1000){
      remove(dbRef(db,"salidas_asignadas/"+salida.id));
      return;
    }

    const card = document.createElement("div");
    card.className="card";

    card.innerHTML = `
      <div class="fecha">ğŸ“† ${formatFecha(salida.fecha,salida.hora)}</div>

      <div class="dato">ğŸ“ <strong>${salida.calle_inter || "â€”"}</strong></div>
      <div class="dato">ğŸ§± Territorio: <strong>${salida.territorio || "â€”"}</strong></div>
      <div class="dato">ğŸ§© Manzanas: ${Array.isArray(salida.pendientes) ? salida.pendientes.join(", ") : "â€”"}</div>
      <div class="dato">ğŸ‘¤ Conductor: ${salida.conductor || "â€”"}</div>
      ${salida.observaciones ? `<div class="dato muted">ğŸ“ ${salida.observaciones}</div>` : "" }
    `;

    if(esAdmin){
      const acciones = document.createElement("div");
      acciones.className="admin-actions";

      acciones.innerHTML = `
        <button class="edit">âœï¸ Editar</button>
        <button class="undo">â†©ï¸ Deshacer</button>
        <button class="del">ğŸ—‘ Eliminar</button>
      `;

      acciones.children[1].onclick = ()=>{
        if(confirm("Â¿Seguro que desea deshacer esta salida?")){
          push(pendientesRef,{
            territorio: salida.territorio,
            pendientes: salida.pendientes || [],
            conductor: salida.conductor || ""
          });
          remove(dbRef(db,"salidas_asignadas/"+salida.id));
        }
      };

      acciones.children[2].onclick = ()=>{
        if(confirm("Â¿Seguro que desea eliminar esta salida?")){
          remove(dbRef(db,"salidas_asignadas/"+salida.id));
        }
      };

      card.appendChild(acciones);
    }

    lista.appendChild(card);
  });

  if(!lista.children.length){
    lista.innerHTML = `<div class="card"><strong>No hay salidas prÃ³ximas</strong></div>`;
  }
});
</script>

</body>
</html>