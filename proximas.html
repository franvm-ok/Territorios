<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pr√≥ximas Salidas</title>

<style>
    body{
        margin:0;background:#f0f0f5;font-family:Arial, sans-serif;
    }
    header{
        background:#2e7d32;color:white;padding:18px;font-size:22px;
        text-align:center;font-weight:bold;
    }
    #lista{
        padding:14px;
        display:flex;
        flex-direction:column;
        gap:14px;
    }

    /* TARJETA COMPACTA */
    .card{
        background:#ffffff;
        border-radius:14px;
        padding:14px 16px;
        box-shadow:0 3px 8px rgba(0,0,0,0.15);
        font-size:16px;
        line-height:1.4;
        border-left:6px solid #2e7d32;
    }

    .fecha-line{
        font-size:18px;
        font-weight:bold;
        color:#1b5e20;
        margin-bottom:10px;
        text-align:center;
    }

    .row{
        display:flex;
        justify-content:space-between;
        margin-bottom:6px;
    }

    .row div{
        flex:1;
    }

    .label{
        font-size:14px;
        font-weight:bold;
        color:#333;
    }

    .value{
        font-size:16px;
        color:#111;
    }

    .observaciones{
        margin-top:8px;
        font-size:15px;
        color:#222;
        background:#f4f4f8;
        padding:6px 10px;
        border-radius:8px;
    }

    .more-btn{
        border:none;background:none;font-size:20px;
        cursor:pointer;padding:4px;color:#333;
    }

    .menu{
        display:none;
        flex-direction:column;
        margin-top:8px;
        border-top:1px solid #ddd;
        padding-top:6px;
        gap:4px;
    }
    .menu button{
        background:#e0e0e0;border:none;padding:8px;
        border-radius:6px;font-size:14px;text-align:left;cursor:pointer;
    }

    .empty{
        padding:28px;text-align:center;color:#555;font-size:17px;
    }

    /* MODAL */
    #modal{
        display:none;position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.55);justify-content:center;align-items:center;
        padding:20px;z-index:20;
    }
    .modal-box{
        background:white;padding:20px;border-radius:12px;width:100%;
        max-width:420px;display:flex;flex-direction:column;gap:12px;
    }
    .modal-box input, .modal-box textarea{
        width:100%;padding:10px;border:1px solid #ccc;
        border-radius:8px;font-size:16px;
    }
    .modal-btns{
        display:flex;gap:10px;margin-top:8px;
    }
    .modal-btns button{
        flex:1;padding:12px;font-size:16px;border:none;border-radius:8px;
        cursor:pointer;font-weight:bold;
    }
    .save{ background:#2e7d32;color:white; }
    .cancel{ background:#ccc; }
</style>
</head>

<body>

<header>Pr√≥ximas Salidas</header>

<div id="lista"></div>

<!-- MODAL -->
<div id="modal">
    <div class="modal-box">
        <h3>Editar salida</h3>

        <input id="e_fecha" type="date">
        <input id="e_hora" type="time">
        <input id="e_calle" placeholder="Calle">
        <input id="e_inter" placeholder="Intersecci√≥n">
        <input id="e_territorio" placeholder="Territorio">
        <input id="e_manzanas" placeholder="Manzanas separadas por coma">
        <input id="e_conductor" placeholder="Conductor">
        <textarea id="e_obs" rows="2" placeholder="Observaciones"></textarea>

        <div class="modal-btns">
            <button id="cancelEdit" class="cancel">Cancelar</button>
            <button id="saveEdit" class="save">Guardar</button>
        </div>
    </div>
</div>

<script type="module">
import { db, ref as dbRef, onValue, update, remove, push } from "./firebase.js";

const lista = document.getElementById("lista");
const salidasRef = dbRef(db, "salidas_asignadas");
const pendientesRef = dbRef(db, "pendientes");

const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
let rol = (sesion.rol || "invitado").toLowerCase();
if (rol === "invitado") rol = "conductor";

const modal = document.getElementById("modal");
const e_territorio = document.getElementById("e_territorio");
const e_manzanas = document.getElementById("e_manzanas");
const e_conductor = document.getElementById("e_conductor");
const e_fecha = document.getElementById("e_fecha");
const e_hora = document.getElementById("e_hora");
const e_calle = document.getElementById("e_calle");
const e_inter = document.getElementById("e_inter");
const e_obs = document.getElementById("e_obs");

const saveEdit = document.getElementById("saveEdit");
const cancelEdit = document.getElementById("cancelEdit");

let salidas = [];
let activeMenuId = null;
let editingId = null;

/* FORMATEO FECHA */
function ddmmaa(fechaISO){
    if(!fechaISO) return "";
    const f = new Date(fechaISO);
    const dias = ["DOM","LUN","MAR","MI√â","JUE","VIE","S√ÅB"];
    const dia = dias[f.getDay()];
    const [y,m,d] = fechaISO.split("-");
    return {dia, texto:`${dia} ‚Ä¢ ${d} ${mesCorto(m)} ‚Ä¢`};
}
function mesCorto(m){
    return ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"][Number(m)-1];
}

/* FILTRAR SALIDAS PASADAS (>24H) */
function esValida(fecha, hora){
    if(!fecha || !hora) return true;
    const dt = new Date(`${fecha}T${hora}:00`);
    return (Date.now() - dt.getTime()) <= 24*60*60*1000;
}

/* RENDER */
function render(){
    lista.innerHTML = "";
    const futuras = salidas.filter(s => esValida(s.fecha, s.hora));

    if(futuras.length === 0){
        lista.innerHTML = `<div class="empty">No hay salidas</div>`;
        return;
    }

    futuras.forEach(s=>{
        const f = ddmmaa(s.fecha || "");
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
            <div class="fecha-line">üóìÔ∏è ${f.texto} ${s.hora||""} h</div>

            <div class="row">
                <div><span class="label">üìç Direcci√≥n</span>
                     <div class="value">${s.calle||""} ${s.interseccion? "‚Äî " + s.interseccion : ""}</div>
                </div>
                <div><span class="label">üöó Conductor</span>
                     <div class="value">${s.conductor||"‚Äî"}</div>
                </div>
            </div>

            <div class="row">
                <div><span class="label">üó∫Ô∏è Territorio</span>
                     <div class="value">${s.territorio||"‚Äî"}</div>
                </div>
                <div><span class="label">üî≤ Manzanas</span>
                     <div class="value">${(s.pendientes||[]).join(", ")}</div>
                </div>
            </div>

            <div class="observaciones"><span class="label">üìù Observaciones</span>
                <div class="value">${s.observaciones||"‚Äî"}</div>
            </div>

            ${rol==="admin" ? `
                <div class="menu" id="menu-${s.id}">
                    <button data-action="edit" data-id="${s.id}">‚úé Editar</button>
                    <button data-action="undo" data-id="${s.id}">‚Æå Deshacer</button>
                    <button data-action="delete" data-id="${s.id}" style="color:#b91c1c">üóëÔ∏è Eliminar</button>
                </div>
            ` : ""}
        `;
        lista.appendChild(card);
    });

    if(rol==="admin"){
        document.querySelectorAll(".more-btn").forEach(btn=>{
            btn.onclick = e=>{
                e.stopPropagation();
                toggleMenu(btn.dataset.id);
            };
        });
        document.querySelectorAll(".menu button").forEach(b=>{
            b.onclick = ()=>{
                const id = b.dataset.id;
                const action = b.dataset.action;
                closeMenu();
                if(action==="edit") openEditModal(id);
                if(action==="undo") undoToPendientes(id);
                if(action==="delete") deleteSalida(id);
            };
        });
    }
}

/* MENU */
function toggleMenu(id){
    closeMenu();
    const m = document.getElementById("menu-"+id);
    if(m){ m.style.display="flex"; activeMenuId=id; }
}
function closeMenu(){
    if(activeMenuId){
        const m = document.getElementById("menu-"+activeMenuId);
        if(m) m.style.display="none";
        activeMenuId=null;
    }
}

/* EDITAR */
function openEditModal(id){
    const s = salidas.find(x=>x.id===id);
    if(!s) return;
    editingId = id;
    e_fecha.value = s.fecha || "";
    e_hora.value = s.hora || "";
    e_calle.value = s.calle || "";
    e_inter.value = s.interseccion || "";
    e_territorio.value = s.territorio || "";
    e_manzanas.value = (s.pendientes||[]).join(", ");
    e_conductor.value = s.conductor || "";
    e_obs.value = s.observaciones || "";
    modal.style.display = "flex";
}

cancelEdit.onclick = ()=>{
    modal.style.display="none";
    editingId=null;
};

saveEdit.onclick = async ()=>{
    if(!editingId) return;
    const manArr = e_manzanas.value.trim()
                   ? e_manzanas.value.split(",").map(x=>x.trim()).filter(x=>x)
                   : [];
    await update(dbRef(db,"salidas_asignadas/"+editingId),{
        fecha: e_fecha.value,
        hora: e_hora.value,
        calle: e_calle.value.trim(),
        interseccion: e_inter.value.trim(),
        territorio: e_territorio.value.trim(),
        pendientes: manArr,
        conductor: e_conductor.value.trim(),
        observaciones: e_obs.value.trim()
    });
    modal.style.display="none";
    editingId=null;
};

/* DESHACER */
async function undoToPendientes(id){
    const s = salidas.find(x=>x.id===id);
    if(!s) return;
    await push(pendientesRef,{
        territorio:s.territorio,
        pendientes:s.pendientes||[],
        calle:s.calle||"",
        interseccion:s.interseccion||"",
        observaciones:s.observaciones||""
    });
    await remove(dbRef(db,"salidas_asignadas/"+id));
}

/* ELIMINAR */
async function deleteSalida(id){
    if(confirm("¬øEliminar esta salida?")){
        await remove(dbRef(db,"salidas_asignadas/"+id));
    }
}

/* REALTIME LOAD */
onValue(salidasRef, snap=>{
    const data = snap.val() || {};
    salidas = Object.keys(data).map(id=>({id,...data[id]}));
    salidas.sort((a,b)=>{
        const fa = (a.fecha||"") + " " + (a.hora||"");
        const fb = (b.fecha||"") + " " + (b.hora||"");
        return fa.localeCompare(fb);
    });
    render();
});
</script>

</body>
</html>