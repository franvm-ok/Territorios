<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pr√≥ximas Salidas</title>

<style>
    :root{
      --verde:#1a4b27;
      --bg:#f2f2f7;
      --card:#fff;
      --muted:#666;
      --radius:14px;
      --text-lg:18px;
      --text-md:16px;
      --btn-height:46px;
    }

    *{box-sizing:border-box}
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Arial; background:var(--bg); color:#222; -webkit-font-smoothing:antialiased; }

    header{
      background:var(--verde);
      color:#fff;
      padding:16px;
      text-align:center;
      font-size:22px;
      font-weight:700;
    }

    .container{
      padding: 16px;
      max-width: 700px;
      margin: auto;
    }

    /* Tarjeta */
    .card {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .fecha-principal {
      font-size: 20px;
      font-weight: 700;
      color: #1a4b27;
      margin-bottom: 10px;
      text-align: center;
    }

    .info {
      font-size: 17px;
      line-height: 1.4;
      margin-bottom: 12px;
    }

    .label {
      font-weight: 600;
      color: #444;
    }

    /* Botones de acci√≥n */
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      flex: 1;
      justify-content: center;
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    .editar { background: #e8f0fe; color:#0b3a8f; }
    .deshacer { background: #fff4d8; color:#8a5a00; }
    .eliminar { background: #fde4e4; color:#a10000; }

    /* hidden for non-admin */
    .admin-only { display: none; }

    /* bottom sheet modal (edici√≥n) */
    .sheet-bg {
      position: fixed; inset:0; display:none; align-items:flex-end;
      background: rgba(0,0,0,0.32); padding:12px; z-index:1200;
    }
    .sheet {
      width:100%; max-width:680px;
      background:#fff; border-radius:16px 16px 8px 8px;
      box-shadow:0 -6px 30px rgba(0,0,0,0.18);
      padding:16px;
      transform: translateY(0);
      max-height:86vh;
      overflow:auto;
    }
    .sheet .grab { width:56px;height:6px;background:#e5e5ea;border-radius:6px;margin:6px auto 12px auto; }

    .sheet h3 { margin:0 0 10px 0; text-align:center; font-size:18px; color:var(--verde); font-weight:800; }

    .form-row { display:flex; gap:10px; }
    .form-row .col { flex:1; }

    label { display:block; font-weight:700; margin-bottom:6px; color:#333; font-size:14px; }
    input[type="text"], input[type="date"], input[type="time"], textarea {
      width:100%; padding:10px; font-size:16px; border-radius:10px; border:1px solid #ddd; background:#fafafa;
    }
    textarea { min-height:80px; resize:vertical; }

    .sheet-buttons { display:flex; gap:10px; margin-top:12px; }
    .sheet-btn { flex:1; padding:12px; border-radius:10px; font-size:16px; cursor:pointer; text-align:center; }
    .sheet-cancel { background:#e6e6e6; color:#222; border:none; }
    .sheet-save { background:var(--verde); color:white; border:none; }

    /* responsive */
    @media (max-width:720px) {
      .info-item { flex-basis:100%; }
      .btn { flex-basis:48%; }
      .form-row { flex-direction:column; }
      .container { padding:12px; }
    }
</style>
</head>

<body>

<header>Pr√≥ximas salidas</header>

<div class="container" id="lista">

    <!-- Tarjetas generadas din√°micamente desde JS / Firebase -->

</div>

<!-- Modal edici√≥n -->
<div class="sheet-bg" id="modalEditar">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="grab" aria-hidden="true"></div>
      <h3 id="sheetTitle">Editar salida</h3>

      <div class="group">
        <label for="fTerritorio">Territorio</label>
        <input id="fTerritorio" type="text" placeholder="Ej: 12A">
      </div>

      <div class="group">
        <label for="fManzana">Manzanas (separadas por coma)</label>
        <input id="fManzana" type="text" placeholder="Ej: 1, 2, 3">
      </div>

      <div class="group">
        <label for="fConductor">Conductor</label>
        <input id="fConductor" type="text" placeholder="Nombre conductor">
      </div>

      <div class="form-row" style="margin-top:6px;">
        <div class="col">
          <label for="fFecha">Fecha</label>
          <input id="fFecha" type="date">
        </div>
        <div class="col">
          <label for="fHora">Hora</label>
          <input id="fHora" type="time">
        </div>
      </div>

      <div class="group">
        <label for="fDireccion">Calle / Intersecci√≥n</label>
        <input id="fDireccion" type="text" placeholder="Ej: Eva Per√≥n 1234 - Mendoza">
      </div>

      <div class="group">
        <label for="fObs">Observaciones</label>
        <textarea id="fObs" placeholder="Notas..."></textarea>
      </div>

      <div class="sheet-buttons">
        <button class="sheet-btn sheet-cancel" id="sheetCancel">Cancelar</button>
        <button class="sheet-btn sheet-save" id="sheetSave">Guardar</button>
      </div>
    </div>
</div>

<script type="module">
/* =========== IMPORT FIREBASE =========== */
import { db, ref as dbRef, onValue, update, remove, push } from "./firebase.js";

/* =========== ELEMENTS =========== */
const lista = document.getElementById("lista");
const sheetBg = document.getElementById("sheetBg");
const sheetCancel = document.getElementById("sheetCancel");
const sheetSave = document.getElementById("sheetSave");

const fTerritorio = document.getElementById("fTerritorio");
const fManzana = document.getElementById("fManzana");
const fConductor = document.getElementById("fConductor");
const fFecha = document.getElementById("fFecha");
const fHora = document.getElementById("fHora");
const fDireccion = document.getElementById("fDireccion");
const fObs = document.getElementById("fObs");

const salidasRef = dbRef(db, "salidas_asignadas");
const pendientesRef = dbRef(db, "pendientes");

/* =========== ROLE (admin visibility) =========== */
const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
let rol = (sesion.rol || "invitado").toLowerCase();
if (rol === "invitado") rol = "conductor";
const isAdmin = (rol === 'admin');

/* =========== HELPERS =========== */
const MS_DAY = 24*60*60*1000;

function diaAbrev(dateObj){
  const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  return dias[dateObj.getDay()];
}
function mesAbrev(numMonth){
  return ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][numMonth];
}
function formatDisplay(fechaISO, hora){
  try{
    if(!fechaISO) return '';
    const [y,m,d] = fechaISO.split('-').map(x=>Number(x));
    const dt = new Date(y,m-1,Number(fechaISO.split('-')[2]||d));
    // If hora exists parse
    let hhmm = '';
    if(hora){
      // ensure format HH:MM
      hhmm = hora.length>=5 ? hora.slice(0,5) : hora;
    }
    const dia = diaAbrev(dt);
    const diaNum = Number(fechaISO.split('-')[2]) || dt.getDate();
    const mes = mesAbrev(dt.getMonth());
    return `${dia} - ${diaNum} ${mes} - ${hhmm} hs`;
  }catch(e){
    return `${fechaISO} ${hora || ''}`;
  }
}
function parseDateTime(fecha, hora){
  if(!fecha) return null;
  // build local date time
  const iso = `${fecha}T${(hora||'00:00')}:00`;
  const d = new Date(iso);
  if(isNaN(d.getTime())) return null;
  return d;
}

/* =========== CLEANUP EXPIRED (option A: delete >24h) =========== */
async function cleanupExpired(snapshotObj){
  const now = Date.now();
  const items = [];
  snapshotObj.forEach(child=>{
    const id = child.key;
    const data = child.val();
    items.push({id, ...data});
  });
  for(const s of items){
    const dt = parseDateTime(s.fecha, s.hora);
    if(dt){
      if(now - dt.getTime() > MS_DAY){
        // delete expired
        try{
          await remove(dbRef(db, 'salidas_asignadas/' + s.id));
        }catch(e){ console.warn('cleanup remove failed', e); }
      }
    }
  }
}

/* =========== RENDER =========== */
function renderList(snapshot){
  // collect items then sort
  const arr = [];
  snapshot.forEach(child=>{
    const id = child.key;
    const data = child.val();
    arr.push({ id, ...data });
  });

  // filter out expired <=24h (we also delete in cleanupExpired)
  const now = Date.now();
  const valids = arr.filter(s=>{
    const dt = parseDateTime(s.fecha, s.hora);
    if(!dt) return true; // keep if no date/time
    return (now - dt.getTime()) <= MS_DAY;
  });

  // sort by date+hora ascending
  valids.sort((a,b)=>{
    const da = parseDateTime(a.fecha, a.hora) || new Date(0);
    const db = parseDateTime(b.fecha, b.hora) || new Date(0);
    return da.getTime() - db.getTime();
  });

  // render
  lista.innerHTML = '';
  if(valids.length === 0){
    lista.innerHTML = `<div style="text-align:center;padding:30px;color:var(--muted);font-size:18px">No hay salidas pr√≥ximas</div>`;
    return;
  }

  valids.forEach(s=>{
    const card = document.createElement('article');
    card.className = 'card';

    const fechaText = formatDisplay(s.fecha, s.hora);

    // address: prefer 'direccion' (single field). fallback to calle + interseccion or calle_inter
    const direccion = s.direccion || s.calle_inter || ((s.calle || '') + (s.interseccion ? ' - ' + s.interseccion : ''));

    card.innerHTML = `
      <div class="fecha-principal">${fechaText}</div>

      <div class="info-row">
        <div class="info-item">
          <div class="label">Direcci√≥n</div>
          <div class="direccion-box">${direccion || '‚Äî'}</div>
        </div>

        <div class="info-item">
          <div class="label">Territorio</div>
          <div>${s.territorio || '‚Äî'}</div>
        </div>
      </div>

      <div class="info-row">
        <div class="info-item">
          <div class="label">Manzanas</div>
          <div>${ (Array.isArray(s.pendientes) ? s.pendientes.join(', ') : (s.manzana || '‚Äî')) }</div>
        </div>

        <div class="info-item">
          <div class="label">Conductor</div>
          <div>${s.conductor || '‚Äî'}</div>
        </div>
      </div>

      <div class="observaciones"><span class="label">Observaciones</span><div style="margin-top:6px">${s.observaciones || '‚Äî'}</div></div>

      <div class="actions">
        ${ isAdmin ? `<button class="btn btn-edit" data-id="${s.id}" data-action="edit"><span class="icon">‚úèÔ∏è</span> Editar</button>` : '' }
        ${ isAdmin ? `<button class="btn btn-undo" data-id="${s.id}" data-action="undo"><span class="icon">‚Ü©Ô∏è</span> Deshacer</button>` : '' }
        ${ isAdmin ? `<button class="btn btn-delete" data-id="${s.id}" data-action="delete"><span class="icon">üóëÔ∏è</span> Eliminar</button>` : '' }
      </div>
    `;

    lista.appendChild(card);
  });

  // attach listeners for admin buttons (delegation)
  if(isAdmin){
    lista.querySelectorAll('button[data-action]').forEach(btn=>{
      btn.onclick = (e)=>{
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if(action === 'edit') openEdit(id);
        if(action === 'undo') confirmUndo(id);
        if(action === 'delete') confirmDelete(id);
      };
    });
  }
}

/* =========== ACTIONS =========== */
function openEdit(id){
  const ref = dbRef(db, 'salidas_asignadas/' + id);
  // get once
  onValue(ref, snap=>{
    const d = snap.val() || {};
    fTerritorio.value = d.territorio || '';
    // manzanas may be stored as pendientes array or manzana string
    fManzana.value = Array.isArray(d.pendientes) ? d.pendientes.join(', ') : (d.manzana || '');
    fConductor.value = d.conductor || '';
    fFecha.value = d.fecha || '';
    fHora.value = d.hora || '';
    fDireccion.value = d.direccion || d.calle_inter || ((d.calle||'') + (d.interseccion ? ' - '+d.interseccion : ''));
    fObs.value = d.observaciones || '';
    editTargetId = id;
    sheetBg.style.display = 'flex';
  }, { onlyOnce:true });
}

let editTargetId = null;

sheetCancel.onclick = ()=>{
  sheetBg.style.display = 'none';
  editTargetId = null;
};

sheetSave.onclick = async ()=>{
  if(!editTargetId) return;
  const manArr = fManzana.value.trim() ? fManzana.value.split(',').map(x=>x.trim()).filter(Boolean) : [];
  const payload = {
    territorio: fTerritorio.value.trim(),
    pendientes: manArr,
    manzana: fManzana.value.trim(),
    conductor: fConductor.value.trim(),
    fecha: fFecha.value,
    hora: fHora.value,
    direccion: fDireccion.value.trim(),
    observaciones: fObs.value.trim()
  };
  try{
    await update(dbRef(db, 'salidas_asignadas/' + editTargetId), payload);
  }catch(e){
    console.error('save failed', e);
  }
  sheetBg.style.display = 'none';
  editTargetId = null;
};

/* confirm dialogs */
function confirmUndo(id){
  if(!confirm('¬øDesea deshacer esta salida y volverla a pendientes?')) return;
  doUndo(id);
}
async function doUndo(id){
  const ref = dbRef(db, 'salidas_asignadas/' + id);
  onValue(ref, async snap=>{
    const d = snap.val();
    if(!d) return;
    // prepare pending object: keep same fields that pendientes expects
    const pendingObj = {
      territorio: d.territorio || '',
      pendientes: Array.isArray(d.pendientes) ? d.pendientes : (d.manzana ? d.manzana.split(',').map(x=>x.trim()) : []),
      conductor: d.conductor || '',
      calle_inter: d.direccion || d.calle_inter || ((d.calle||'') + (d.interseccion ? ' - '+d.interseccion : '')),
      observaciones: d.observaciones || ''
    };
    try{
      await push(pendientesRef, pendingObj);
      await remove(ref);
    }catch(e){ console.error('undo failed', e); }
  }, { onlyOnce:true });
}

function confirmDelete(id){
  if(!confirm('¬øDesea eliminar esta salida de forma permanente?')) return;
  doDelete(id);
}
async function doDelete(id){
  try{
    await remove(dbRef(db, 'salidas_asignadas/' + id));
  }catch(e){ console.error('delete failed', e); }
}

/* =========== INITIAL LISTENER =========== */
onValue(salidasRef, async snap=>{
  // first cleanup expired (option A)
  await cleanupExpired(snap);
  // then render list (snap will refresh after deletions maybe)
  renderList(snap);
});
</script>

</body>
</html>