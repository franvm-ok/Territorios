<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PrÃ³ximas salidas</title>
<link rel="stylesheet" href="styles.css"/>
<style>
  body{margin:0;font-family:Arial;background:#f4f4f4;color:#333;}

  header{
    background:#1a4b27;
    color:#fff;
    padding:18px;
    text-align:center;
    font-weight:700;
    font-size:22px;
    position:sticky;
    top:0;
    z-index:10;
  }

  .contenedor{
    max-width:900px;
    margin:auto;
    padding:16px;
  }

  .card{
    background:#fff;
    border-radius:16px;
    padding:18px 20px;
    margin-bottom:16px;
    box-shadow:0 4px 14px rgba(0,0,0,0.09);
    position:relative;
  }

  .card-title{
    text-align:center;
    font-size:19px;
    font-weight:700;
    margin-bottom:14px;
    color:#1a4b27;
  }

  .fila{
    display:flex;
    justify-content:space-between;
    margin-bottom:6px;
    font-size:15px;
  }

  .label{
    font-weight:700;
    color:#1a4b27;
  }

  .obs{
    margin-top:10px;
    font-size:14px;
    background:#f5f5f5;
    padding:10px;
    border-radius:12px;
    line-height:1.4;
  }

  .menu-btn{
    position:absolute;
    top:10px;
    right:12px;
    font-size:24px;
    cursor:pointer;
    user-select:none;
  }

  .admin-menu{
    position:absolute;
    top:40px;
    right:10px;
    background:white;
    box-shadow:0 4px 10px rgba(0,0,0,0.12);
    border-radius:10px;
    overflow:hidden;
    display:none;
    z-index:20;
  }

  .admin-menu button{
    width:100%;
    padding:12px 16px;
    border:none;
    background:white;
    text-align:left;
    font-size:14px;
    cursor:pointer;
  }

  .admin-menu button:hover{
    background:#f0f0f0;
  }

  /* Modal */
  .modal{
    position:fixed;
    left:0;top:0;width:100%;height:100%;
    background:rgba(0,0,0,0.6);
    display:none;
    justify-content:center;
    align-items:center;
    padding:20px;
    z-index:100;
  }

  .modal-content{
    background:#fff;
    width:100%;
    max-width:420px;
    padding:20px;
    border-radius:18px;
    box-shadow:0 4px 16px rgba(0,0,0,0.25);
  }

  .modal-content h3{
    margin-top:0;
    color:#1a4b27;
    text-align:center;
  }

  .modal-content input, .modal-content textarea{
    width:100%;
    margin-top:8px;
    margin-bottom:14px;
    padding:12px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:15px;
    box-sizing:border-box;
  }

  .modal-actions{
    display:flex;
    justify-content:space-between;
  }

  .btn{
    padding:12px 18px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
  }

  .btn-guardar{background:#1a4b27;color:#fff;}
  .btn-cancelar{background:#ccc;}

</style>
</head>
<body>

<header>PrÃ³ximas salidas</header>

<div class="contenedor" id="lista"></div>

<!-- MODAL EDITAR -->
<div class="modal" id="modalEditar">
  <div class="modal-content">
    <h3>Editar salida</h3>

    <label>Territorio</label>
    <input id="editTerritorio"/>

    <label>Manzanas</label>
    <input id="editManzanas"/>

    <label>Conductor</label>
    <input id="editConductor"/>

    <label>Fecha</label>
    <input type="date" id="editFecha"/>

    <label>Hora</label>
    <input type="time" id="editHora"/>

    <label>Calle / IntersecciÃ³n</label>
    <input id="editDireccion"/>

    <label>Observaciones</label>
    <textarea id="editObs" rows="3"></textarea>

    <div class="modal-actions">
      <button class="btn btn-cancelar" id="cancelarEdicion">Cancelar</button>
      <button class="btn btn-guardar" id="guardarEdicion">Guardar</button>
    </div>
  </div>
</div>

<script type="module">
import { db, ref, onValue, update, remove, push } from "./firebase.js";

const lista = document.getElementById("lista");
const modal = document.getElementById("modalEditar");

let salidaActualId = null;

const rol = localStorage.getItem("rol");  // admin / conductor / invitado

const salidasRef = ref(db, "salidas_asignadas");
const pendientesRef = ref(db, "pendientes");

/* ============================
   CARGAR LISTA
============================ */
onValue(salidasRef, snap => {
  lista.innerHTML = "";
  const datos = snap.val();

  if(!datos) return;

  const arr = Object.entries(datos).map(([id, obj]) => ({id, ...obj}));

  // Orden por fecha/hora
  arr.sort((a,b)=> new Date(a.fechaHora) - new Date(b.fechaHora));

  const ahora = Date.now();

  arr.forEach(salida => {
    const fechaSalida = new Date(salida.fechaHora).getTime();
    const diferencia = ahora - fechaSalida;

    // borrar las que pasaron 24h
    if(diferencia > 24 * 60 * 60 * 1000){
      remove(ref(db, "salidas_asignadas/" + salida.id));
      return;
    }

    const fecha = new Date(salida.fechaHora);

    const dia = fecha.toLocaleDateString('es-AR',{weekday:"short"});
    const fechaTxt = fecha.toLocaleDateString('es-AR',{day:"numeric",month:"short"});
    const horaTxt = fecha.toLocaleTimeString('es-AR',{hour:"2-digit",minute:"2-digit"});

    const card = document.createElement("div");
    card.className = "card";

    // menÃº admin
    if(rol === "admin"){
      const menuBtn = document.createElement("div");
      menuBtn.className = "menu-btn";
      menuBtn.textContent = "â‹®";

      const menu = document.createElement("div");
      menu.className = "admin-menu";

      const btnEdit = document.createElement("button");
      btnEdit.textContent = "âœï¸ Editar";
      btnEdit.onclick = ()=> abrirEdicion(salida);

      const btnUndo = document.createElement("button");
      btnUndo.textContent = "â†©ï¸ Deshacer";
      btnUndo.onclick = ()=> deshacerSalida(salida.id);

      const btnDel = document.createElement("button");
      btnDel.textContent = "ðŸ—‘ Eliminar";
      btnDel.onclick = ()=> eliminarSalida(salida.id);

      menu.appendChild(btnEdit);
      menu.appendChild(btnUndo);
      menu.appendChild(btnDel);

      menuBtn.addEventListener("click", ()=>{
        menu.style.display = menu.style.display === "block" ? "none" : "block";
      });

      card.appendChild(menuBtn);
      card.appendChild(menu);
    }

    const titulo = document.createElement("div");
    titulo.className = "card-title";
    titulo.textContent = `${capitalizar(dia)} â€¢ ${fechaTxt} â€¢ ${horaTxt} hs`;

    const fila1 = fila("DirecciÃ³n", salida.direccion || "â€”");
    const fila2 = fila("Territorio", salida.territorio || "â€”");
    const fila3 = fila("Manzanas", salida.manzanas || "â€”");
    const fila4 = fila("Conductor", salida.conductor || "â€”");

    const obs = document.createElement("div");
    obs.className = "obs";
    obs.textContent = salida.observaciones || "â€”";

    card.appendChild(titulo);
    card.appendChild(fila1);
    card.appendChild(fila2);
    card.appendChild(fila3);
    card.appendChild(fila4);
    card.appendChild(obs);

    lista.appendChild(card);
  });
});

/* ============================
   FUNCIONES
============================ */

function fila(label, valor){
  const f = document.createElement("div");
  f.className = "fila";

  const l = document.createElement("div");
  l.className = "label";
  l.textContent = label;

  const v = document.createElement("div");
  v.textContent = valor;

  f.appendChild(l);
  f.appendChild(v);
  return f;
}

function capitalizar(str){
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function abrirEdicion(salida){
  salidaActualId = salida.id;

  document.getElementById("editTerritorio").value = salida.territorio || "";
  document.getElementById("editManzanas").value = salida.manzanas || "";
  document.getElementById("editConductor").value = salida.conductor || "";
  document.getElementById("editDireccion").value = salida.direccion || "";
  document.getElementById("editObs").value = salida.observaciones || "";

  const fecha = new Date(salida.fechaHora);

  document.getElementById("editFecha").value = fecha.toISOString().substring(0,10);
  document.getElementById("editHora").value = fecha.toTimeString().substring(0,5);

  modal.style.display = "flex";
}

document.getElementById("cancelarEdicion").onclick = ()=>{
  modal.style.display = "none";
};

document.getElementById("guardarEdicion").onclick = ()=>{
  const fecha = document.getElementById("editFecha").value;
  const hora = document.getElementById("editHora").value;

  const fechaHora = new Date(`${fecha}T${hora}:00`).toISOString();

  update(ref(db,"salidas_asignadas/" + salidaActualId),{
    territorio: document.getElementById("editTerritorio").value,
    manzanas: document.getElementById("editManzanas").value,
    conductor: document.getElementById("editConductor").value,
    direccion: document.getElementById("editDireccion").value,
    observaciones: document.getElementById("editObs").value,
    fechaHora
  });

  modal.style.display="none";
};

function deshacerSalida(id){
  if(!confirm("Â¿Seguro que desea DESHACER esta salida?")) return;

  // mover a pendientes
  push(pendientesRef, { origen:id });

  remove(ref(db, "salidas_asignadas/" + id));
}

function eliminarSalida(id){
  if(!confirm("Â¿Seguro que desea ELIMINAR esta salida?")) return;

  remove(ref(db, "salidas_asignadas/" + id));
}
</script>

</body>
</html>