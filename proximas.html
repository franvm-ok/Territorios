<script type="module">
import { db, ref as dbRef, onValue, update, remove, push } from "./firebase.js";

/* -------------------------
   ELEMENTOS
--------------------------*/
const lista = document.getElementById("lista");
const salidasRef = dbRef(db, "salidas_asignadas");
const pendientesRef = dbRef(db, "pendientes");

const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
let rol = (sesion.rol || "invitado").toLowerCase();
/* Invitado ve igual que conductor */
if (rol === "invitado") rol = "conductor";

/* -------------------------
   DATOS
--------------------------*/
let salidas = [];
let activeMenuId = null;
let editingId = null;

/* -------------------------
   MODAL ELEMENTS
--------------------------*/
const modal = document.getElementById("modal");
const e_territorio = document.getElementById("e_territorio");
const e_manzanas = document.getElementById("e_manzanas");
const e_conductor = document.getElementById("e_conductor");
const e_fecha = document.getElementById("e_fecha");
const e_hora = document.getElementById("e_hora");
const e_calle = document.getElementById("e_calle");
const e_inter = document.getElementById("e_inter");
const e_obs = document.getElementById("e_obs");
const saveEdit = document.getElementById("saveEdit");
const cancelEdit = document.getElementById("cancelEdit");

/* -------------------------
   UTILIDADES
--------------------------*/
function hoyISO(){
  const d = new Date();
  return d.toISOString().slice(0,10);
}
function horaNow(){
  const d = new Date();
  d.setSeconds(0); d.setMilliseconds(0);
  return d.toTimeString().slice(0,5);
}
function escapeHtml(s){
  if(!s) return "";
  return String(s).replaceAll("&","&amp;")
                  .replaceAll("<","&lt;")
                  .replaceAll(">","&gt;")
                  .replaceAll('"',"&quot;");
}
function unescapeHtml(s){
  if(!s) return s||"";
  return String(s).replaceAll("&amp;","&")
                  .replaceAll("&lt;","<")
                  .replaceAll("&gt;",">")
                  .replaceAll("&quot;",'"');
}

/* -------------------------
   RENDER
--------------------------*/
function render(){
  lista.innerHTML = "";

  if(!salidas || salidas.length === 0){
    lista.innerHTML = `<div class="empty">No hay salidas asignadas</div>`;
    return;
  }

  salidas.forEach(sal => {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.id = sal.id;

    card.innerHTML = `
      <div class="topline">
        <div>
          <div class="territorio">Territorio ${escapeHtml(sal.territorio)}</div>
          <div class="meta">${escapeHtml(sal.observaciones || "Sin observaciones")}</div>
        </div>

        <div style="display:flex;align-items:center;gap:8px">
          <div class="etiqueta">ASIGNADA</div>
          ${ rol === "admin" ? `<button class="more-btn" aria-label="M√°s opciones" data-id="${sal.id}">‚ãØ</button>` : '' }
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <div class="big">üë§ ${escapeHtml(sal.conductor || "‚Äî")}</div>
          <div class="small">Conductor</div>
        </div>

        <div style="flex:1">
          <div class="big">üìÖ ${escapeHtml(sal.fecha || "‚Äî")}</div>
          <div class="small">Fecha</div>
        </div>

        <div style="flex:1">
          <div class="big">‚è∞ ${escapeHtml(sal.hora || "‚Äî")}</div>
          <div class="small">Hora</div>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <div style="flex:1">
          <div class="direccion">üìç ${escapeHtml(sal.calle || "")} ${sal.interseccion ? "y " + escapeHtml(sal.interseccion) : ""}</div>
        </div>
        <div style="flex:1">
          <div class="small">Manzanas: <b>${escapeHtml((sal.pendientes||[]).join(", ") || "‚Äî")}</b></div>
        </div>
      </div>

      ${ rol === "admin" ? `
        <div class="menu" id="menu-${sal.id}">
          <button data-action="edit" data-id="${sal.id}">‚úé Editar</button>
          <button data-action="undo" data-id="${sal.id}">‚Æå Deshacer (volver a pendientes)</button>
          <button data-action="delete" data-id="${sal.id}" style="color:#b91c1c">üóëÔ∏è Eliminar</button>
        </div>
      ` : ''}
    `;

    lista.appendChild(card);
  });

  /* ADMIN: eventos */
  if(rol === "admin"){
    document.querySelectorAll(".more-btn").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        toggleMenu(btn.dataset.id);
      };
      btn.onblur = ()=> {
        setTimeout(()=>closeMenu(), 150);
      };
    });

    document.querySelectorAll(".menu button").forEach(mbtn=>{
      mbtn.onclick = ()=>{
        const id = mbtn.dataset.id;
        const action = mbtn.dataset.action;
        closeMenu();

        if(action === "edit") openEditModal(id);
        if(action === "undo") undoToPendientes(id);
        if(action === "delete") deleteSalida(id);
      };
    });
  }
}

/* -------------------------
   MEN√ö
--------------------------*/
function toggleMenu(id){
  closeMenu();
  const m = document.getElementById("menu-"+id);
  if(m){
    m.style.display = "flex";
    activeMenuId = id;
  }
}
function closeMenu(){
  if(activeMenuId){
    const m = document.getElementById("menu-"+activeMenuId);
    if(m) m.style.display = "none";
    activeMenuId = null;
  }
}

/* -------------------------
   EDITAR
--------------------------*/
async function openEditModal(id){
  const s = salidas.find(x=>x.id === id);
  if(!s) return;

  editingId = id;

  e_territorio.value = s.territorio || "";
  e_manzanas.value = (s.pendientes||[]).join(", ");
  e_conductor.value = s.conductor || "";
  e_fecha.value = s.fecha || hoyISO();
  e_hora.value = s.hora || horaNow();
  e_calle.value = s.calle || "";
  e_inter.value = s.interseccion || "";
  e_obs.value = s.observaciones || "";

  modal.style.display = "flex";
  e_territorio.focus();
}

cancelEdit.onclick = ()=> {
  modal.style.display = "none";
  editingId = null;
};

saveEdit.onclick = async ()=>{
  if(!editingId) return;

  const territorio = e_territorio.value.trim();
  const manzanas = e_manzanas.value.trim();
  const conductor = e_conductor.value.trim();
  const fecha = e_fecha.value;
  const hora = e_hora.value;
  const calle = e_calle.value.trim();
  const inter = e_inter.value.trim();
  const obs = e_obs.value.trim();

  if(!territorio || !fecha || !hora){
    alert("Territorio, fecha y hora son obligatorios.");
    return;
  }

  const manzArr = manzanas ? manzanas.split(",").map(x=>x.trim()).filter(x=>x) : [];

  await update(dbRef(db, "salidas_asignadas/" + editingId), {
    territorio,
    pendientes: manzArr,
    conductor,
    fecha,
    hora,
    calle,
    interseccion: inter,
    observaciones: obs
  });

  modal.style.display = "none";
  editingId = null;
};

/* -------------------------
   DESHACER ‚Üí vuelve a pendientes
--------------------------*/
async function undoToPendientes(id){
  const s = salidas.find(x=>x.id === id);
  if(!s) return;

  const nuevo = {
    territorio: s.territorio,
    pendientes: s.pendientes || [],
    calle: s.calle || "",
    interseccion: s.interseccion || "",
    observaciones: s.observaciones || ""
  };

  await push(pendientesRef, nuevo);
  await remove(dbRef(db, "salidas_asignadas/" + id));
}

/* -------------------------
   ELIMINAR
--------------------------*/
async function deleteSalida(id){
  if(confirm("¬øEliminar esta salida?")){
    await remove(dbRef(db, "salidas_asignadas/" + id));
  }
}

/* -------------------------
   CARGAR EN TIEMPO REAL
--------------------------*/
onValue(salidasRef, snap=>{
  const data = snap.val() || {};
  salidas = Object.keys(data).map(id=>({id, ...data[id]}));

  /* ordenar por fecha y hora */
  salidas.sort((a,b)=>{
    const fa = (a.fecha || "") + " " + (a.hora || "");
    const fb = (b.fecha || "") + " " + (b.hora || "");
    return fa.localeCompare(fb);
  });

  render();
});
</script>