<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pr√≥ximas Salidas</title>

<style>
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#f2f2f2;
    color:#333;
  }

  header{
    background:#1a4b27;
    color:#fff;
    padding:16px;
    text-align:center;
    font-weight:700;
    font-size:20px;
  }

  .container{
    padding:14px;
    max-width:720px;
    margin:auto;
  }

  /* TARJETA COMPACTA */
  .card{
    background:#fff;
    border-radius:14px;
    padding:16px;
    margin-bottom:14px;
    box-shadow:0 3px 12px rgba(0,0,0,0.10);
    position:relative;
  }

  .card-header{
    font-size:18px;
    font-weight:bold;
    margin-bottom:10px;
    color:#1a4b27;
  }

  .row{
    display:flex;
    justify-content:space-between;
    margin-bottom:8px;
  }

  .label{
    font-weight:bold;
    color:#1a4b27;
  }

  .value{
    color:#444;
    font-size:15px;
  }

  .obs{
    margin-top:10px;
    font-size:14px;
    color:#555;
    border-top:1px solid #ddd;
    padding-top:8px;
    line-height:1.4;
  }

  /* BOTONES ADMIN */
  .admin-buttons{
    display:flex;
    gap:8px;
    margin-top:12px;
  }

  .btn{
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
    border:none;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .editar{background:#1a4b27; color:#fff;}
  .deshacer{background:#d39e00; color:#fff;}
  .eliminar{background:#c62828; color:#fff;}

</style>
</head>
<body>

<header>Pr√≥ximas Salidas</header>

<div class="container" id="lista"></div>

<script type="module">
/* IMPORTAR FIREBASE */
import { db, ref as dbRef, onValue, update, remove, push } from "./firebase.js";

/* DETECTAR ROL */
const rol = localStorage.getItem("rol");

/* LISTA */
const lista = document.getElementById("lista");
const salidasRef = dbRef(db, "salidas_asignadas");

/* FORMATEAR FECHAS */
function formatearFecha(fechaStr){
  const fecha = new Date(fechaStr);
  const dias = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];
  const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  return `${dias[fecha.getDay()]} - ${fecha.getDate()} ${meses[fecha.getMonth()]} - ${fecha.getHours().toString().padStart(2,'0')}:${fecha.getMinutes().toString().padStart(2,'0')} hs`;
}

/* CARGAR SALIDAS */
onValue(salidasRef, snapshot => {
  lista.innerHTML = "";

  const data = snapshot.val();
  if(!data) return;

  /* Convertir a array y ordenar */
  const arr = Object.entries(data).map(([id, salida]) => ({id, ...salida}));

  arr.sort((a,b)=> new Date(a.fecha) - new Date(b.fecha));

  arr.forEach(item => {
    if(!item.fecha) return;

    /* Eliminar autom√°ticos si pasaron 24h */
    const fechaSalida = new Date(item.fecha);
    const ahora = new Date();
    const diff = ahora - fechaSalida;

    if(diff > 24 * 60 * 60 * 1000){
      remove(dbRef(db,"salidas_asignadas/"+item.id));
      return;
    }

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="card-header">üìÖ ${formatearFecha(item.fecha)}</div>

      <div class="row">
        <div class="label">üìç Direcci√≥n:</div>
        <div class="value">${item.direccion || "-"}</div>
      </div>

      <div class="row">
        <div class="label">üó∫Ô∏è Territorio:</div>
        <div class="value">${item.territorio || "-"}</div>
      </div>

      <div class="row">
        <div class="label">üî≤ Manzanas:</div>
        <div class="value">${item.manzanas || "-"}</div>
      </div>

      <div class="row">
        <div class="label">üöó Conductor:</div>
        <div class="value">${item.conductor || "-"}</div>
      </div>

      <div class="obs">üìù ${item.observaciones || "Sin observaciones"}</div>
    `;

    /* Botones ADMIN */
    if(rol === "admin"){
      const btns = document.createElement("div");
      btns.className = "admin-buttons";

      const btnEditar = document.createElement("button");
      btnEditar.className = "btn editar";
      btnEditar.innerHTML = "‚úèÔ∏è Editar";
      btnEditar.onclick = ()=> alert("Funci√≥n editar lista para conectar al formulario.");

      const btnDeshacer = document.createElement("button");
      btnDeshacer.className = "btn deshacer";
      btnDeshacer.innerHTML = "‚Ü©Ô∏è Deshacer";
      btnDeshacer.onclick = ()=>{
        if(confirm("¬øDesea DESHACER esta salida?")){
          const pendRef = dbRef(db,"pendientes");
          push(pendRef,{
            territorio:item.territorio,
            manzanas:item.manzanas,
            conductor:item.conductor,
            fecha:item.fecha,
            direccion:item.direccion,
            observaciones:item.observaciones
          });
          remove(dbRef(db,"salidas_asignadas/"+item.id));
        }
      };

      const btnEliminar = document.createElement("button");
      btnEliminar.className = "btn eliminar";
      btnEliminar.innerHTML = "üóëÔ∏è Eliminar";
      btnEliminar.onclick = ()=>{
        if(confirm("¬øDesea ELIMINAR esta salida permanentemente?")){
          remove(dbRef(db,"salidas_asignadas/"+item.id));
        }
      };

      btns.appendChild(btnEditar);
      btns.appendChild(btnDeshacer);
      btns.appendChild(btnEliminar);
      card.appendChild(btns);
    }

    lista.appendChild(card);
  });
});
</script>

</body>
</html>