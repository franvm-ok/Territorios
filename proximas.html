<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PrÃ³ximas salidas</title>

<!-- ======== ESTILOS MEJORADOS Y COMPACTOS ======== -->
<style>
  body{
    margin:0;
    font-family:Arial;
    background:#f4f4f4;
    color:#333;
  }

  header{
    background:#1a4b27;
    color:#fff;
    padding:18px;
    text-align:center;
    font-size:22px;
    font-weight:bold;
  }

  .container{
    padding:16px;
    max-width:720px;
    margin:auto;
  }

  /* TARJETA COMPACTA */
  .card{
    background:white;
    padding:14px 16px;
    margin-bottom:14px;
    border-radius:14px;
    box-shadow:0 3px 8px rgba(0,0,0,0.12);
    border-left:6px solid #1a4b27;
  }

  /* Fecha grande */
  .fecha{
    font-size:18px;
    font-weight:bold;
    color:#1a4b27;
    margin-bottom:6px;
  }

  .campo{
    font-size:15px;
    margin:3px 0;
  }

  .campo b{
    color:#1a4b27;
  }

  /* Botones admin */
  .btns{
    display:flex;
    gap:8px;
    margin-top:10px;
  }

  button{
    flex:1;
    padding:10px;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
  }

  .edit{background:#ffd966;}
  .undo{background:#b6d7a8;}
  .delete{background:#ea9999;}

  /* DIALOGO (HOJA) */
  #editSheet{
    position:fixed;
    left:0; right:0; bottom:0;
    background:white;
    padding:18px;
    border-radius:18px 18px 0 0;
    box-shadow:0 -4px 14px rgba(0,0,0,0.2);
    display:none;
  }

  #editSheet h2{
    margin-top:0;
    text-align:center;
    color:#1a4b27;
  }

  .input-group{
    margin-bottom:10px;
  }

  input, textarea, select{
    width:100%;
    padding:10px;
    box-sizing:border-box;
    border-radius:8px;
    border:1px solid #ccc;
  }

  .save-btn{
    background:#1a4b27;
    color:white;
    width:100%;
    margin-top:10px;
  }

  .cancel-btn{
    background:#ccc;
    width:100%;
    margin-top:10px;
  }
</style>
</head>
<body>

<header>PrÃ³ximas salidas</header>

<div class="container" id="lista"></div>

<!-- ============= HOJA DE EDICIÃ“N ============= -->
<div id="editSheet">
  <h2>Editar salida</h2>

  <div class="input-group">
    <label>Territorio</label>
    <input id="editTerritorio"/>
  </div>

  <div class="input-group">
    <label>Manzana</label>
    <input id="editManzana"/>
  </div>

  <div class="input-group">
    <label>Conductor</label>
    <input id="editConductor"/>
  </div>

  <div class="input-group">
    <label>Fecha</label>
    <input type="date" id="editFecha"/>
  </div>

  <div class="input-group">
    <label>Hora</label>
    <input type="time" id="editHora"/>
  </div>

  <div class="input-group">
    <label>Calle / IntersecciÃ³n</label>
    <input id="editDireccion"/>
  </div>

  <div class="input-group">
    <label>Observaciones</label>
    <textarea id="editObs"></textarea>
  </div>

  <button class="save-btn" id="btnGuardar">Guardar</button>
  <button class="cancel-btn" id="btnCancelar">Cancelar</button>
</div>

<!-- ============= FIREBASE Y SCRIPT ============= -->
<script type="module">
import { db, ref as dbRef, onValue, update, remove, push } from "./firebase.js";

const lista = document.getElementById("lista");
const editSheet = document.getElementById("editSheet");
let editId = null;

const sesion = JSON.parse(localStorage.getItem("sesion"));
const rol = sesion ? sesion.rol : "invitado";

const salidasRef = dbRef(db, "salidas_asignadas");
const pendientesRef = dbRef(db, "pendientes");

/* ============================
   ABRIR HOJA DE EDICIÃ“N
============================ */
function abrirEdicion(id, data){
  editId = id;
  editTerritorio.value = data.territorio || "";
  editManzana.value = data.manzana || "";
  editConductor.value = data.conductor || "";
  editFecha.value = data.fecha || "";
  editHora.value = data.hora || "";
  editDireccion.value = data.direccion || "";
  editObs.value = data.observaciones || "";
  editSheet.style.display = "block";
}

/* ============================
   GUARDAR EDICIÃ“N
============================ */
btnGuardar.onclick = async ()=>{
  if(!editId) return;

  await update(dbRef(db, "salidas_asignadas/" + editId),{
    territorio: editTerritorio.value.trim(),
    manzana: editManzana.value.trim(),
    conductor: editConductor.value.trim(),
    fecha: editFecha.value,
    hora: editHora.value,
    direccion: editDireccion.value.trim(),
    observaciones: editObs.value.trim()
  });

  editSheet.style.display="none";
};

/* ============================
   CANCELAR
============================ */
btnCancelar.onclick = ()=> editSheet.style.display="none";

/* ============================
   CONFIRMACIONES
============================ */
function confirmar(msg){
  return window.confirm(msg);
}

/* ============================
   LISTAR TARJETAS
============================ */
onValue(salidasRef, snapshot => {
  lista.innerHTML = "";
  const data = snapshot.val() || {};

  const items = Object.entries(data)
    .map(([id, s]) => ({id, ...s}))
    .sort((a,b)=>{
      const da = new Date(a.fecha+" "+a.hora);
      const db = new Date(b.fecha+" "+b.hora);
      return da - db;
    });

  const ahora = Date.now();

  items.forEach(s => {
    const fechaCompleta = new Date(s.fecha+" "+s.hora);
    const dif = ahora - fechaCompleta.getTime();

    if(dif > 86400000){ 
      remove(dbRef(db, "salidas_asignadas/"+s.id));
      return;
    }

    const dias = ["Dom","Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b"];
    const dia = dias[fechaCompleta.getDay()];
    const opciones = { month:"short", day:"numeric" };
    const fechaFmt = fechaCompleta.toLocaleDateString("es-AR", opciones);

    const horaFmt = s.hora ? s.hora.substring(0,5) : "";

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="fecha">ðŸ“… ${dia} - ${fechaFmt} - ${horaFmt} hs</div>
      <div class="campo"><b>DirecciÃ³n:</b> ${s.direccion || ""}</div>
      <div class="campo"><b>Territorio:</b> ${s.territorio || ""} | <b>Manzanas:</b> ${s.manzana || ""}</div>
      <div class="campo"><b>Conductor:</b> ${s.conductor || ""}</div>
      <div class="campo"><b>Obs.:</b> ${s.observaciones || ""}</div>
    `;

    if(rol === "admin"){
      const btns = document.createElement("div");
      btns.className = "btns";

      const b1 = document.createElement("button");
      b1.className="edit";
      b1.textContent="âœï¸ Editar";
      b1.onclick=()=>abrirEdicion(s.id, s);

      const b2 = document.createElement("button");
      b2.className="undo";
      b2.textContent="â†© Deshacer";
      b2.onclick=async()=>{
        if(!confirmar("Â¿Desea deshacer la salida?")) return;
        await push(pendientesRef, s);
        await remove(dbRef(db, "salidas_asignadas/"+s.id));
      };

      const b3 = document.createElement("button");
      b3.className="delete";
      b3.textContent="ðŸ—‘ Eliminar";
      b3.onclick=async()=>{
        if(!confirmar("Â¿Eliminar permanentemente?")) return;
        await remove(dbRef(db, "salidas_asignadas/"+s.id));
      };

      btns.appendChild(b1);
      btns.appendChild(b2);
      btns.appendChild(b3);

      card.appendChild(btns);
    }

    lista.appendChild(card);
  });

});
</script>

</body>
</html>