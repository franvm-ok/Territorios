<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pr√≥ximas salidas</title>

<style>
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, Arial;
        background: #f2f2f7;
        color: #333;
    }

    header {
        background: #1a4b27;
        color: white;
        padding: 18px;
        text-align: center;
        font-size: 22px;
        font-weight: 600;
    }

    .container {
        padding: 16px;
        max-width: 700px;
        margin: auto;
    }

    /* Tarjeta */
    .card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 18px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .fecha-principal {
        font-size: 20px;
        font-weight: 700;
        color: #1a4b27;
        margin-bottom: 10px;
    }

    .info {
        font-size: 17px;
        line-height: 1.4;
        margin-bottom: 12px;
    }

    .label {
        font-weight: 600;
        color: #444;
    }

    /* Botones de acci√≥n */
    .actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        flex: 1;
        justify-content: center;
    }

    .btn svg {
        width: 18px;
        height: 18px;
    }

    .editar { background: #e8f0fe; color:#1a3d8f; }
    .deshacer { background: #fff4d8; color:#8a5a00; }
    .eliminar { background: #fde4e4; color:#a10000; }

    /* Modal */
    .modal-bg {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.40);
        display: none;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .modal {
        background: white;
        width: 100%;
        max-width: 480px;
        border-radius: 16px;
        padding: 20px;
        animation: fadeIn .2s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .modal h2 {
        font-size: 20px;
        margin-bottom: 14px;
        font-weight: 700;
        color: #1a4b27;
    }

    .group {
        margin-bottom: 12px;
    }

    label {
        font-weight: 600;
        display: block;
        margin-bottom: 5px;
    }

    input, textarea {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border-radius: 10px;
        border: 1px solid #ccc;
        outline: none;
    }

    textarea {
        resize: none;
        height: 70px;
    }

    .fila {
        display: flex;
        gap: 10px;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 16px;
    }

    .btn-cancel {
        flex: 1;
        padding: 12px;
        background: #ccc;
        color: #333;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
    }

    .btn-save {
        flex: 1;
        padding: 12px;
        background: #1a4b27;
        color: white;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
    }

</style>
</head>

<body>

<header>Pr√≥ximas salidas</header>

<div class="container" id="lista">

    <!-- Tarjetas generadas din√°micamente desde JS / Firebase -->

</div>

<!-- Modal edici√≥n -->
<div class="modal-bg" id="modalEditar">
    <div class="modal">
        <h2>Editar salida</h2>

        <div class="group">
            <label>Territorio</label>
            <input id="editTerritorio">
        </div>

        <div class="group">
            <label>Manzana</label>
            <input id="editManzana">
        </div>

        <div class="group">
            <label>Conductor</label>
            <input id="editConductor">
        </div>

        <div class="fila">
            <div class="group" style="flex:1">
                <label>Fecha</label>
                <input type="date" id="editFecha">
            </div>
            <div class="group" style="flex:1">
                <label>Hora</label>
                <input type="time" id="editHora">
            </div>
        </div>

        <div class="group">
            <label>Calle / intersecci√≥n</label>
            <input id="editDireccion">
        </div>

        <div class="group">
            <label>Observaciones</label>
            <textarea id="editObs"></textarea>
        </div>

        <div class="modal-buttons">
            <div class="btn-cancel" onclick="cerrarModal()">Cancelar</div>
            <div class="btn-save" onclick="guardarCambios()">Guardar</div>
        </div>
    </div>
</div>

<script type="module">
/* ============================
   IMPORTS FIREBASE
============================ */
import { db, ref as dbRef, onValue, update, remove, push } from "./firebase.js";

const lista = document.getElementById("lista");
const salidasRef = dbRef(db, "salidas_asignadas");
const pendientesRef = dbRef(db, "pendientes");

/* ID temporal para edici√≥n */
let editId = null;

/* ============================
   CARGAR TARJETAS
============================ */
onValue(salidasRef, (snapshot) => {
    lista.innerHTML = "";

    snapshot.forEach((child) => {
        const data = child.val();
        const id = child.key;

        const card = document.createElement("div");
        card.className = "card";

        const fecha = data.fecha || "";
        const hora = data.hora || "";
        const dia = new Date(fecha + " " + hora).toLocaleDateString("es-AR", { weekday:"long" });

        card.innerHTML = `
            <div class="fecha-principal">${dia.toUpperCase()} - ${fecha} ${hora}</div>

            <div class="info"><span class="label">Direcci√≥n:</span> ${data.direccion || ""}</div>
            <div class="info"><span class="label">Territorio:</span> ${data.territorio || ""}</div>
            <div class="info"><span class="label">Manzana:</span> ${data.manzana || ""}</div>
            <div class="info"><span class="label">Conductor:</span> ${data.conductor || ""}</div>
            <div class="info"><span class="label">Observaciones:</span> ${data.observaciones || ""}</div>

            <div class="actions">
                <button class="btn editar" onclick="editar('${id}')">
                    ‚úèÔ∏è Editar
                </button>

                <button class="btn deshacer" onclick="deshacer('${id}')">
                    ‚Ü©Ô∏è Deshacer
                </button>

                <button class="btn eliminar" onclick="eliminarSalida('${id}')">
                    üóëÔ∏è Eliminar
                </button>
            </div>
        `;

        lista.appendChild(card);
    });
});

/* ============================
   EDITAR
============================ */
window.editar = (id) => {
    editId = id;
    const ref = dbRef(db, "salidas_asignadas/" + id);

    onValue(ref, (snap) => {
        const d = snap.val();
        document.getElementById("editTerritorio").value = d.territorio || "";
        document.getElementById("editManzana").value = d.manzana || "";
        document.getElementById("editConductor").value = d.conductor || "";
        document.getElementById("editFecha").value = d.fecha || "";
        document.getElementById("editHora").value = d.hora || "";
        document.getElementById("editDireccion").value = d.direccion || "";
        document.getElementById("editObs").value = d.observaciones || "";
    }, { onlyOnce:true });

    document.getElementById("modalEditar").style.display = "flex";
};

window.cerrarModal = () => {
    document.getElementById("modalEditar").style.display = "none";
    editId = null;
};

window.guardarCambios = () => {
    if (!editId) return;

    update(dbRef(db, "salidas_asignadas/" + editId), {
        territorio: document.getElementById("editTerritorio").value,
        manzana: document.getElementById("editManzana").value,
        conductor: document.getElementById("editConductor").value,
        fecha: document.getElementById("editFecha").value,
        hora: document.getElementById("editHora").value,
        direccion: document.getElementById("editDireccion").value,
        observaciones: document.getElementById("editObs").value,
    });

    cerrarModal();
};

/* ============================
   DESHACER ‚Üí vuelve a pendientes
============================ */
window.deshacer = (id) => {
    const ref = dbRef(db, "salidas_asignadas/" + id);

    onValue(ref, (snap) => {
        const data = snap.val();
        push(pendientesRef, data);
        remove(ref);
    }, { onlyOnce:true });
};

/* ============================
   ELIMINAR
============================ */
window.eliminarSalida = (id) => {
    remove(dbRef(db, "salidas_asignadas/" + id));
};
</script>

</body>
</html>