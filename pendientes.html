<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pendientes - Admin</title>

<style>
:root{--verde:#1a4b27;--bg:#f4f4f4}
body{margin:0;font-family:Arial;background:var(--bg)}
header{background:var(--verde);color:#fff;text-align:center;font-weight:bold;padding:18px}
.container{max-width:900px;margin:auto;padding:15px}
.card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);margin-bottom:10px}
.pendiente{border-left:6px solid orange}
.pend{color:#c1121f;font-weight:bold}
.etiqueta{background:#ffe095;padding:3px 6px;border-radius:6px;font-size:12px;margin-right:6px}
.admin input,.admin textarea{width:100%;margin-bottom:6px;padding:6px;border-radius:6px;border:1px solid #ccc}
button{background:var(--verde);color:white;border:none;padding:6px 10px;border-radius:8px;font-weight:bold;cursor:pointer}
.back{position:fixed;left:15px;bottom:15px}
</style>
</head>

<body>
<header>ðŸŸ  Pendientes</header>
<div class="container" id="lista"></div>
<button class="back" onclick="location.href='index.html'">â¬… Volver</button>

<script type="module">
import { db, ref, onValue, push, remove } from "./firebase.js";

const lista = document.getElementById("lista");
const reportesRef = ref(db,"reportes");
const salidasRef  = ref(db,"salidas_asignadas");
const rol = (localStorage.getItem("rol")||"invitado").toLowerCase().trim();
const esAdmin = rol==="admin";
let pendientes=[];

/* PINTAR */
function render(){
  lista.innerHTML="";
  pendientes.forEach(r=>{
    if(!r.pendientes || r.pendientes.length===0) return; // solo pendientes reales
    const card=document.createElement("div");
    card.className="card pendiente";
    card.innerHTML=`
      <span class="etiqueta">PENDIENTE</span>
      <b>Territorio ${r.territorio||"-"}</b>
      <div>ðŸ§± Faltan: <span class="pend">${r.pendientes.join(", ")}</span></div>
      <div>ðŸ‘¤ Ãšltimo: ${r.conductor||"-"}</div>
    `;
    const box=document.createElement("div");
    box.className="admin";
    box.innerHTML=`
      <input id="c${r.id}" placeholder="Conductor">
      <input type="date" id="f${r.id}">
      <input id="calles${r.id}" placeholder="Calle">
      <input id="inter${r.id}" placeholder="IntersecciÃ³n">
      <button onclick="asignar('${r.id}')">âœ… Asignar</button>
    `;
    card.appendChild(box);
    lista.appendChild(card);
  });
}

/* ASIGNAR */
window.asignar=async(id)=>{
  const r = pendientes.find(x=>x.id===id);
  const c = document.getElementById("c"+id).value.trim();
  const f = document.getElementById("f"+id).value;
  const calle = document.getElementById("calles"+id).value.trim();
  const inter = document.getElementById("inter"+id).value.trim();
  if(!c||!f||!calle||!inter){ alert("Falta completar"); return; }

  await push(salidasRef,{
    territorio: r.territorio,
    pendientes: r.pendientes,
    conductor: c,
    fecha: f,
    calle: calle,
    interseccion: inter,
    creado: Date.now()
  });

  await remove(ref(db,"reportes/"+id));
  alert("âœ… Salida asignada");
};

/* FIREBASE */
onValue(reportesRef,snap=>{
  pendientes=[];
  snap.forEach(x=>{ const o=x.val(); o.id=x.key; pendientes.push(o); });
  render();
});
</script>
</body>
</html>